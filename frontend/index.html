<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourenplanung</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Modulare CSS-Dateien -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/calendar.css">
    <link rel="stylesheet" href="/css/responsive.css">
    
    <style>
        /* ================================================
           DEVIN-STYLE DESIGN SYSTEM
           Modern, Dark, Professional
           ================================================ */
        :root {
            /* Primary Colors - Cyan/Türkis Akzent */
            --primary: #06b6d4;
            --primary-hover: #0891b2;
            --primary-light: rgba(6, 182, 212, 0.15);
            --primary-glow: 0 0 20px rgba(6, 182, 212, 0.4);
            
            /* Secondary */
            --secondary: #8b5cf6;
            --secondary-hover: #7c3aed;
            
            /* Backgrounds - Dark Theme als Default */
            --bg-body: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --bg-hover: #252532;
            --glass-bg: rgba(18, 18, 26, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            /* Text */
            --text-main: #f0f0f5;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b80;
            --text-light: #4a4a5a;
            
            /* Borders */
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.05);
            --border-focus: var(--primary);
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 30px rgba(6, 182, 212, 0.2);
            
            /* Status Colors */
            --c-care: #3b82f6;
            --c-house: #10b981;
            --c-social: #f59e0b;
            --c-other: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%);
            --gradient-card: linear-gradient(145deg, #12121a 0%, #0a0a0f 100%);
            --gradient-shine: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --primary: #0891b2;
            --primary-hover: #0e7490;
            --primary-light: rgba(8, 145, 178, 0.1);
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-elevated: #f1f5f9;
            --bg-hover: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(0, 0, 0, 0.08);
            --text-main: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --border: rgba(0, 0, 0, 0.1);
            --border-light: rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        /* Event Row Styles */
        .week-event-row {
            background: var(--gradient-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            transition: all var(--transition-fast);
        }

        .week-event-row:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md), 0 0 0 1px var(--primary);
        }

        .week-event-row .event-title {
            color: var(--text-main);
            font-weight: 600;
        }

        .week-event-row .event-time {
            color: var(--text-secondary);
        }

        .week-event-row .event-type-badge {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            padding: 2px 8px;
            font-size: 0.65rem;
        }

        .week-event-row .event-type-badge.care {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.4);
        }

        .week-event-row .event-type-badge.house {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border-color: rgba(16, 185, 129, 0.4);
        }

        .week-event-row .event-type-badge.social {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, 0.4);
        }

        /* Week Day Card */
        .week-day-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
        }

        .week-day-card .day-header {
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        /* Light theme adjustments */
        [data-theme="light"] .week-event-row {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }

        [data-theme="light"] .week-day-card {
            box-shadow: var(--shadow-sm);
        }

        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 0; 
            background: var(--bg-body);
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Custom Scrollbar - Modern Style */
        ::-webkit-scrollbar { 
            width: 6px; 
            height: 6px; 
        }
        ::-webkit-scrollbar-track { 
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--text-light);
            border-radius: var(--radius-full);
            transition: background var(--transition-fast);
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: var(--primary);
        }
        
        /* Selection */
        ::selection {
            background: var(--primary);
            color: white;
        }

        /* SIDEBAR - Modern Glass Design */
        .sidebar {
            width: 320px; 
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid var(--glass-border); 
            display: flex; 
            flex-direction: column;
            padding: 20px; 
            z-index: 20; 
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: visible;
        }
        
        .sidebar-content {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
        }

        .sidebar.collapsed {
            width: 60px;
            padding: 20px 8px;
        }

        .sidebar.collapsed .sidebar-content {
            display: none;
        }

        .sidebar-toggle-btn {
            position: absolute;
            top: 20px;
            right: -14px;
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 21;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-fast);
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .sidebar-toggle-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
            box-shadow: var(--primary-glow);
        }

        .sidebar.collapsed .sidebar-toggle-btn {
            right: -14px;
        }

        .sidebar-toggle-btn::before {
            content: '◀';
            transition: transform var(--transition-normal);
        }

        .sidebar.collapsed .sidebar-toggle-btn::before {
            content: '▶';
        }

        @media (max-width: 768px) {
            .sidebar-toggle-btn {
                display: none;
            }
            .sidebar {
                width: 280px;
            }
        }

        /* Toolbar Groups */
        .toolbar-group {
            position: relative;
            display: inline-block;
        }

        .toolbar-group-btn {
            position: relative;
        }

        .toolbar-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            padding: 4px;
        }

        .toolbar-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .toolbar-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-main);
            font-weight: 500;
            text-align: left;
            transition: all 0.15s ease;
        }

        .toolbar-dropdown-item:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .toolbar-dropdown-item span {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }
        
        h2.brand { 
            margin: 0 0 32px 0; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 1.5rem;
            letter-spacing: -0.02em;
        }
        
        .section-title { 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: var(--primary); 
            font-weight: 700; 
            margin: 20px 0 12px 0;
            padding-left: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }
        
        /* INPUTS & SELECTS - Modern Dark Style */
        select, input[type="text"], input[type="number"], input:not([type="checkbox"]):not([type="hidden"]) {
            width: 100%; 
            height: 42px;
            padding: 0 14px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius-md); 
            font-size: 0.9rem; 
            background: var(--bg-elevated); 
            margin-bottom: 10px; 
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            transition: all var(--transition-fast);
            box-sizing: border-box;
        }
        
        select:hover, input[type="text"]:hover, input[type="number"]:hover, input:not([type="checkbox"]):not([type="hidden"]):hover {
            border-color: var(--text-muted);
            background: var(--bg-hover);
        }
        
        select:focus, input[type="text"]:focus, input[type="number"]:focus, input:not([type="checkbox"]):not([type="hidden"]):focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px var(--primary-light), var(--primary-glow);
            outline: none;
            background: var(--bg-elevated);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2306b6d4' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }
        
        /* Light theme inputs */
        [data-theme="light"] select,
        [data-theme="light"] input[type="text"],
        [data-theme="light"] input[type="number"],
        [data-theme="light"] input:not([type="checkbox"]):not([type="hidden"]) {
            background: white;
        }
        
        [data-theme="light"] select:hover,
        [data-theme="light"] input:hover {
            background: #f8fafc;
        }

        /* Compact inputs for inline use */
        .input-compact, .select-compact {
            height: 36px !important;
            padding: 0 12px !important;
            padding-right: 28px !important;
            font-size: 0.8rem !important;
            margin-bottom: 0 !important;
            border-radius: var(--radius-md) !important;
        }

        /* BUTTONS - Modern Gradient Style */
        .btn {
            padding: 10px 18px; 
            border-radius: var(--radius-md); 
            font-size: 0.85rem; 
            font-weight: 600; 
            cursor: pointer; 
            border: 1px solid transparent; 
            width: 100%; 
            margin-bottom: 6px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.01em;
            backdrop-filter: blur(4px);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-shine);
            transition: left 0.5s ease;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .btn-primary { 
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm), 0 0 20px rgba(6, 182, 212, 0.2);
            border: none;
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md), var(--primary-glow);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-secondary { 
            background: var(--bg-elevated); 
            border: 1px solid var(--border); 
            color: var(--text-main);
        }
        
        .btn-secondary:hover { 
            background: var(--bg-hover); 
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md), 0 0 20px rgba(239, 68, 68, 0.3);
        }
        
        .btn-sm {
            height: 34px !important;
            padding: 0 12px !important;
            font-size: 0.75rem !important;
            min-width: auto !important;
            border-radius: var(--radius-sm) !important;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            min-width: auto;
        }
        
        .menu-section {
            margin: 0;
        }
        
        .menu-header {
            transition: background 0.15s;
            margin: 0 -12px;
            padding: 8px 12px !important;
            border-radius: var(--radius-sm);
        }
        
        .menu-header:hover {
            background: var(--border-light);
        }
        
        .menu-toggle {
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        
        .menu-content {
            padding-bottom: 4px;
        }
        
        .settings-card {
            background: var(--border-light);
            border-radius: var(--radius-md);
            padding: 10px;
            margin-top: 8px;
            border: 1px solid var(--border);
        }
        
        .settings-card .status-line {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 4px 0;
        }
        
        .settings-card .status-line strong {
            color: var(--text-main);
        }
        
        .admin-tab-btn {
            transition: all 0.2s ease;
        }
        
        .admin-tab-btn.active {
            color: rgba(255, 255, 255, 1) !important;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%) !important;
            border-bottom-color: var(--primary) !important;
        }
        
        .admin-tab-btn:hover {
            color: var(--primary);
            background: var(--border-light);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
            color: var(--danger);
            border: 1.5px solid #fecaca;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .icon-btn { 
            width: auto; 
            padding: 8px 12px;
            min-width: 36px;
        }

        /* POOL */
        #external-events { 
            background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 100%); 
            border: 2px dashed var(--border); 
            border-radius: var(--radius-lg); 
            padding: 12px; 
            min-height: 140px; 
            overflow-y: auto; 
            flex-grow: 1;
            transition: all 0.3s ease;
        }
        
        #external-events.drag-over {
            background: var(--primary-light);
            border: 2px dashed var(--primary);
        }
        
        #external-events:empty::before {
            content: 'Ziehen Sie Kunden hierher oder klicken Sie auf "+ Neu"';
            display: block;
            text-align: center;
            color: var(--text-light);
            font-size: 0.8rem;
            padding: 20px;
            font-style: italic;
        }
        
        .pool-item {
            background: var(--bg-elevated); 
            border-radius: var(--radius-md); 
            padding: 10px 12px; 
            margin-bottom: 6px; 
            cursor: grab;
            border: 1px solid var(--border);
            border-left: 3px solid var(--primary);
            font-size: 0.85rem; 
            position: relative; 
            z-index: 100;
            transition: all var(--transition-fast);
        }
        
        .pool-item:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: var(--shadow-md), 0 0 15px rgba(6, 182, 212, 0.1);
        }
        
        .pool-item:active {
            cursor: grabbing;
            transform: scale(1.02);
        }
        
        /* Adaptive Größen basierend auf Anzahl */
        .pool-item.size-normal {
            padding: 10px 12px;
        }
        .pool-item.size-normal .pool-title { font-size: 0.9rem; }
        .pool-item.size-normal .pool-zone { font-size: 0.75rem; }
        
        .pool-item.size-compact {
            padding: 8px 10px;
            margin-bottom: 4px;
        }
        .pool-item.size-compact .pool-title { font-size: 0.8rem; }
        .pool-item.size-compact .pool-zone { font-size: 0.7rem; }
        .pool-item.size-compact .favorite-star { font-size: 0.85rem !important; }
        .pool-item.size-compact .dot { width: 6px; height: 6px; }
        
        .pool-item.size-mini {
            padding: 6px 8px;
            margin-bottom: 3px;
        }
        .pool-item.size-mini .pool-title { font-size: 0.75rem; }
        .pool-item.size-mini .pool-zone { display: none; }
        .pool-item.size-mini .favorite-star { font-size: 0.75rem !important; }
        .pool-item.size-mini .dot { width: 5px; height: 5px; }
        
        .pool-item:hover { 
            transform: translateX(3px); 
            box-shadow: var(--shadow-md);
            border-left-color: var(--primary-hover);
            background: linear-gradient(90deg, var(--primary-light) 0%, var(--bg-card) 5%);
        }
        
        .pool-item:active { 
            cursor: grabbing; 
            background: var(--primary-light);
            transform: scale(0.98);
        }
        
        .pool-delete-btn {
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .pool-delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .pool-delete-btn:active {
            transform: scale(0.95);
        }
        
        #external-events {
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }
        
        #external-events::-webkit-scrollbar {
            width: 6px;
        }
        
        #external-events::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #external-events::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        #external-events::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        /* MAIN */
        .main-content { 
            flex-grow: 1; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            gap: 16px;
        }
        
        /* TOP BAR - Modern Glass Style */
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 14px 20px; 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-fast);
            flex-wrap: wrap;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 16px;
        }
        
        .top-bar:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--border);
        }
        
        .view-switcher { 
            display: flex; 
            background: var(--bg-elevated); 
            padding: 4px; 
            border-radius: var(--radius-md);
            gap: 4px;
            border: 1px solid var(--border);
        }
        
        .view-btn { 
            padding: 8px 16px; 
            border-radius: var(--radius-sm); 
            font-size: 0.8rem; 
            cursor: pointer; 
            border: none; 
            background: transparent; 
            color: var(--text-muted); 
            font-weight: 600;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .view-btn:hover {
            color: var(--primary);
            background: var(--bg-hover);
        }
        
        .view-btn.active { 
            background: var(--gradient-primary);
            color: white; 
            box-shadow: var(--shadow-sm), 0 0 15px rgba(6, 182, 212, 0.3);
        }

        /* Navigation Dropdown - Modern */
        .nav-group {
            position: relative;
            display: inline-block;
        }

        .nav-group-btn {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-group-btn:hover {
            color: var(--primary);
            background: var(--bg-hover);
        }

        .nav-group-btn.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        .nav-group-btn::after {
            content: '▼';
            font-size: 0.55rem;
            transition: transform var(--transition-fast);
            opacity: 0.7;
        }

        .nav-group-btn.open::after {
            transform: rotate(180deg);
        }

        .nav-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            padding: 6px;
        }

        .nav-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-main);
            font-weight: 500;
            text-align: left;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-dropdown-item:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-dropdown-item.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        /* Filter Groups (Gesamtansicht) */
        .filter-group-compact {
            position: relative;
            display: inline-block;
        }

        .filter-group-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-group-toggle:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-toggle-icon {
            font-size: 0.6rem;
            transition: transform 0.2s;
        }

        .filter-group-toggle.open .filter-toggle-icon {
            transform: rotate(180deg);
        }

        .filter-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            max-height: 400px;
            overflow-y: auto;
        }

        .filter-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }


        /* HUD */
        .hud-stats {
            position: absolute; 
            bottom: 32px; 
            right: 32px; 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px) saturate(180%);
            padding: 16px 20px; 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl); 
            pointer-events: none; 
            z-index: 50;
            display: grid; 
            grid-template-columns: auto auto; 
            gap: 8px 20px; 
            font-size: 0.8rem;
            min-width: 180px;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .hud-label { 
            color: var(--text-muted); 
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .hud-value { 
            font-weight: 700; 
            text-align: right;
            color: var(--primary);
            font-size: 0.95rem;
        }

        /* WEEK BOARD ELEMENTS */
        .week-board {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            padding-bottom: 10px;
            position: relative;
        }

        .time-column {
            display: flex;
            flex-direction: column;
            padding-top: 60px; /* Header offset - align with week-day-header height */
            position: relative;
        }

        .time-label {
            height: 60px; /* 1 hour = 60px */
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            padding-right: 8px;
            border-top: 1px solid transparent; /* Placeholder */
            position: relative;
            display: flex;
            align-items: flex-start;
            padding-top: 2px;
        }

        .time-label::after {
            content: '';
            position: absolute;
            top: 0;
            right: -8px;
            width: 8px;
            height: 1px;
            background: #94a3b8;
        }

        .week-day-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .week-day-header {
            padding: 14px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-elevated);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .week-day-header .day-name {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.9rem;
        }
        
        .week-day-header .day-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .week-day-body {
            position: relative;
            height: calc(15 * 60px);
            background: 
                repeating-linear-gradient(
                    to bottom,
                    var(--border) 0px,
                    var(--border) 1px,
                    transparent 1px,
                    transparent 60px
                );
            flex-grow: 1;
            overflow: hidden;
            cursor: pointer;
        }

        .week-event-row {
            position: absolute;
            left: 3px;
            right: 3px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            cursor: pointer;
            border-left: 3px solid var(--primary);
            overflow: hidden;
            font-size: 0.8rem;
            z-index: 5;
            transition: all var(--transition-fast);
        }
        
        .week-event-row:hover {
            z-index: 20;
            box-shadow: var(--shadow-md), 0 0 0 1px var(--primary);
            transform: translateX(2px);
            border-color: var(--primary);
        }

        .week-event-row .event-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .week-event-row .event-title {
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .week-event-row .event-time {
            font-size: 0.7em;
            color: var(--text-muted);
        }

        .week-event-row .event-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-top: 2px;
        }

        .type-badge {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .type-badge.type-care {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        .type-badge.type-house {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .type-badge.type-social {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .type-badge.type-other {
            background: rgba(107, 114, 128, 0.15);
            color: #4b5563;
        }

        .week-event-row .resize-handle {
            position: absolute;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
            background: transparent;
        }

        .week-event-row .resize-handle.resize-bottom {
            bottom: 0;
            border-bottom-left-radius: var(--radius-sm);
            border-bottom-right-radius: var(--radius-sm);
        }

        .week-event-row .resize-handle.resize-top {
            top: 0;
            border-top-left-radius: var(--radius-sm);
            border-top-right-radius: var(--radius-sm);
        }

        .week-event-row:hover .resize-handle.resize-bottom {
            background: linear-gradient(to top, rgba(99, 102, 241, 0.3), transparent);
        }

        .week-event-row:hover .resize-handle.resize-top {
            background: linear-gradient(to bottom, rgba(99, 102, 241, 0.3), transparent);
        }

        .week-event-row.is-biweekly {
            border-left: 3px solid #8b5cf6; /* Violett für 2-wöchentlich */
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
        }

        .week-event-row.is-biweekly::before {
            content: '2W';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.6rem;
        }

        .week-event-row.is-fourweekly {
            border-left: 3px solid #ec4899; /* Pink für 4-wöchentlich */
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        }

        .week-event-row.is-fourweekly::before {
            content: '4W';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            color: #ec4899;
            background: rgba(236, 72, 153, 0.15);
            padding: 1px 4px;
            border-radius: 3px;
        }

        .week-event-row.is-travel {
             background: repeating-linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0px, rgba(248, 250, 252, 0.9) 10px, rgba(226, 232, 240, 0.6) 10px, rgba(226, 232, 240, 0.6) 20px);
             border: 1px dashed var(--border);
             color: var(--text-muted);
             display: flex;
             align-items: center;
             justify-content: center;
             font-style: italic;
             pointer-events: auto; /* Enable hover for travel time suggestions */
             cursor: help; /* Indicate tooltip available */
             border-left: none;
             z-index: 3; /* Niedriger als normale Events (5), damit sie unter ihnen liegen */
             transition: opacity 0.2s, transform 0.1s;
        }
        
        .week-event-row.is-travel:hover {
             opacity: 0.85;
             transform: scale(1.02);
        }
        
        .week-event-row.commute-event {
             z-index: 3; /* Niedriger als normale Events (5), damit An-/Rückfahrt unter dem Einsatz liegen */
        }

        /* Biweekly events side by side */
        .week-event-row.biweekly-left,
        .week-event-row.overlap-left {
            width: calc(50% - 3px) !important;
            left: 2px !important;
            right: auto !important;
        }

        .week-event-row.biweekly-right,
        .week-event-row.overlap-right {
            width: calc(50% - 3px) !important;
            left: auto !important;
            right: 2px !important;
        }
        
        /* Support for 3 overlapping events */
        .week-event-row.overlap-middle {
            width: calc(33.333% - 4px) !important;
            left: calc(33.333% + 1px) !important;
            right: auto !important;
        }
        
        .week-event-row.overlap-left.three-events {
            width: calc(33.333% - 4px) !important;
            left: 2px !important;
            right: auto !important;
        }
        
        .week-event-row.overlap-right.three-events {
            width: calc(33.333% - 4px) !important;
            left: auto !important;
            right: 2px !important;
        }
        
        /* Support for 4 overlapping events */
        .week-event-row.overlap-middle-left {
            width: calc(25% - 4px) !important;
            left: calc(25% + 1px) !important;
            right: auto !important;
        }
        
        .week-event-row.overlap-middle-right {
            width: calc(25% - 4px) !important;
            left: calc(50% + 1px) !important;
            right: auto !important;
        }
        
        .week-event-row.overlap-left.four-events {
            width: calc(25% - 4px) !important;
            left: 2px !important;
            right: auto !important;
        }
        
        .week-event-row.overlap-right.four-events {
            width: calc(25% - 4px) !important;
            left: auto !important;
            right: 2px !important;
        }

        /* Drag time indicator */
        .drag-time-indicator {
            position: fixed;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 9999;
            pointer-events: none;
            box-shadow: var(--shadow-lg);
            transform: translate(-50%, -100%);
            margin-top: -10px;
        }

        .week-event-row.has-conflict {
            border-left: 3px solid var(--danger) !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
            animation: pulse-conflict 2s infinite;
        }

        @keyframes pulse-conflict {
            0%, 100% { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        /* TOAST - Modern Glassmorphism */
        .toast {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 14px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            pointer-events: auto;
            animation: toastSlideIn 0.3s ease-out;
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--primary);
            max-width: 380px;
        }

        .toast.toast-success { 
            border-left-color: var(--success);
            box-shadow: var(--shadow-lg), 0 0 20px rgba(16, 185, 129, 0.2);
        }
        .toast.toast-error { 
            border-left-color: var(--danger);
            box-shadow: var(--shadow-lg), 0 0 20px rgba(239, 68, 68, 0.2);
        }
        .toast.toast-warning { 
            border-left-color: var(--warning);
            box-shadow: var(--shadow-lg), 0 0 20px rgba(245, 158, 11, 0.2);
        }
        .toast.toast-info { 
            border-left-color: var(--primary);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .toast.hiding {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        @keyframes toastSlideIn {
            from { transform: translateY(-100%) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes toastSlideOut {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-100%) scale(0.9); opacity: 0; }
        }

        /* CONTEXT MENU - Modern Glass Style */
        .context-menu {
            position: fixed;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 8px;
            min-width: 200px;
            z-index: 10001;
            display: none;
            animation: contextMenuIn 0.15s ease-out;
            border: 1px solid var(--glass-border);
        }

        .context-menu.visible {
            display: block;
        }
        
        .context-menu-item {
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-main);
            transition: all var(--transition-fast);
        }
        
        .context-menu-item:hover {
            background: var(--bg-hover);
            color: var(--primary);
        }
        
        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        @keyframes contextMenuIn {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Day Checkbox Labels - Checked State */
        .day-checkbox-label input[type="checkbox"]:checked + span {
            font-weight: 600;
        }
        
        .day-checkbox-label:has(input[type="checkbox"]:checked) {
            border-color: var(--primary) !important;
            background: var(--primary-light) !important;
            color: var(--primary) !important;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-main);
            transition: background 0.1s;
        }

        .context-menu-item:hover {
            background: var(--border-light);
        }

        .context-menu-item.danger {
            color: var(--danger);
        }

        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        .week-event-row.has-conflict::after {
            content: '⚠';
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.7rem;
        }

        .week-event-row.selected {
            outline: 3px solid var(--primary);
            outline-offset: -1px;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25);
            z-index: 50;
        }

        .week-event-row.selected::before {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.7rem;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Workload Bar */
        .workload-bar {
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .workload-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .workload-bar-fill.level-low { background: var(--success); }
        .workload-bar-fill.level-medium { background: var(--warning); }
        .workload-bar-fill.level-high { background: var(--danger); }

        .workload-text {
            font-size: 0.65rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .week-day-empty { display: none; } /* No empty state in timeline view */
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
        }
        
        .week-nav-btn {
            min-width: 28px;
            height: 28px;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        
        .week-nav span {
            min-width: 150px;
            text-align: center;
        }

        /* MODALS - Glassmorphism Style */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content { 
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 28px; 
            border-radius: var(--radius-xl); 
            width: 750px; 
            max-width: 90vw;
            box-shadow: var(--shadow-xl), 0 0 60px rgba(0, 0, 0, 0.5); 
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh; 
            overflow-y: auto;
            border: 1px solid var(--glass-border);
        }
        
        .modal-content h2, .modal-content h3 {
            color: var(--text-main);
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        /* 2-Spalten-Layout für Event-Modal */
        #eventModal .modal-content {
            display: flex;
            flex-direction: column;
        }
        
        .event-modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex: 1;
        }
        
        .event-modal-left,
        .event-modal-right {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .event-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: auto;
            padding-top: 20px;
            border-top: 1.5px solid var(--border);
            flex-wrap: wrap;
        }
        
        /* Responsive: 1-Spalten-Layout bei kleineren Bildschirmen */
        @media (max-width: 900px) {
            .event-modal-grid {
                grid-template-columns: 1fr;
            }
            
            #eventModal .modal-content {
                width: 95vw;
            }
        }
        
        @keyframes modalSlideIn {
            from { 
                transform: translateY(-20px) scale(0.95); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .modal-content {
            position: relative;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            transition: all 0.2s;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close-btn:hover {
            background: var(--bg-hover);
            color: var(--text-main);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 24px;
            margin-right: 40px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .item-list {
            background: var(--border-light);
            border-radius: var(--radius-md);
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        /* Spezifische Höhe für Tour-Liste: 10 Einträge sichtbar */
        #tourList {
            max-height: 1000px;
        }
        
        /* Spezifische Höhe für Mitarbeiter-Liste: 20 Einträge sichtbar */
        #employeeList {
            max-height: 2000px;
        }

        .item-list:empty::before {
            content: 'Noch keine Einträge vorhanden';
            display: block;
            padding: 20px;
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
            font-style: italic;
        }

        .item-list-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            transition: all var(--transition-fast);
        }

        .item-list-entry:last-child {
            border-bottom: none;
        }

        .item-list-entry:hover {
            background: var(--bg-hover);
            padding-left: 20px;
        }

        .item-list-entry .item-name {
            font-weight: 500;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-list-entry .item-name::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--gradient-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(6, 182, 212, 0.4);
        }

        .item-list-entry .item-delete {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 1.2rem;
            transition: all 0.15s ease;
        }

        .item-list-entry .item-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .item-list-entry .item-edit {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.15s ease;
        }

        .item-list-entry .item-edit:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 16px; 
        }
        
        .cb-item { 
            display: flex; 
            align-items: center; 
            font-size: 0.875rem; 
            cursor: pointer; 
            padding: 8px 14px; 
            background: var(--border-light); 
            border-radius: var(--radius-lg); 
            border: 1.5px solid var(--border);
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .cb-item:hover { 
            border-color: var(--primary); 
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .cb-item input[type="checkbox"]:checked + * {
            color: var(--primary);
        }
        
        .cb-item input[type="checkbox"]:checked ~ .dot {
            transform: scale(1.2);
        }
        
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 8px;
            transition: transform 0.2s ease;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }
        
        .dot.care { background: var(--c-care); }
        .dot.house { background: var(--c-house); }
        .dot.social { background: var(--c-social); }
        .dot.other { background: var(--c-other); }

        /* PRINT STYLES */
        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            
            body {
                background: white !important;
                height: auto;
                overflow: visible;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .sidebar {
                display: none !important;
            }
            .main-content {
                padding: 0;
                margin: 0;
            }
            .top-bar {
                display: none !important;
            }
            .hud-stats {
                display: none !important;
            }
            .toast-container, .context-menu {
                display: none !important;
            }
            
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #333;
            }
            .print-header h1 {
                margin: 0;
                font-size: 18px;
            }
            .print-header p {
                margin: 5px 0 0 0;
                font-size: 12px;
                color: #666;
            }
            
            .week-board {
                display: grid !important;
                grid-template-columns: 40px repeat(7, 1fr) !important;
                gap: 4px;
                height: auto !important;
                overflow: visible !important;
            }
            .week-day-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ccc !important;
            }
            .week-day-header {
                background: #f0f0f0 !important;
                padding: 8px !important;
            }
            .week-day-body {
                height: auto !important;
                min-height: 200px;
                background: white !important;
            }
            .week-event-row {
                position: relative !important;
                top: auto !important;
                height: auto !important;
                margin-bottom: 4px;
                font-size: 0.7rem;
                border-left-width: 4px !important;
                padding: 6px !important;
            }
            .week-event-row .event-title {
                font-weight: 700;
            }
            .week-event-row .event-time {
                font-size: 0.65rem;
            }
            .modal-overlay {
                display: none !important;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 1400px) {
            .sidebar { width: 300px; }
            #calendar { padding: 14px; }
        }

        @media (max-width: 1200px) {
            .sidebar { width: 270px; }
            .main-content { padding: 16px; }
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }
            .sidebar {
                width: 100%;
                position: sticky;
                top: 0;
                border-right: none;
                border-bottom: 1px solid var(--border);
                box-shadow: none;
                padding: 18px;
                z-index: 30;
            }
            #external-events {
                max-height: 220px;
            }
            .main-content {
                padding: 18px;
            }
            #calendar {
                overflow: auto;
            }
            .hud-stats {
                position: static;
                margin-top: 16px;
                width: 100%;
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }
            #weekControls,
            #compareControls {
                width: 100%;
                justify-content: space-between;
            }
            .view-switcher {
                width: 100%;
                justify-content: space-between;
            }
            .view-switcher .view-btn {
                flex: 1;
            }
            .hud-stats {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 600px) {
            body { font-size: 13px; }
            .sidebar {
                padding: 14px;
            }
            #external-events {
                max-height: 180px;
            }
            #calendar {
                padding: 12px;
            }
            .event-tag {
                font-size: 0.65rem;
            }
        }

        @media (max-width: 480px) {
            #weekControls select,
            #compareControls select {
                width: 100%;
            }
            .view-switcher {
                flex-direction: column;
                gap: 8px;
            }
            .hud-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile Optimierungen */
        @media (max-width: 768px) {
            /* Sidebar als Overlay */
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 280px;
                z-index: 1000;
                transition: left 0.3s ease;
                border-right: 1px solid var(--border);
            }
            
            .sidebar.open {
                left: 0;
            }
            
            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 1001;
                background: var(--primary);
                color: white;
                border: none;
                padding: 12px;
                border-radius: var(--radius-md);
                font-size: 1.2rem;
                cursor: pointer;
                box-shadow: var(--shadow-md);
            }
            
            /* Hauptbereich anpassen */
            .main-content {
                margin-left: 0;
                padding: 50px 10px 20px;
            }
            
            /* Top Bar kompakter */
            .top-bar {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .view-switcher {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .view-btn {
                font-size: 0.75rem;
                padding: 6px 10px;
                min-height: 44px;
            }
            
            /* Wochentage vertikal statt horizontal */
            .week-days-container {
                flex-direction: column;
            }
            
            .week-day-card {
                width: 100%;
                margin-bottom: 15px;
            }
            
            /* Events größer für Touch */
            .week-event-row {
                min-height: 50px;
                padding: 10px;
                font-size: 0.9rem;
            }
            
            /* Modals vollbild auf Mobile */
            .modal-content {
                width: 95vw;
                max-height: 90vh;
                margin: 5vh auto;
            }
            
            /* Buttons größer für Touch */
            .btn {
                min-height: 44px;
                padding: 12px 16px;
            }
            
            .btn.icon-btn {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Pool-Items größer */
            .pool-item {
                min-height: 50px;
                padding: 12px;
            }
            
        }

        @media (max-width: 480px) {
            /* Noch kompakter für kleine Screens */
            .view-btn {
                font-size: 0.7rem;
                padding: 5px 8px;
            }
            
            .week-event-row {
                font-size: 0.85rem;
                padding: 8px;
            }
            
            /* Text kleiner aber lesbar */
            .event-title {
                font-size: 0.9rem;
            }
            
            .event-time {
                font-size: 0.8rem;
            }
        }

        /* Touch-Gesten für Mobile */
        @media (hover: none) and (pointer: coarse) {
            /* Größere Touch-Targets */
            button, .btn, .pool-item, .week-event-row {
                min-height: 44px;
            }
            
            /* Keine Hover-Effekte auf Touch-Geräten */
            .pool-item:hover {
                transform: none;
            }
            
            /* Swipe-Gesten für Navigation */
            .week-day-card {
                touch-action: pan-x pan-y;
            }
        }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="contextMenuEdit()">✏️ Bearbeiten</div>
        <div class="context-menu-item" onclick="contextMenuDuplicate()">📄 Duplizieren</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuToPool()">📤 In Pool verschieben</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="contextMenuDelete()">🗑️ Löschen</div>
    </div>

    <aside class="sidebar" id="mainSidebar">
        <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Sidebar ein-/ausblenden" id="sidebarToggle"></button>
        <div class="sidebar-content">
        <h2 class="brand">⚡ PflegePlaner</h2>
        
        <!-- Kundenpool - immer sichtbar -->
        <div class="menu-section" style="flex-grow:1; display:flex; flex-direction:column; min-height:0;">
            <div class="menu-header" onclick="toggleMenuSection('pool')" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center; padding:8px 0;">
                <div class="section-title" style="margin:0;">👥 Kundenpool</div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <button class="btn btn-primary icon-btn" style="width:auto; height:28px; padding:0 10px; font-size:0.75rem; gap:4px;" onclick="event.stopPropagation(); openPoolModal()">+ Neu</button>
                    <button class="btn btn-secondary icon-btn" style="width:auto; height:28px; padding:0 10px; font-size:0.75rem; gap:4px;" onclick="event.stopPropagation(); openPoolImportModal()" title="Kunden importieren">📥</button>
                    <span class="menu-toggle" id="togglePool">▼</span>
            </div>
            </div>
            <div class="menu-content" id="menuPool" style="display:flex; flex-direction:column; flex:1; min-height:0;">
                <div style="display:flex; gap:4px; margin-bottom:6px; flex-wrap:wrap; align-items:center;">
                    <input type="text" id="poolSearchInput" placeholder="🔍 Suchen..." style="flex:1; min-width:60px; height:32px; padding:0 8px; font-size:0.75rem;" oninput="renderPool()">
                    <select id="poolTypeFilter" style="width:60px; height:32px; padding:0 20px 0 6px; font-size:0.75rem;" onchange="renderPool()">
                    <option value="">Alle</option>
                    <option value="care">Pflege</option>
                    <option value="house">HW</option>
                    <option value="social">Betr.</option>
                </select>
                </div>
                <div style="display:flex; gap:4px; margin-bottom:6px; align-items:center;">
                    <select id="poolZoneFilter" style="flex:1; height:32px; padding:0 20px 0 6px; font-size:0.75rem;" onchange="renderPool()">
                    <option value="">Alle Zonen</option>
                </select>
                    <select id="poolSort" style="width:60px; height:32px; padding:0 20px 0 6px; font-size:0.75rem;" onchange="renderPool()">
                    <option value="name">A-Z</option>
                    <option value="name-desc">Z-A</option>
                    <option value="zone">Zone</option>
                </select>
                </div>
                <div style="display:flex; gap:4px; margin-bottom:6px; align-items:center;">
                    <select id="filterPresetSelect" style="flex:1; height:28px; padding:0 20px 0 6px; font-size:0.7rem;" onchange="loadFilterPreset()">
                        <option value="">-- Preset laden --</option>
                    </select>
                    <button class="btn btn-secondary" style="width:28px; height:28px; padding:0; margin:0; font-size:0.75rem;" onclick="saveFilterPreset()" title="Filter speichern">💾</button>
                </div>
                <div id="external-events" style="flex:1; overflow-y:auto; min-height:0;"></div>
            </div>
            </div>
            
        <!-- Versteckte Inputs für Datei-Funktionen -->
        <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="handleCSVImport(event)">
        <div id="fileStatus" style="display:none;">Status: Verbunden</div>
        <div id="lastSaveDisplay" style="display:none;">💾 Zuletzt: –</div>

        <!-- Versionierung -->
        <div style="margin-top:auto; padding:16px 0; text-align:center; border-top:1px solid var(--border);">
            <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:4px;">
                <span style="font-size:1.2rem;">🚐</span>
                <span style="font-size:0.85rem; font-weight:700; background:var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">Tourenplanung</span>
            </div>
            <div style="font-size:0.65rem; color:var(--text-muted);">Version 2.2.0</div>
        </div>
        </div>
    </aside>

    <main class="main-content" id="mainArea">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="display:flex; align-items:center; gap:8px; padding-right:12px; border-right:1px solid var(--border);">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); white-space:nowrap;">Variante:</label>
                    <select id="variantSelect" onchange="switchVariant(this.value)" oncontextmenu="event.preventDefault(); showVariantContextMenu(event, currentVariantId);" style="width:150px; margin:0; padding:8px 12px; cursor:pointer; font-weight:600;"></select>
                    <button class="btn btn-secondary icon-btn" onclick="handleDuplicateVariant(currentVariantId)" title="Variante duplizieren" style="width:32px; height:32px; padding:0; font-size:0.9rem;">📋</button>
                    <button class="btn btn-primary icon-btn" onclick="openVariantModal()" title="Neue Variante" style="width:32px; height:32px; padding:0; font-size:0.9rem;">+</button>
                </div>
                <div class="view-switcher">
                    <!-- Planung -->
                    <div class="nav-group">
                        <button class="nav-group-btn" id="navGroupPlanning" onclick="toggleNavGroup('planning')">
                            📅 Planung
                        </button>
                        <div class="nav-dropdown" id="navDropdownPlanning">
                            <button class="nav-dropdown-item active" id="btnViewWeek" onclick="switchView('week'); closeNavGroups();">📅 Woche</button>
                            <button class="nav-dropdown-item" id="btnViewOverall" onclick="switchView('overall'); closeNavGroups();">🌐 Gesamt</button>
                        </div>
                    </div>
                    
                    <!-- Analyse -->
                    <div class="nav-group">
                        <button class="nav-group-btn" id="navGroupAnalysis" onclick="toggleNavGroup('analysis')">
                            📊 Analyse
                        </button>
                        <div class="nav-dropdown" id="navDropdownAnalysis">
                            <button class="nav-dropdown-item" id="btnViewCompare" onclick="switchView('compare'); closeNavGroups();">🔀 Vergleich</button>
                            <button class="nav-dropdown-item" id="btnViewDashboard" onclick="switchView('dashboard'); closeNavGroups();">📈 Übersicht</button>
                        </div>
                    </div>
                    
                    <!-- Optimierung -->
                    <div class="nav-group">
                        <button class="nav-group-btn" id="btnOptimization" onclick="openOptimizationModal()" style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); color:white; font-weight:600;">
                            ⚡ Optimierung
                            <span id="optimizationBadge" style="display:none; margin-left:8px; padding:2px 8px; background:rgba(255,255,255,0.3); border-radius:12px; font-size:0.75rem; font-weight:700;"></span>
                        </button>
                    </div>
                    
                    <!-- Verwaltung -->
                    <div class="nav-group">
                        <button class="nav-group-btn" id="btnViewAdmin" onclick="switchView('admin')">⚙️ Verwaltung</button>
                    </div>
                </div>
            </div>

            <div id="weekControls" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">TOUR:</label>
                <select id="tourSelect" onchange="updateTourEmployeeDisplay(); refreshView();" style="width:150px; margin:0; cursor:pointer; font-weight:600;"></select>
                <span id="tourEmployeeDisplay" style="font-size:0.75rem; color:var(--text-muted); padding:4px 8px; background:var(--border-light); border-radius:var(--radius-sm); display:none;"></span>
                
                <input type="text" id="searchInput" placeholder="🔍 Suchen..." style="width:140px; margin:0; padding:8px 12px;" oninput="searchTerm=this.value; refreshView();">
                
                <select id="typeFilterSelect" onchange="typeFilter=this.value; refreshView();" style="width:100px; margin:0; padding:8px 12px;">
                    <option value="all">Alle</option>
                    <option value="care">Pflege</option>
                    <option value="house">HW</option>
                    <option value="social">Betr.</option>
                    <option value="other">Sonst.</option>
                </select>
            </div>

            <div id="compareControls" style="display:none; align-items:center; gap:10px; flex-wrap:wrap;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">TAG:</label>
                <select id="compareDaySelect" onchange="currentCompareDayIndex = parseInt(this.value); refreshView();" style="width:150px; margin:0; cursor:pointer; font-weight:600;">
                    <option value="0">Montag</option>
                    <option value="1">Dienstag</option>
                    <option value="2">Mittwoch</option>
                    <option value="3">Donnerstag</option>
                    <option value="4">Freitag</option>
                    <option value="5">Samstag</option>
                    <option value="6">Sonntag</option>
                </select>
            </div>

            <div id="overallControls" style="display:none; background:var(--bg-card); padding:12px; border-radius:var(--radius-md); border:1px solid var(--border); margin-bottom:12px;">
                <!-- Kompakte horizontale Filter-Leiste -->
                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <!-- Tage Filter - Kompakt -->
                    <div class="filter-group-compact">
                        <button class="filter-group-toggle" onclick="toggleFilterGroup('days')" id="filterToggleDays">
                            <span>📅</span>
                            <span id="filterDaysLabel">Alle Tage</span>
                            <span class="filter-toggle-icon">▼</span>
                        </button>
                        <div class="filter-dropdown" id="filterDropdownDays">
                            <div style="display:flex; gap:4px; flex-wrap:wrap; padding:8px;">
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="0" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>Mo</span>
                                </label>
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="1" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>Di</span>
                                </label>
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="2" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>Mi</span>
                                </label>
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="3" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>Do</span>
                                </label>
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="4" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>Fr</span>
                                </label>
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="5" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>Sa</span>
                                </label>
                                <label class="day-checkbox-compact" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:var(--bg-hover); border:1px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; transition:all 0.2s; font-size:0.75rem; font-weight:500; user-select:none;" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border)'; this.style.background='var(--bg-hover)'">
                                    <input type="checkbox" value="6" checked onchange="updateOverallDayFilter()" style="width:16px; height:16px; margin:0; cursor:pointer; accent-color:var(--primary);">
                                    <span>So</span>
                                </label>
                                <div style="display:flex; gap:4px; margin-top:4px; width:100%;">
                                    <button class="btn btn-sm btn-secondary" onclick="selectAllDays(); event.stopPropagation();" style="padding:4px 8px; font-size:0.7rem; flex:1;">Alle</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deselectAllDays(); event.stopPropagation();" style="padding:4px 8px; font-size:0.7rem; flex:1;">Keine</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Touren Filter - Kompakt -->
                    <div class="filter-group-compact">
                        <button class="filter-group-toggle" onclick="toggleFilterGroup('tours')" id="filterToggleTours">
                            <span>🚐</span>
                            <span id="filterToursLabel">Alle Touren</span>
                            <span class="filter-toggle-icon">▼</span>
                        </button>
                        <div class="filter-dropdown" id="filterDropdownTours">
                            <div style="padding:8px;">
                                <div id="overallTourFilterContainer" style="display:flex; gap:4px; flex-wrap:wrap;">
                                    <!-- Wird dynamisch gefüllt -->
                                </div>
                                <div style="display:flex; gap:4px; margin-top:8px;">
                                    <button class="btn btn-sm btn-secondary" onclick="selectAllTours(); event.stopPropagation();" style="padding:4px 8px; font-size:0.7rem; flex:1;">Alle</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deselectAllTours(); event.stopPropagation();" style="padding:4px 8px; font-size:0.7rem; flex:1;">Keine</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Konflikt-Info - Kompakt -->
                    <div id="overallConflictInfo" style="display:none; padding:6px 12px; background:rgba(239, 68, 68, 0.1); border:1px solid var(--danger); border-radius:var(--radius-sm);">
                        <span style="color:var(--danger); font-weight:600; font-size:0.75rem;">
                            ⚠️ <span id="overallConflictCount">0</span>
                        </span>
                    </div>
                </div>
            </div>

            <div style="flex-grow:1;"></div>

            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <!-- Zoom Controls -->
                <div class="view-switcher" style="margin-right:8px;">
                    <button class="view-btn" id="btnZoom15" onclick="setZoom(15)" title="15-Minuten-Raster">15m</button>
                    <button class="view-btn" id="btnZoom5" onclick="setZoom(5)" title="5-Minuten-Raster">5m</button>
                </div>
                
                <!-- Aktionen Gruppe -->
                <div class="toolbar-group">
                    <button class="btn btn-secondary icon-btn toolbar-group-btn" onclick="toggleToolbarGroup('actions')" title="Aktionen" style="width:36px; height:36px; padding:0;">⚙️</button>
                    <div class="toolbar-dropdown" id="toolbarDropdownActions">
                        <button class="toolbar-dropdown-item" onclick="undo(); closeToolbarGroups();" title="Rückgängig (Strg+Z)">
                            <span>↶</span> Rückgängig
                        </button>
                        <button class="toolbar-dropdown-item" onclick="openOptimizationModal(); closeToolbarGroups();" title="Touren optimieren">
                            <span>⚡</span> Optimieren
                        </button>
                    </div>
                </div>
                
                <!-- Export Gruppe -->
                <div class="toolbar-group">
                    <button class="btn btn-secondary icon-btn toolbar-group-btn" onclick="toggleToolbarGroup('export')" title="Export" style="width:36px; height:36px; padding:0;">📥</button>
                    <div class="toolbar-dropdown" id="toolbarDropdownExport">
                        <button class="toolbar-dropdown-item" onclick="exportToPDF(); closeToolbarGroups();" title="PDF Export">
                            <span>📄</span> PDF Export
                        </button>
                        <button class="toolbar-dropdown-item" onclick="exportCSV(); closeToolbarGroups();" title="CSV Export">
                            <span>📊</span> CSV Export
                        </button>
                        <button class="toolbar-dropdown-item" onclick="printView(); closeToolbarGroups();" title="Drucken">
                            <span>🖨</span> Drucken
                        </button>
                    </div>
                </div>
                
                <!-- Theme Toggle -->
                <button class="btn btn-secondary icon-btn" onclick="toggleTheme()" title="Hell-/Dunkelmodus wechseln" style="width:36px; height:36px; padding:0;" id="themeToggleBtn">
                    <span id="themeIcon">☀️</span>
                </button>
                
                <!-- Hilfe -->
                <button class="btn btn-secondary icon-btn" onclick="openModal('keyboardHelpModal')" title="Hilfe (F1)" style="width:36px; height:36px; padding:0;">❓</button>
            </div>
        </div>

        <div id="weekView" class="week-board"></div>

        <div class="hud-stats">
            <div class="hud-label">Einsätze</div><div class="hud-value" id="hudCount">0</div>
            <div class="hud-label">Dauer</div><div class="hud-value" id="hudDuration">0h 0m</div>
            <div class="hud-label">Fahrzeit</div><div class="hud-value" id="hudTravel">0m</div>
        </div>
    </main>

    <div id="poolModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('poolModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">Neuer Kunde (Pool)</h3>
            <label class="section-title">Name</label>
            <input type="text" id="poolName" list="patientList" placeholder="👤 Name">
            <label class="section-title">Zone</label>
            <select id="poolZone"></select>
            <label class="section-title">Straße + Hausnummer</label>
            <input type="text" id="poolAddress" placeholder="Musterstraße 123">
            <label class="section-title">Postleitzahl</label>
            <input type="text" id="poolPostalCode" placeholder="45879" maxlength="10">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-secondary" onclick="geocodePoolAddress()" id="geocodeBtn" style="flex:1;">🔍 Koordinaten ermitteln</button>
                <button class="btn btn-secondary" onclick="openManualCoordinatesModal()" style="flex:1;">✏️ Manuell eingeben</button>
            </div>
            <div id="poolCoordinatesDisplay" style="display:none; margin-bottom:15px; padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.9rem;">
                <strong>Koordinaten:</strong> <span id="poolCoordinatesText"></span>
            </div>
            <label class="section-title">Leistungen</label>
            <div class="checkbox-group">
                <label class="cb-item"><input type="checkbox" class="pool-cb" value="care"><div class="dot care"></div>Pflege</label>
                <label class="cb-item"><input type="checkbox" class="pool-cb" value="house"><div class="dot house"></div>HW</label>
                <label class="cb-item"><input type="checkbox" class="pool-cb" value="social"><div class="dot social"></div>Betr.</label>
            </div>
            <button class="btn btn-primary" onclick="createPoolItem()">✅ Anlegen</button>
            <button class="btn btn-secondary" onclick="closeModal('poolModal')">❌ Abbrechen</button>
        </div>
    </div>

    <!-- Manuelle Koordinaten-Eingabe Modal -->
    <div id="manualCoordinatesModal" class="modal-overlay">
        <div class="modal-content" style="max-width:500px;">
            <button class="modal-close-btn" onclick="closeModal('manualCoordinatesModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">Koordinaten manuell eingeben</h3>
            <label class="section-title">Breitengrad (Latitude)</label>
            <input type="number" id="manualLat" step="any" placeholder="51.5125" min="-90" max="90">
            <label class="section-title">Längengrad (Longitude)</label>
            <input type="number" id="manualLng" step="any" placeholder="7.1026" min="-180" max="180">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="saveManualCoordinates()">✅ Speichern</button>
                <button class="btn btn-secondary" onclick="closeModal('manualCoordinatesModal')">❌ Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Manuelle Koordinaten-Eingabe Modal für Mitarbeiter -->
    <div id="manualEmployeeCoordinatesModal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal-content" style="max-width:500px;">
            <button class="modal-close-btn" onclick="closeModal('manualEmployeeCoordinatesModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">Koordinaten manuell eingeben</h3>
            <label class="section-title">Breitengrad (Latitude)</label>
            <input type="number" id="manualEmpLat" step="any" placeholder="51.5125" min="-90" max="90">
            <label class="section-title">Längengrad (Longitude)</label>
            <input type="number" id="manualEmpLng" step="any" placeholder="7.1026" min="-180" max="180">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="saveManualEmployeeCoordinates()">✅ Speichern</button>
                <button class="btn btn-secondary" onclick="closeModal('manualEmployeeCoordinatesModal')">❌ Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Mitarbeiter bearbeiten (vollständig) -->
    <div id="employeeEditModal" class="modal-overlay">
        <div class="modal-content" style="width:760px;">
            <button class="modal-close-btn" onclick="closeModal('employeeEditModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">👤 Mitarbeiter:in bearbeiten</h3>
            <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">Name, Stunden, Lohngruppe, Transport, Wohnort und Adresse bearbeiten.</p>
            
            <div class="input-group" style="margin-bottom:16px;">
                <label class="section-title">Stammdaten</label>
                <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:8px; align-items:end;">
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted);">Name</label>
                        <input id="editEmpName" placeholder="Name">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted);">Std/Woche</label>
                        <input id="editEmpHours" type="number" min="0" max="60" value="40">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted);">Lohngruppe</label>
                        <select id="editEmpWageGroup"></select>
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted);">Transport</label>
                        <select id="editEmpTransport">
                            <option value="car">🚘 PKW</option>
                            <option value="public">🚌 Öffis</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <label style="font-size:0.75rem; color:var(--text-muted);">🏠 Wohnort (Zone)</label>
                    <select id="editEmpHomeZone"></select>
                </div>
            </div>
            
            <div class="input-group" style="margin-bottom:16px;">
                <label class="section-title" style="font-size:0.9rem; margin-bottom:8px;">📍 Adresse (optional)</label>
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px; margin-bottom:8px;">
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted);">Straße + Hausnummer</label>
                        <input id="editEmpAddress2" placeholder="Musterstraße 123">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; color:var(--text-muted);">Postleitzahl</label>
                        <input id="editEmpPostalCode2" placeholder="45879" maxlength="10">
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:8px;">
                    <button class="btn btn-secondary" id="editEmpGeocodeBtn" onclick="geocodeEmployeeAddressEmployeeEditModal()" style="flex:1;">🔍 Koordinaten ermitteln</button>
                    <button class="btn btn-secondary" onclick="openManualEmployeeCoordinatesEmployeeEditModal()" style="flex:1;">✏️ Manuell</button>
                </div>
                <div id="editEmpCoordinatesDisplay2" style="display:none; padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.9rem;">
                    <strong>Koordinaten:</strong> <span id="editEmpCoordinatesText2"></span>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('employeeEditModal')">❌ Abbrechen</button>
                <button class="btn btn-primary" onclick="saveEmployeeEditModal()">✅ Speichern</button>
            </div>
        </div>
    </div>

    <!-- Pool Import Modal -->
    <div id="poolImportModal" class="modal-overlay">
        <div class="modal-content" style="max-width:700px;">
            <button class="modal-close-btn" onclick="closeModal('poolImportModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">📥 Kunden importieren</h3>
            
            <div style="margin-bottom:20px; padding:12px; background:var(--border-light); border-radius:var(--radius-sm);">
                <p style="margin:0 0 8px 0; font-weight:600; font-size:0.9rem;">Format:</p>
                <p style="margin:0; font-size:0.85rem; color:var(--text-muted);">Name, Postleitzahl und optional Adresse (getrennt durch Tab, Semikolon oder Komma)</p>
                <p style="margin:8px 0 0 0; font-size:0.85rem; color:var(--text-muted);">Beispiel: <code style="background:var(--bg-body);padding:2px 4px;border-radius:3px;">Max Mustermann	45879	Musterstraße 123</code> oder <code style="background:var(--bg-body);padding:2px 4px;border-radius:3px;">Max Mustermann;45879;Musterstraße 123</code></p>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="document.getElementById('poolImportFileInput').click()" style="flex:1;">📄 Datei auswählen (.xlsx, .xls, .csv)</button>
                <input type="file" id="poolImportFileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handlePoolImportFile(event)">
            </div>
            <div id="sheetjsWarning" style="display:none; margin-bottom:15px; padding:10px; background:rgba(245, 158, 11, 0.1); border-left:3px solid #f59e0b; border-radius:var(--radius-sm);">
                <p style="margin:0; font-size:0.85rem; color:var(--warning);">⚠️ Excel-Import möglicherweise nicht verfügbar. CSV-Format oder Copy&Paste funktionieren immer.</p>
            </div>
            
            <div style="margin-bottom:15px;">
                <label class="section-title" style="margin-bottom:8px;">Oder Copy & Paste:</label>
                <textarea id="poolImportTextarea" placeholder="Fügen Sie hier Ihre Daten ein (Name und PLZ)...&#10;Max Mustermann	45879&#10;Anna Schmidt	45894&#10;..." style="width:100%; min-height:150px; padding:10px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body); color:var(--text-main); font-family:monospace; font-size:0.85rem; resize:vertical;"></textarea>
            </div>
            
            <div id="poolImportPreview" style="display:none; margin-bottom:20px; padding:12px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); max-height:200px; overflow-y:auto;">
                <p style="margin:0 0 10px 0; font-weight:600; font-size:0.9rem;">Vorschau:</p>
                <div id="poolImportPreviewContent"></div>
            </div>
            
            <div style="margin-bottom:20px; padding:12px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm);">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="poolImportAutoGeocode" style="width:18px; height:18px; cursor:pointer;">
                    <div>
                        <div style="font-weight:600; font-size:0.9rem; margin-bottom:4px;">📍 Koordinaten automatisch ermitteln</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">Für alle Kunden mit Adresse werden Koordinaten ermittelt (kann bei vielen Einträgen länger dauern, max. 1/Sekunde)</div>
                    </div>
                </label>
            </div>
            
            <div id="poolImportGeocodeProgress" style="display:none; margin-bottom:20px; padding:12px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm);">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <div style="flex:1; height:8px; background:var(--border-light); border-radius:4px; overflow:hidden;">
                        <div id="poolImportGeocodeProgressBar" style="height:100%; background:var(--primary); width:0%; transition:width 0.3s;"></div>
                    </div>
                    <span id="poolImportGeocodeProgressText" style="font-size:0.85rem; color:var(--text-muted); white-space:nowrap;">0/0</span>
                </div>
                <div id="poolImportGeocodeStatus" style="font-size:0.85rem; color:var(--text-muted);">Bereite Geocoding vor...</div>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('poolImportModal')">Abbrechen</button>
                <button class="btn btn-secondary" onclick="previewPoolImport()">Vorschau</button>
                <button class="btn btn-primary" id="poolImportExecuteBtn" onclick="handlePoolImportPaste()">📥 Importieren</button>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('eventModal')" title="Schließen">×</button>
            <h3 style="margin-top:0; margin-bottom:16px;" id="modalTitle">Einsatz</h3>
            <input type="hidden" id="eventId">
            <!-- Name oben (volle Breite) -->
            <div style="margin-bottom:12px;">
                <input type="text" id="eventClient" list="patientList" placeholder="👤 Name" style="width:100%; font-size:0.95rem; font-weight:600; padding:8px 10px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);">
            </div>
            <!-- 2-Spalten-Grid -->
            <div class="event-modal-grid">
                <!-- Linke Spalte -->
                <div class="event-modal-left">
                    <!-- Typ-Checkboxen -->
                    <div class="checkbox-group" style="margin:0; padding:10px; background:var(--border-light); border-radius:var(--radius-sm);">
                        <label class="cb-item"><input type="checkbox" class="event-cb" value="care"> 🏥 Pflege</label>
                        <label class="cb-item"><input type="checkbox" class="event-cb" value="house"> 🏠 HW</label>
                        <label class="cb-item"><input type="checkbox" class="event-cb" value="social"> 🤝 Betr.</label>
                        <label class="cb-item"><input type="checkbox" class="event-cb" value="other"> 📋 Sonst.</label>
                    </div>
                    <!-- Zeit-Felder -->
                    <div style="padding:12px; background:var(--border-light); border-radius:var(--radius-md);">
                        <div id="eventDayLabel" style="font-size:0.85rem; color:var(--primary); font-weight:600; margin-bottom:8px; text-align:center; padding:4px 0;"></div>
                        <div style="display:flex; gap:8px; align-items:flex-start;">
                            <div style="flex:1; min-width:0;">
                                <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">⏰ Von</label>
                                <input type="time" id="eventStartTime" style="width:100%; font-size:0.9rem; font-weight:500; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);">
                            </div>
                            <div style="flex:1; min-width:0;">
                                <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">⏰ Bis</label>
                                <input type="time" id="eventEndTime" style="width:100%; font-size:0.9rem; font-weight:500; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);">
                            </div>
                            <div style="flex:1; min-width:0;">
                                <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">⏱️ Dauer</label>
                                <div id="eventDuration" style="font-size:0.9rem; font-weight:600; color:var(--primary); padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body); min-height:34px; display:flex; align-items:center;">--</div>
                            </div>
                        </div>
                    </div>
                    <!-- Zone + Tour -->
                    <div style="display:flex; gap:8px;">
                        <div style="flex:1; min-width:0;">
                            <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">🌍 Zone</label>
                            <select id="eventZone" style="width:100%; font-size:0.9rem; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);"></select>
                        </div>
                        <div style="flex:1; min-width:0;">
                            <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">🚐 Tour</label>
                            <select id="eventTourSelect" style="width:100%; font-size:0.9rem; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);"></select>
                        </div>
                    </div>
                    <!-- Wiederholung -->
                    <div style="padding:10px; background:var(--border-light); border-radius:var(--radius-sm);">
                        <label class="section-title" style="margin-bottom:8px; display:block; font-size:0.8rem;">🔄 Auch anlegen für (Wiederholung)</label>
                        <div class="checkbox-group" style="margin:0; display:flex; flex-wrap:wrap; gap:8px;">
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="0"> Mo</label>
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="1"> Di</label>
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="2"> Mi</label>
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="3"> Do</label>
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="4"> Fr</label>
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="5"> Sa</label>
                            <label class="cb-item"><input type="checkbox" class="repeat-cb" value="6"> So</label>
                        </div>
                    </div>
                </div>
                <!-- Rechte Spalte -->
                <div class="event-modal-right">
                    <!-- Adresse + Koordinaten (kombiniert) -->
                    <div id="eventLocationDisplay" style="display:none; padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.9rem;">
                        <div id="eventAddressText" style="margin-bottom:4px;"></div>
                        <div id="eventCoordinatesText" style="color:var(--text-muted); font-size:0.85rem;"></div>
                    </div>
                    <!-- Rhythmus + Tag -->
                    <div style="display:flex; gap:8px;">
                        <div style="flex:1; min-width:0;">
                            <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">🔄 Rhythmus</label>
                            <select id="eventRhythm" style="width:100%; font-size:0.9rem; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);">
                                <option value="weekly">1-wöchentlich</option>
                                <option value="biweekly">2-wöchentlich</option>
                                <option value="fourweekly">4-wöchentlich</option>
                            </select>
                        </div>
                        <div style="flex:1; min-width:0;">
                            <label class="section-title" style="margin-bottom:4px; display:block; font-size:0.8rem;">🏷️ Tag</label>
                            <input type="text" id="eventTag" placeholder="z.B. Wichtig, Dringend" style="width:100%; font-size:0.9rem; padding:6px 8px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body);">
                        </div>
                    </div>
                    <!-- Buttons -->
                    <div class="event-modal-buttons">
                        <button class="btn btn-secondary" onclick="moveBackToPool()" style="display:flex; align-items:center; gap:6px; padding:10px 16px;">📤 In Pool</button>
                        <button class="btn btn-secondary" onclick="duplicateEvent()" id="duplicateBtn" style="display:none; align-items:center; gap:6px; padding:10px 16px;">📄 Duplizieren</button>
                        <button class="btn btn-danger" onclick="deleteEvent()" style="display:flex; align-items:center; gap:6px; padding:10px 16px;">🗑️ Löschen</button>
                        <button class="btn btn-primary" onclick="saveEvent()" style="display:flex; align-items:center; gap:6px; padding:10px 20px; font-weight:600;">💾 Speichern</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <datalist id="patientList"></datalist>

    <!-- (ehemalige Admin-Überbleibsel entfernt): tourModal + employeeModal -->

    <!-- Copy Day Modal -->
    <div id="copyDayModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('copyDayModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">📋 Tag kopieren</h3>
            <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">Alle Einsätze eines Tages auf einen anderen Tag kopieren.</p>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label class="section-title">Von Tag</label>
                    <select id="copyFromDay">
                        <option value="0">Montag</option>
                        <option value="1">Dienstag</option>
                        <option value="2">Mittwoch</option>
                        <option value="3">Donnerstag</option>
                        <option value="4">Freitag</option>
                        <option value="5">Samstag</option>
                        <option value="6">Sonntag</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label class="section-title">Nach Tag</label>
                    <select id="copyToDay">
                        <option value="0">Montag</option>
                        <option value="1">Dienstag</option>
                        <option value="2">Mittwoch</option>
                        <option value="3">Donnerstag</option>
                        <option value="4">Freitag</option>
                        <option value="5">Samstag</option>
                        <option value="6">Sonntag</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('copyDayModal')">❌ Abbrechen</button>
                <button class="btn btn-primary" onclick="executeCopyDay()">📋 Kopieren</button>
            </div>
        </div>
    </div>

    <!-- Customer Overview Modal -->
    <div id="customerModal" class="modal-overlay">
        <div class="modal-content" style="width:600px;">
            <button class="modal-close-btn" onclick="closeModal('customerModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">👥 Kundenübersicht</h3>
            
            <div style="display:flex; gap:10px; margin-bottom:16px;">
                <input type="text" id="customerSearch" placeholder="🔍 Kunde suchen..." style="flex:1;" oninput="renderCustomerList()">
                <select id="customerZoneFilter" onchange="renderCustomerList()" style="width:150px;">
                    <option value="">Alle Zonen</option>
                </select>
            </div>
            
            <div id="customerList" class="item-list" style="max-height:400px;"></div>
            
            <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border);">
                <button class="btn btn-secondary" onclick="closeModal('customerModal')">✖️ Schließen</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->

    <!-- Optimization Modal -->
    <div id="optimizationModal" class="modal-overlay">
        <div class="modal-content" style="max-width:700px;">
            <button class="modal-close-btn" onclick="closeModal('optimizationModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">⚡ Tourenoptimierung</h3>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">Optimierungsbereich:</label>
                <select id="optimizeScopeSelect" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius-md);" onchange="updateOptimizeScope()">
                    <option value="day">Einzelner Tag</option>
                    <option value="tour">Gesamte Tour</option>
                </select>
            </div>
            <div id="optimizeDayContainer" style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">Tag auswählen:</label>
                <select id="optimizeDaySelect" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius-md);">
                    <option value="0">Montag</option>
                    <option value="1">Dienstag</option>
                    <option value="2">Mittwoch</option>
                    <option value="3">Donnerstag</option>
                    <option value="4">Freitag</option>
                    <option value="5">Samstag</option>
                    <option value="6">Sonntag</option>
                </select>
            </div>
            <div id="optimizeTourContainer" style="margin-bottom:20px; display:none;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">Tour auswählen:</label>
                <select id="optimizeTourSelect" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius-md);">
                </select>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">Optimierungskriterium:</label>
                <select id="optimizeForSelect" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius-md);">
                    <option value="time">Zeit minimieren</option>
                    <option value="distance">Distanz minimieren</option>
                    <option value="cost">Kosten minimieren</option>
                </select>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">Leistungstyp-Trennung:</label>
                <select id="optimizeTypeSeparation" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius-md);">
                    <option value="flexible">Flexibel (Vermischung erlaubt wenn Route besser)</option>
                    <option value="strict">Strikt (keine Vermischung von Pflege/HW)</option>
                </select>
                <p style="margin:8px 0 0 0; font-size:0.85rem; color:var(--text-muted);">
                    Bei strikter Trennung werden nur Events mit passendem Leistungstyp zugewiesen (basierend auf Tour-Einstellungen).
                </p>
            </div>
            <div id="optimizationResults" style="display:none; margin-bottom:20px; padding:15px; background:var(--bg-card); border-radius:var(--radius-md); border:1px solid var(--border);"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('optimizationModal')">Abbrechen</button>
                <button class="btn btn-primary" onclick="executeOptimization()">⚡ Optimieren</button>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <!-- Templates Modal -->
    <div id="templateModal" class="modal-overlay">
        <div class="modal-content" style="width:500px;">
            <button class="modal-close-btn" onclick="closeModal('templateModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">📁 Wochenvorlagen</h3>
            
            <div style="margin-bottom:20px;">
                <label class="section-title">Aktuelle Woche als Vorlage speichern</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="templateName" placeholder="Name der Vorlage..." style="flex:1;">
                    <button class="btn btn-primary" style="width:auto; min-width:100px;" onclick="saveTemplate()">
                        💾 Speichern
                    </button>
                </div>
            </div>
            
            <div>
                <label class="section-title">Gespeicherte Vorlagen</label>
                <div id="templateList" class="item-list" style="max-height:250px;"></div>
            </div>
            
            <div style="margin-top:20px; padding:12px; background:var(--border-light); border-radius:var(--radius-md); font-size:0.85rem; color:var(--text-muted);">
                ⚠️ Beim Laden einer Vorlage werden die aktuellen Einsätze ersetzt.
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary" onclick="closeModal('templateModal')">✖️ Schließen</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help Modal -->
    <div id="keyboardHelpModal" class="modal-overlay">
        <div class="modal-content" style="width:500px;">
            <button class="modal-close-btn" onclick="closeModal('keyboardHelpModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">⌨️ Tastaturkürzel</h3>
            
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                <thead>
                    <tr style="background:var(--border-light);">
                        <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Taste</th>
                        <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Funktion</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">Strg + Z</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Rückgängig machen</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">Strg + S</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Speichern</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">Strg + A</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Alle Einsätze auswählen</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">Strg + Klick</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Mehrere Einsätze auswählen</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">Shift + Drag</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Einsatz kopieren</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">Escape</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Auswahl aufheben / Modal schließen</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">N</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Neuer Einsatz</td></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid var(--border);"><kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">?</kbd> oder <kbd style="background:var(--border-light); padding:2px 8px; border-radius:4px; font-family:monospace;">F1</kbd></td><td style="padding:8px; border-bottom:1px solid var(--border);">Diese Hilfe anzeigen</td></tr>
                </tbody>
            </table>
            
            <div style="margin-top:16px; padding:12px; background:var(--border-light); border-radius:var(--radius-md); font-size:0.85rem; color:var(--text-muted);">
                <strong>Tipp:</strong> Rechtsklick auf einen Einsatz öffnet das Kontextmenü.
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-primary" onclick="closeModal('keyboardHelpModal')">Verstanden</button>
            </div>
        </div>
    </div>

    <!-- Wage Settings Modal -->
    <div id="wageSettingsModal" class="modal-overlay">
        <div class="modal-content" style="width:900px; max-height:90vh; overflow-y:auto;">
            <button class="modal-close-btn" onclick="closeModal('wageSettingsModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">💰 Lohnkonfiguration</h3>
            
            <!-- Lohngruppen -->
            <div style="margin-bottom:24px;">
                <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>👥 Lohngruppen</span>
                    <button class="btn btn-sm btn-secondary" style="padding:4px 10px; font-size:0.75rem;" onclick="addWageGroup()">+ Hinzufügen</button>
                </div>
                <div id="wageGroupsList" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>
            
            <!-- Zuschläge -->
            <div style="margin-bottom:24px;">
                <div class="section-title">📈 Zuschläge (%)</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Sonntag</label>
                        <input type="number" id="surchargeSunday" min="0" max="200" value="25" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Feiertag</label>
                        <input type="number" id="surchargeHoliday" min="0" max="200" value="100" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Nacht (20-06 Uhr)</label>
                        <input type="number" id="surchargeNight" min="0" max="200" value="25" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                </div>
            </div>
            
            <!-- Erlöse pro Leistungsart -->
            <div style="margin-bottom:24px;">
                <div class="section-title">💶 Erlöse pro Stunde (€)</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--c-care); margin-bottom:4px;">🏥 Pflege</label>
                        <input type="number" id="revenueCare" min="0" step="0.5" value="45" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--c-house); margin-bottom:4px;">🏠 Hauswirtschaft</label>
                        <input type="number" id="revenueHouse" min="0" step="0.5" value="35" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--c-social); margin-bottom:4px;">🤝 Betreuung</label>
                        <input type="number" id="revenueSocial" min="0" step="0.5" value="40" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                </div>
            </div>
            
            <!-- Fahrtkosten -->
            <div style="margin-bottom:24px;">
                <div class="section-title">🚗 Fahrtkosten</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">⏱️ Ø Geschwindigkeit (km/h)</label>
                        <input type="number" id="avgSpeed" min="10" max="80" value="30" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">🚘 PKW (€/km)</label>
                        <input type="number" id="kmRate" min="0" step="0.05" value="0.30" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">🚌 Öffis (€/Monat)</label>
                        <input type="number" id="publicTransportMonthly" min="0" step="5" value="30" style="width:100%;" onchange="updateWageSettings()">
                    </div>
                </div>
            </div>
            
            <!-- Arbeitgeberfaktor & Zielmarge -->
            <div style="margin-bottom:24px;">
                <div class="section-title">🎯 Kalkulation</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Arbeitgeberfaktor (1.0 = nur Lohn)</label>
                        <input type="number" id="employerFactor" min="1" max="2" step="0.05" value="1.5" style="width:100%;" onchange="updateWageSettings()">
                        <span style="font-size:0.7rem; color:var(--text-light);">1.5 = 50% Arbeitgeberanteil</span>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Zielmarge (%)</label>
                        <input type="number" id="targetMargin" min="0" max="80" value="50" style="width:100%;" onchange="updateWageSettings()">
                        <span style="font-size:0.7rem; color:var(--text-light);">50% = Erlös ist doppelt so hoch wie Kosten</span>
                    </div>
                </div>
            </div>
            
            <div style="padding:12px; background:var(--primary-light); border-radius:var(--radius-md); font-size:0.85rem; color:var(--primary); margin-bottom:16px;">
                💡 <strong>Hinweis:</strong> Die Lohnkosten werden mit dem Arbeitgeberfaktor multipliziert (z.B. 1,5 für 50% Sozialabgaben). Die Zielmarge gibt an, wie hoch der Erlös im Verhältnis zu den Kosten sein soll.
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="resetWageSettings()">↩️ Zurücksetzen</button>
                <button class="btn btn-primary" onclick="closeModal('wageSettingsModal')">✅ Speichern</button>
            </div>
        </div>
    </div>

    <!-- Profitability Dashboard Modal -->
    <div id="profitabilityModal" class="modal-overlay">
        <div class="modal-content" style="width:900px; max-height:90vh; overflow-y:auto;">
            <button class="modal-close-btn" onclick="closeModal('profitabilityModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">📊 Profitabilitätsanalyse</h3>
            
            <div id="profitabilityContent">
                <!-- Will be filled dynamically -->
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('profitabilityModal')">✖️ Schließen</button>
            </div>
        </div>
    </div>

    <!-- Backup Import Bestätigung Modal -->
    <div id="backupImportConfirmModal" class="modal-overlay">
        <div class="modal-content" style="width:500px;">
            <button class="modal-close-btn" onclick="closeModal('backupImportConfirmModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">⚠️ Backup importieren</h3>
            
            <div style="background:var(--warning); background:rgba(245, 158, 11, 0.1); padding:16px; border-radius:var(--radius-lg); margin-bottom:16px; border:2px solid var(--warning);">
                <p style="margin:0; font-weight:600; color:var(--warning); font-size:1rem;">⚠️ WARNUNG</p>
                <p style="margin:8px 0 0 0; font-size:0.9rem; color:var(--text-main);">
                    Alle aktuellen Daten werden überschrieben!<br>
                    Einsätze, Pool, Mitarbeiter, Touren und Lohnkonfiguration werden durch die importierten Daten ersetzt.
                </p>
            </div>
            
            <div style="background:var(--bg-card); padding:12px; border-radius:var(--radius-md); margin-bottom:16px; border:1px solid var(--border);">
                <p style="margin:0; font-size:0.85rem; color:var(--text-muted);">
                    <strong>Datei:</strong> <span id="backupImportFileName" style="color:var(--text-main);">–</span>
                </p>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('backupImportConfirmModal')">❌ Abbrechen</button>
                <button class="btn btn-primary" id="backupImportConfirmBtn" onclick="confirmBackupImport()" style="background:var(--danger);">✅ Importieren</button>
            </div>
        </div>
    </div>

    <!-- Input Modal für Text-Eingaben -->
    <div id="inputModal" class="modal-overlay">
        <div class="modal-content" style="width:500px;">
            <button class="modal-close-btn" onclick="closeInputModal()" title="Schließen">×</button>
            <h3 style="margin-top:0; margin-bottom:12px;" id="inputModalTitle">Eingabe</h3>
            <p style="margin:0 0 16px 0; color:var(--text-muted); font-size:0.9rem;" id="inputModalMessage"></p>
            <input type="text" id="inputModalField" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body); font-size:1rem; margin-bottom:20px;" placeholder="Eingabe...">
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeInputModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="confirmInputModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirm Input Modal für Bestätigungen mit Text-Eingabe -->
    <div id="confirmInputModal" class="modal-overlay">
        <div class="modal-content" style="width:550px;">
            <button class="modal-close-btn" onclick="closeConfirmInputModal()" title="Schließen">×</button>
            <h3 style="margin-top:0; margin-bottom:12px;" id="confirmInputModalTitle">Bestätigung erforderlich</h3>
            <div style="background:rgba(239, 68, 68, 0.1); padding:16px; border-radius:var(--radius-md); margin-bottom:16px; border:2px solid var(--danger);">
                <p style="margin:0; font-weight:600; color:var(--danger); font-size:1rem; margin-bottom:8px;">⚠️ WARNUNG</p>
                <p style="margin:0; font-size:0.9rem; color:var(--text-main);" id="confirmInputModalMessage"></p>
            </div>
            <label class="section-title" style="margin-bottom:6px; display:block;" id="confirmInputModalLabel">Bestätigungstext eingeben:</label>
            <input type="text" id="confirmInputModalField" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-body); font-size:1rem; margin-bottom:20px;" placeholder="Text eingeben...">
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeConfirmInputModal()">Abbrechen</button>
                <button class="btn btn-danger" onclick="confirmConfirmInputModal()">Bestätigen</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal für Nachrichten -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content" style="width:450px;">
            <button class="modal-close-btn" onclick="closeAlertModal()" title="Schließen">×</button>
            <div style="text-align:center; margin-bottom:16px;">
                <div id="alertModalIcon" style="font-size:3rem; margin-bottom:12px;">ℹ️</div>
                <h3 style="margin:0; margin-bottom:8px;" id="alertModalTitle">Information</h3>
            </div>
            <p style="margin:0 0 20px 0; color:var(--text-main); text-align:center; font-size:1rem;" id="alertModalMessage"></p>
            <div style="display:flex; justify-content:center;">
                <button class="btn btn-primary" onclick="closeAlertModal()" style="min-width:120px;">OK</button>
            </div>
        </div>
    </div>

    <div id="csvImportModal" class="modal-overlay">
        <div class="modal-content" style="width:550px;">
            <button class="modal-close-btn" onclick="closeModal('csvImportModal')" title="Schließen">×</button>
            <h3 style="margin-top:0;">📤 CSV Import</h3>
            
            <div style="background:var(--bg-dark); padding:16px; border-radius:var(--radius-lg); margin-bottom:16px;">
                <p style="margin:0 0 12px 0; font-weight:600; color:var(--primary);">📋 Datenstruktur</p>
                <p style="margin:0 0 8px 0; font-size:0.9rem;">Die CSV-Datei muss folgende Spalten enthalten (getrennt durch <strong>Semikolon ;</strong>):</p>
                
                <table style="width:100%; font-size:0.85rem; border-collapse:collapse; margin:12px 0;">
                    <thead>
                        <tr style="background:var(--border-light);">
                            <th style="padding:8px; text-align:left; border:1px solid var(--border);">Spalte</th>
                            <th style="padding:8px; text-align:left; border:1px solid var(--border);">Inhalt</th>
                            <th style="padding:8px; text-align:center; border:1px solid var(--border);">Pflicht</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding:8px; border:1px solid var(--border);"><strong>1. Name</strong></td>
                            <td style="padding:8px; border:1px solid var(--border);">Name des Kunden</td>
                            <td style="padding:8px; text-align:center; border:1px solid var(--border);">✅</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid var(--border);"><strong>2. Zone</strong></td>
                            <td style="padding:8px; border:1px solid var(--border);">Stadtteil (z.B. Alt-/Neustadt, Buer)</td>
                            <td style="padding:8px; text-align:center; border:1px solid var(--border);">–</td>
                        </tr>
                        <tr>
                            <td style="padding:8px; border:1px solid var(--border);"><strong>3. Typen</strong></td>
                            <td style="padding:8px; border:1px solid var(--border);">care, house, social, other<br><span style="font-size:0.8rem; color:var(--text-muted);">(kommagetrennt möglich)</span></td>
                            <td style="padding:8px; text-align:center; border:1px solid var(--border);">–</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="background:var(--border-light); padding:12px; border-radius:var(--radius-md); margin-bottom:16px;">
                <p style="margin:0 0 8px 0; font-weight:600; font-size:0.85rem;">📝 Beispiel:</p>
                <code style="display:block; background:var(--bg-card); padding:10px; border-radius:var(--radius-sm); font-size:0.8rem; white-space:pre-wrap;">Name;Zone;Typ
Müller, Hans;Alt-/Neustadt;care
Schmidt, Anna;Buer;care,house
Weber, Peter;Erle;social</code>
            </div>
            
            <div style="background:rgba(245, 158, 11, 0.1); padding:12px; border-radius:var(--radius-md); border-left:3px solid #f59e0b; margin-bottom:20px;">
                <p style="margin:0; font-size:0.85rem;">⚠️ <strong>Hinweis:</strong> Die importierten Kunden werden dem <strong>Wartepool</strong> hinzugefügt und können von dort eingeplant werden.</p>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('csvImportModal')">❌ Abbrechen</button>
                <button class="btn btn-primary" onclick="startCSVUpload()">📂 Datei auswählen</button>
            </div>
        </div>
    </div>

    <!-- SheetJS für Excel-Import (optional, lädt asynchron) -->
    <script>
        // Lade SheetJS asynchron, damit es den Seitenaufbau nicht blockiert
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                console.warn('SheetJS konnte nicht geladen werden. Excel-Import wird nicht verfügbar sein.');
            };
            document.head.appendChild(script);
        })();
    </script>
    
    <script>
        const CITY_ZONES = ["Alt-/Neustadt", "Beckhausen", "Bismarck", "Buer", "Bulmke-Hüllen", "Erle", "Feldmark", "Hassel", "Heßler", "Horst", "Resser Mark", "Resse", "Rotthausen", "Schalke", "Scholven", "Ückendorf", "Außerhalb"];
        
        // Postleitzahlen für Gelsenkirchen Stadtteile
        const ZONE_POSTAL_CODES = {
            "Alt-/Neustadt": "45879",  // Altstadt und Neustadt
            "Beckhausen": "45899",
            "Bismarck": "45889",
            "Buer": "45894",
            "Bulmke-Hüllen": "45888",
            "Erle": "45891",
            "Feldmark": "45883",
            "Hassel": "45768",
            "Heßler": "45883",  // Mehrere PLZ möglich, erste verwendet
            "Horst": "45899",
            "Resser Mark": "45892",
            "Resse": "45892",
            "Rotthausen": "45884",
            "Schalke": "45881",
            "Scholven": "45896",
            "Ückendorf": "45886",
            "Außerhalb": null  // Keine PLZ für "Außerhalb"
        };
        
        // Hilfsfunktion: Gibt Zone mit PLZ zurück (falls vorhanden)
        function getZoneWithPostalCode(zone) {
            if(!zone || zone === "Außerhalb") return zone;
            
            // Spezielle Behandlung für Zonen mit mehreren PLZ
            if (zone === "Buer") {
                return "Buer (45894, 45897)";
            }
            
            const plz = ZONE_POSTAL_CODES[zone];
            return plz ? `${zone} (${plz})` : zone;
        }
        
        // Hilfsfunktion: Mappt PLZ zu Zone (umgekehrtes Mapping)
        function getZoneFromPostalCode(postalCode) {
            if(!postalCode) return null;
            // Normalisiere PLZ (entferne Leerzeichen, konvertiere zu String)
            const normalizedPLZ = String(postalCode).trim();
            
            // Spezielle PLZ-Zuordnungen (mehrere PLZ pro Zone)
            const additionalPLZMapping = {
                "45897": "Buer"  // 45897 gehört auch zu Buer (wie 45894)
            };
            
            // Prüfe zuerst spezielle Zuordnungen
            if (additionalPLZMapping[normalizedPLZ]) {
                return additionalPLZMapping[normalizedPLZ];
            }
            
            // Durchsuche ZONE_POSTAL_CODES nach passender PLZ
            for(const [zone, plz] of Object.entries(ZONE_POSTAL_CODES)) {
                if(plz && String(plz).trim() === normalizedPLZ) {
                    return zone;
                }
            }
            
            // Keine Zone gefunden
            return null;
        }
        
        // Deutlich unterscheidbare Farben für jede Zone
        const ZONE_COLORS = {
            "Alt-/Neustadt": "#e11d48",  // Rot-Pink
            "Beckhausen": "#b45309",     // Braun/Terracotta
            "Bismarck": "#7c3aed",      // Violett
            "Buer": "#0891b2",          // Cyan/Türkis
            "Bulmke-Hüllen": "#059669", // Smaragdgrün
            "Erle": "#16a34a",          // Grün
            "Feldmark": "#65a30d",      // Limette
            "Hassel": "#ca8a04",        // Dunkelgelb/Gold
            "Heßler": "#ea580c",        // Orange
            "Horst": "#dc2626",         // Rot
            "Resser Mark": "#9333ea",   // Lila
            "Resse": "#2563eb",         // Blau
            "Rotthausen": "#c026d3",    // Magenta
            "Schalke": "#0284c7",       // Hellblau
            "Scholven": "#4f46e5",      // Indigo
            "Ückendorf": "#0d9488",     // Teal
            "Außerhalb": "#525252"      // Grau
        };
        
        // ============================================
        // Distanzmatrix Gelsenkirchen (in km)
        // Basierend auf geografischer Lage der Stadtteile
        // ============================================
        const ZONE_DISTANCES = {
            // Geografische Koordinaten (relativ, für Distanzberechnung)
            // Format: [x, y] wobei x=West-Ost, y=Süd-Nord
            coords: {
                "Alt-/Neustadt": [4, 3.5], // Mittelwert zwischen Altstadt [5,3] und Neustadt [3,4]
                "Beckhausen": [3.5, 8],    // Nordwesten, zwischen Buer und Scholven
                "Bismarck": [4, 5],
                "Buer": [5, 8],
                "Bulmke-Hüllen": [6, 4],
                "Erle": [6, 6],
                "Feldmark": [4, 4],
                "Hassel": [3, 8],
                "Heßler": [3, 3],
                "Horst": [2, 5],
                "Resser Mark": [6, 9],
                "Resse": [4, 9],
                "Rotthausen": [7, 2],
                "Schalke": [5, 5],
                "Scholven": [2, 8],
                "Ückendorf": [6, 3],
                "Außerhalb": [5, 5] // Zentrum als Default
            }
        };
        
        // Haversine-Formel: Berechne echte Distanz zwischen zwei GPS-Koordinaten (in km)
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Berechne Distanz zwischen zwei Events basierend auf Koordinaten oder Zonen
        function getEventDistance(event1, event2) {
            // Versuche zuerst echte Koordinaten zu nutzen
            const coords1 = event1?.extendedProps?.coordinates || event1?.extended_props?.coordinates;
            const coords2 = event2?.extendedProps?.coordinates || event2?.extended_props?.coordinates;
            
            if (coords1?.lat && coords1?.lng && coords2?.lat && coords2?.lng) {
                // Echte Koordinaten vorhanden - nutze Haversine
                const dist = calculateHaversineDistance(coords1.lat, coords1.lng, coords2.lat, coords2.lng);
                // Faktor 1.3 für Straßenumwege (Luftlinie → Fahrtstrecke)
                return Math.round(dist * 1.3 * 10) / 10;
            }
            
            // Fallback auf Zone-basierte Berechnung
            const zone1 = event1?.extendedProps?.zone || event1?.zone;
            const zone2 = event2?.extendedProps?.zone || event2?.zone;
            return getZoneDistance(zone1, zone2);
        }
        
        // Berechne Distanz zwischen zwei Zonen (in km, approximiert)
        function getZoneDistance(zone1, zone2) {
            if(!zone1 || !zone2) return 5; // Default 5km
            if(zone1 === zone2) return 1; // Innerhalb einer Zone: 1km
            if(zone1 === "Außerhalb" || zone2 === "Außerhalb") return 8; // Außerhalb: pauschal 8km
            
            const c1 = ZONE_DISTANCES.coords[zone1];
            const c2 = ZONE_DISTANCES.coords[zone2];
            if(!c1 || !c2) return 5;
            
            // Euklidische Distanz * Faktor (1 Einheit ≈ 1.2 km)
            const dx = c1[0] - c2[0];
            const dy = c1[1] - c2[1];
            const dist = Math.sqrt(dx*dx + dy*dy) * 1.2;
            
            return Math.round(dist * 10) / 10; // Auf 0.1 km runden
        }
        
        // Berechne Fahrzeit basierend auf Distanz (Stadtverkehr ~25 km/h)
        function getZoneTravelTime(zone1, zone2) {
            const dist = getZoneDistance(zone1, zone2);
            const speedKmH = appData.wageSettings?.avgSpeed || 25;
            const timeHours = dist / speedKmH;
            const timeMinutes = Math.round(timeHours * 60);
            return Math.max(timeMinutes, 3); // Mindestens 3 Minuten
        }
        
        // Farbe basierend auf Entfernung
        function getDistanceColor(distanceKm) {
            if(distanceKm <= 1.5) return '#10b981'; // Grün - sehr nah
            if(distanceKm <= 3) return '#22c55e';   // Hellgrün - nah
            if(distanceKm <= 5) return '#84cc16';   // Limette - mittel
            if(distanceKm <= 7) return '#eab308';   // Gelb - weit
            if(distanceKm <= 10) return '#f97316';  // Orange - sehr weit
            return '#ef4444';                        // Rot - extrem weit
        }
        
        // Farbe für Fahrtzeit
        function getTravelTimeColor(minutes) {
            if(minutes <= 5) return '#10b981';  // Grün
            if(minutes <= 10) return '#22c55e'; // Hellgrün
            if(minutes <= 15) return '#84cc16'; // Limette
            if(minutes <= 20) return '#eab308'; // Gelb
            if(minutes <= 30) return '#f97316'; // Orange
            return '#ef4444';                    // Rot
        }
        
        // Berechne Fahrzeit-Vorschläge basierend auf Distanz
        function calculateTravelTimeSuggestions(distanceKm) {
            if (!distanceKm || distanceKm <= 0) {
                return {
                    optimistic: 5,
                    realistic: 10,
                    pessimistic: 15,
                    distance: 0
                };
            }
            
            // Optimistisch: 30 km/h (wenig Verkehr)
            const optimisticSpeed = 30;
            const optimisticMin = Math.max(3, Math.round((distanceKm / optimisticSpeed) * 60));
            
            // Realistisch: 25 km/h (Durchschnitt Stadtverkehr)
            const realisticSpeed = 25;
            const realisticMin = Math.max(5, Math.round((distanceKm / realisticSpeed) * 60));
            
            // Pessimistisch: 20 km/h (viel Verkehr, Stau)
            const pessimisticSpeed = 20;
            const pessimisticMin = Math.max(8, Math.round((distanceKm / pessimisticSpeed) * 60));
            
            return {
                optimistic: optimisticMin,
                realistic: realisticMin,
                pessimistic: pessimisticMin,
                distance: distanceKm
            };
        }
        
        // Zeige Tooltip mit Fahrzeit-Vorschlägen
        let travelTimeTooltip = null;
        
        function showTravelTimeSuggestions(event, travelEvent, distanceKm, fromZone, toZone) {
            // Entferne vorhandenes Tooltip
            hideTravelTimeTooltip();
            
            // Sicherheitsprüfung
            if (!travelEvent || !travelEvent.start || !travelEvent.end) {
                console.warn('showTravelTimeSuggestions: Ungültige Event-Daten');
                return;
            }
            
            const suggestions = calculateTravelTimeSuggestions(distanceKm);
            const currentTime = parseTimeToMinutes(travelEvent.end) - parseTimeToMinutes(travelEvent.start);
            
            // Bewertung der aktuellen Fahrzeit
            let assessment = { text: '', color: '', icon: '' };
            if (currentTime < suggestions.optimistic) {
                assessment = { text: 'Zu knapp!', color: '#ef4444', icon: '⚠️' };
            } else if (currentTime <= suggestions.optimistic + 2) {
                assessment = { text: 'Sehr knapp', color: '#f97316', icon: '⏰' };
            } else if (currentTime <= suggestions.realistic) {
                assessment = { text: 'Realistisch', color: '#10b981', icon: '✅' };
            } else if (currentTime <= suggestions.pessimistic) {
                assessment = { text: 'Komfortabel', color: '#3b82f6', icon: '👍' };
            } else {
                assessment = { text: 'Großzügig', color: '#8b5cf6', icon: '☕' };
            }
            
            // Erstelle Tooltip mit Glassmorphism-Effekt
            travelTimeTooltip = document.createElement('div');
            travelTimeTooltip.className = 'travel-time-tooltip';
            travelTimeTooltip.style.cssText = `
                position: fixed;
                background: rgba(18, 18, 26, 0.95);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-left: 3px solid ${assessment.color};
                border-radius: 14px;
                padding: 16px 20px;
                box-shadow: 0 15px 50px rgba(0,0,0,0.5), 0 0 30px ${assessment.color}20;
                z-index: 10000;
                font-size: 0.85rem;
                min-width: 320px;
                pointer-events: none;
                color: #f0f0f5;
                animation: tooltipFadeIn 0.2s ease-out;
            `;
            
            const zoneInfo = fromZone && toZone ? 
                `<div style="margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid var(--border, #333);">
                    <strong>📍 Route:</strong> ${fromZone} → ${toZone}
                </div>` : '';
            
            // Prüfe ob Koordinaten verwendet wurden
            const usedCoords = travelEvent.extendedProps?.usedCoordinates;
            const distanceInfo = distanceKm > 0 ? 
                `<div style="margin-bottom:10px; color:var(--text-muted, #94a3b8); font-size:0.8rem;">
                    📏 Distanz: <strong>${distanceKm.toFixed(1)} km</strong>
                    ${usedCoords ? ' <span style="color:#10b981;">(GPS)</span>' : ' <span style="color:#f59e0b;">(Zone)</span>'}
                </div>` : '';
            
            travelTimeTooltip.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <span style="font-weight:700; color:var(--primary, #6366f1); font-size:0.95rem;">
                        ⏱️ Fahrzeit-Analyse
                    </span>
                    <span style="background:${assessment.color}20; color:${assessment.color}; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:600;">
                        ${assessment.icon} ${assessment.text}
                    </span>
                </div>
                ${zoneInfo}
                ${distanceInfo}
                <div style="background:var(--bg-hover, #252540); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--text-muted, #94a3b8);">🏎️ Optimistisch (30 km/h):</span>
                            <span style="font-weight:600; color:#10b981;">${suggestions.optimistic} min</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--text-muted, #94a3b8);">🚗 Realistisch (25 km/h):</span>
                            <span style="font-weight:600; color:#3b82f6;">${suggestions.realistic} min</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--text-muted, #94a3b8);">🐌 Pessimistisch (20 km/h):</span>
                            <span style="font-weight:600; color:#f59e0b;">${suggestions.pessimistic} min</span>
                        </div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding-top:8px; border-top:1px solid var(--border, #333);">
                    <span style="color:var(--text-muted, #94a3b8);">Aktuell eingeplant:</span>
                    <span style="font-weight:700; font-size:1.1rem; color:${assessment.color};">${currentTime} min</span>
                </div>
            `;
            
            document.body.appendChild(travelTimeTooltip);
            
            // Positioniere Tooltip neben dem Mauszeiger
            const x = event.clientX + 15;
            const y = event.clientY + 15;
            travelTimeTooltip.style.left = x + 'px';
            travelTimeTooltip.style.top = y + 'px';
            
            // Stelle sicher, dass Tooltip nicht außerhalb des Viewports ist
            requestAnimationFrame(() => {
                if (travelTimeTooltip) {
                    const rect = travelTimeTooltip.getBoundingClientRect();
                    if (rect.right > window.innerWidth) {
                        travelTimeTooltip.style.left = (event.clientX - rect.width - 15) + 'px';
                    }
                    if (rect.bottom > window.innerHeight) {
                        travelTimeTooltip.style.top = (event.clientY - rect.height - 15) + 'px';
                    }
                }
            });
        }
        
        function hideTravelTimeTooltip() {
            if (travelTimeTooltip) {
                travelTimeTooltip.remove();
                travelTimeTooltip = null;
            }
        }
        const COLORS = { care: '#3b82f6', house: '#10b981', social: '#f59e0b', other: '#6b7280' };
        const DEFAULT_DURATION_MIN = 60;
        const TIMELINE_START_HOUR = 7;  // 7:00
        const TIMELINE_END_HOUR = 22;   // 22:00
        const TIMELINE_HOURS = TIMELINE_END_HOUR - TIMELINE_START_HOUR; // 15 hours
        
        // Weitere Konstanten
        const UNDO_STACK_MAX_SIZE = 10;
        const TARGET_WORKLOAD_HOURS = 8;
        const TARGET_WORKLOAD_MINUTES = TARGET_WORKLOAD_HOURS * 60;
        const SAVE_DEBOUNCE_MS = 800;
        
        // Default wage settings
        const DEFAULT_WAGE_SETTINGS = {
            wageGroups: [
                { id: 'fachkraft', name: 'Fachkraft', hourlyRate: 18.00 },
                { id: 'hilfskraft', name: 'Hilfskraft', hourlyRate: 14.00 },
                { id: 'azubi', name: 'Auszubildende/r', hourlyRate: 10.00 }
            ],
            surcharges: {
                sunday: 25,      // % Sonntagszuschlag
                holiday: 100,    // % Feiertagszuschlag
                night: 25        // % Nachtzuschlag (20:00-06:00)
            },
            revenueRates: {
                care: 45.00,     // €/h Pflege
                house: 35.00,    // €/h Hauswirtschaft
                social: 40.00   // €/h Betreuung
            },
            avgSpeed: 30,        // km/h Durchschnittsgeschwindigkeit
            kmRate: 0.30,        // €/km PKW
            publicTransportMonthly: 30.00, // €/Monat Öffis
            employerFactor: 1.5, // Arbeitgeberfaktor (50% AG-Anteil)
            targetMargin: 50     // Zielmarge in %
        };
        
        // ============================================
        // IndexedDB Storage System
        // ============================================
        const DB_NAME = 'TourenplanungDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'appData';
        let db = null;
        const TEMPLATE_FALLBACK_KEY = 'weekTemplates';
        const FILTER_PRESET_FALLBACK_KEY = 'filterPresets';
        let templateCache = [];
        let filterPresetCache = [];
        // API Configuration
        const API_BASE_URL = window.location.origin;
        
        // API-Call Funktion (vereinfacht ohne Auth)
        async function apiCall(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (currentVariantId) {
                headers['X-Variant-ID'] = currentVariantId.toString();
            }
            
            const response = await fetch(`${API_BASE_URL}${url}`, {
                ...options,
                headers
            });
            
            return response;
        }
        
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (e) => {
                    console.error('IndexedDB Fehler:', e.target.error);
                    reject(e.target.error);
                };
                
                request.onsuccess = (e) => {
                    db = e.target.result;
                    console.log('IndexedDB geöffnet');
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    
                    // Hauptdaten-Store
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'key' });
                    }
                    
                    // Templates-Store
                    if (!database.objectStoreNames.contains('templates')) {
                        database.createObjectStore('templates', { keyPath: 'id' });
                    }
                    
                    // Filter-Presets-Store
                    if (!database.objectStoreNames.contains('filterPresets')) {
                        database.createObjectStore('filterPresets', { keyPath: 'id' });
                    }
                    
                    if (!database.objectStoreNames.contains('settings')) {
                        database.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    console.log('IndexedDB Schema erstellt/aktualisiert');
                };
            });
        }
        
        async function dbSave(storeName, key, data) {
            if (!db) await openDatabase();
            
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    
                    let item;
                    if (storeName === STORE_NAME) {
                        item = { key: key, data: data, timestamp: Date.now() };
                    } else if (storeName === 'settings') {
                        item = { key: key, ...data };
                    } else {
                        item = { ...data, id: data.id || key };
                    }
                    
                    const request = store.put(item);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = (e) => {
                        console.error('DB Save Error:', e.target.error);
                        reject(e.target.error);
                    };
                } catch (e) {
                    console.error('DB Save Exception:', e);
                    reject(e);
                }
            });
        }
        
        async function dbLoad(storeName, key) {
            if (!db) await openDatabase();
            
            return new Promise((resolve, reject) => {
                try {
                    // Check if object store exists
                    if (!db.objectStoreNames.contains(storeName)) {
                        console.warn(`ObjectStore "${storeName}" nicht gefunden, versuche Upgrade...`);
                        resolve(null);
                        return;
                    }
                    
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.get(key);
                    
                    request.onsuccess = (e) => {
                        const result = e.target.result;
                        resolve(result ? (storeName === STORE_NAME ? result.data : result) : null);
                    };
                    
                    request.onerror = (e) => {
                        console.error('DB Load Error:', e.target.error);
                        resolve(null); // Return null instead of rejecting
                    };
                } catch (e) {
                    console.error('DB Load Exception:', e);
                    reject(e);
                }
            });
        }
        
        async function dbLoadAll(storeName) {
            if (!db) await openDatabase();
            
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = (e) => resolve(e.target.result || []);
                    request.onerror = (e) => {
                        console.error('DB LoadAll Error:', e.target.error);
                        reject(e.target.error);
                    };
                } catch (e) {
                    console.error('DB LoadAll Exception:', e);
                    reject(e);
                }
            });
        }
        
        async function dbDelete(storeName, key) {
            if (!db) await openDatabase();
            
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = (e) => {
                        console.error('DB Delete Error:', e.target.error);
                        reject(e.target.error);
                    };
                } catch (e) {
                    console.error('DB Delete Exception:', e);
                    reject(e);
                }
            });
        }
        
        async function dbClear(storeName) {
            if (!db) await openDatabase();
            
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = (e) => {
                        console.error('DB Clear Error:', e.target.error);
                        reject(e.target.error);
                    };
                } catch (e) {
                    console.error('DB Clear Exception:', e);
                    reject(e);
                }
            });
        }
        
        // Initialize IndexedDB on page load
        openDatabase().then(() => {
            console.log('IndexedDB bereit');
        }).catch(err => {
            console.warn('IndexedDB nicht verfügbar, nutze localStorage als Fallback');
        });
        
        // ============================================
        // End IndexedDB System
        // ============================================
        
        let currentView = 'week'; // 'week', 'compare', 'overall', 'dashboard', or 'admin'
        let currentAdminTab = 'tours'; // 'tours', 'employees', 'wages', 'customers', 'events', 'templates', 'copyday'
        let currentCompareDayIndex = 0; // 0=Montag, 1=Dienstag, etc.
        let currentVariantId = null; // Aktuelle Varianten-ID
        let variants = []; // Liste aller Varianten
        let contextMenuEvent = null; // Globale Variable für Context-Menu Event
        let appData = { 
            events: [], 
            pool: [], 
            employees: [], 
            tours: [{id:'t1', name:'Tour 1'}, {id:'t2', name:'Tour 2'}],
            wageSettings: JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS))
        };
        let currentEvent, fileHandle, saveTimeout;
        let undoStack = []; // For undo functionality
        let searchTerm = ''; // For search filter
        let selectedEvents = new Set(); // For multi-select with Ctrl
        let typeFilter = 'all'; // For type filter
        let zoomLevel = 15; // 15 = 15min steps (1px/min), 5 = 5min steps (3px/min)
        let overallDayFilter = [0, 1, 2, 3, 4, 5, 6]; // Filter für Wochentage in Gesamtansicht (alle Tage standardmäßig)
        let overallTourFilter = []; // Filter für Touren in Gesamtansicht (leer = alle Touren)
        
        function getPixelsPerMinute() {
            return zoomLevel === 5 ? 3 : 1; // 5min zoom = 3px/min, 15min zoom = 1px/min
        }
        
        function getSnapMinutes() {
            return zoomLevel; // 5 or 15 minutes
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2); }

        // --- CONFLICT DETECTION ---
        function checkOverlap(events, newEvent, excludeId = null) {
            const newStart = parseTimeToMinutes(newEvent.start);
            const newEnd = parseTimeToMinutes(newEvent.end);
            const newDay = newEvent.dayIndex;
            const newRhythm = newEvent.extendedProps?.rhythm || 'weekly';
            const newTour = newEvent.extendedProps?.tour;
            
            const conflicts = [];
            
            events.forEach(evt => {
                if(evt.id === excludeId) return; // Skip self
                if(evt.extendedProps?.isTravel) return; // Skip travel
                if(evt.dayIndex !== newDay) return; // Different day
                
                // Only check conflicts within the same tour
                const evtTour = evt.extendedProps?.tour;
                if(newTour && evtTour && newTour !== evtTour) return; // Different tours - no conflict
                
                const evtStart = parseTimeToMinutes(evt.start);
                const evtEnd = parseTimeToMinutes(evt.end);
                const evtRhythm = evt.extendedProps?.rhythm || 'weekly';
                
                // Check if times overlap
                const overlaps = (newStart < evtEnd && newEnd > evtStart);
                
                if(overlaps) {
                    // Allow overlap if BOTH are biweekly (different weeks)
                    if(newRhythm === 'biweekly' && evtRhythm === 'biweekly') {
                        return; // Allow - they're on alternating weeks
                    }
                    // Allow overlap if BOTH are fourweekly (different 4-week cycles)
                    if(newRhythm === 'fourweekly' && evtRhythm === 'fourweekly') {
                        return; // Allow - they're on different 4-week cycles
                    }
                    conflicts.push(evt);
                }
            });
            
            return conflicts;
        }

        function getEventConflicts(evt, allEvents) {
            return checkOverlap(allEvents, evt, evt.id);
        }

        // ============================================
        // EVENT FILTER HELPER FUNCTIONS
        // ============================================
        /**
         * Filtert echte Einsätze (keine Fahrzeiten)
         */
        function filterRealEvents(events) {
            return events.filter(e => !e.extendedProps?.isTravel);
        }

        /**
         * Filtert gültige Einsätze (mit dayIndex, keine Fahrzeiten)
         */
        function filterValidEvents(events) {
            return events.filter(e => 
                !e.extendedProps?.isTravel && 
                e.dayIndex !== undefined && 
                e.dayIndex >= 0 && 
                e.dayIndex <= 6
            );
        }

        /**
         * Prüft ob dayIndex gültig ist
         */
        function isValidDayIndex(dayIndex) {
            return dayIndex !== undefined && dayIndex >= 0 && dayIndex <= 6;
        }

        // ============================================
        // DURATION CALCULATION (biweekly = half duration, fourweekly = quarter duration)
        // ============================================
        function getEventDuration(evt) {
            const duration = parseTimeToMinutes(evt.end) - parseTimeToMinutes(evt.start);
            // 2-wöchentliche Einsätze nur halb zählen
            if(evt.extendedProps?.rhythm === 'biweekly') {
                return duration / 2;
            }
            // 4-wöchentliche Einsätze nur ein Viertel zählen
            if(evt.extendedProps?.rhythm === 'fourweekly') {
                return duration / 4;
            }
            return duration;
        }

        // ============================================
        // WORKLOAD CALCULATION
        // ============================================
        function calculateWorkload(events, dayIndex) {
            const dayEvents = filterRealEvents(events.filter(e => e.dayIndex === dayIndex));
            let totalMin = 0;
            dayEvents.forEach(e => {
                totalMin += getEventDuration(e);
            });
            return {
                minutes: totalMin,
                percent: Math.round((totalMin / TARGET_WORKLOAD_MINUTES) * 100),
                level: totalMin < TARGET_WORKLOAD_MINUTES * 0.8 ? 'low' : (totalMin <= TARGET_WORKLOAD_MINUTES ? 'medium' : 'high')
            };
        }

        // ============================================
        // UNDO FUNCTIONALITY
        // ============================================
        function saveUndoState() {
            const state = JSON.stringify(appData);
            undoStack.push(state);
            if(undoStack.length > UNDO_STACK_MAX_SIZE) undoStack.shift();
        }

        // undo, toggleSidebar, toggleToolbarGroup, closeToolbarGroups wurden bereits oben definiert

        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        // Close toolbar dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.toolbar-group')) {
                closeToolbarGroups();
            }
        });

        // Sidebar-Zustand beim Laden wiederherstellen
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('mainSidebar');
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (sidebar && savedState === 'true' && window.innerWidth > 768) {
                sidebar.classList.add('collapsed');
            }
        });
        
        // Mobile Menu Button hinzufügen
        function addMobileMenuButton() {
            if (window.innerWidth <= 768) {
                let menuBtn = document.getElementById('mobileMenuBtn');
                if (!menuBtn) {
                    menuBtn = document.createElement('button');
                    menuBtn.id = 'mobileMenuBtn';
                    menuBtn.className = 'mobile-menu-btn';
                    menuBtn.innerHTML = '☰';
                    menuBtn.onclick = toggleMobileMenu;
                    document.body.appendChild(menuBtn);
                }
            } else {
                const menuBtn = document.getElementById('mobileMenuBtn');
                if (menuBtn) {
                    menuBtn.remove();
                }
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('open');
                }
            }
        }
        
        // Touch-Gesten für Sidebar schließen
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth <= 768 && sidebar && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && !e.target.closest('.mobile-menu-btn')) {
                    sidebar.classList.remove('open');
                }
            }
        });
        
        // Swipe-Gesten für Events (optional)
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', (e) => {
            if (!touchStartX || !touchStartY) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            // Horizontaler Swipe (links/rechts) - für zukünftige Navigation
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                // Könnte für Wochensprung verwendet werden
            }
            
            touchStartX = 0;
            touchStartY = 0;
        });

        document.addEventListener('DOMContentLoaded', async () => {
        initTheme();
            populateZones();
            populatePoolZoneFilter();
            renderZoneLegend();
            
            
            // Mobile Menu Button
            addMobileMenuButton();
            window.addEventListener('resize', addMobileMenuButton);
            
            // Lade Varianten und setze Standard-Variante
            try {
                await loadVariants();
                if (variants.length > 0 && !currentVariantId) {
                    currentVariantId = variants[0].id;
                }
                updateVariantSelect();
            } catch(e) {
                console.error('Fehler beim Laden der Varianten:', e);
                showToast('Fehler beim Laden der Varianten', 'error');
            }
            
            // Load data from API
            if (currentVariantId) {
                try {
                    await loadFromAPI();
                } catch(e) {
                    console.error('Fehler beim Laden der Daten:', e);
                    showToast('Fehler beim Laden der Daten vom Server', 'error');
                    // Fallback: use empty data structure
                    appData = {
                        events: [],
                        pool: [],
                        employees: [],
                        tours: [{id:'t1', name:'Tour 1'}, {id:'t2', name:'Tour 2'}],
                        wageSettings: JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS)),
                        favorites: []
                    };
                }
            }
            
            await loadTemplatesFromStorage();
            await loadFilterPresetsFromStorage();
        refreshUI(); // Hier wird renderPool() aufgerufen
            if (typeof updatePatientList === 'function') updatePatientList();
            if (typeof renderFilterPresetSelect === 'function') renderFilterPresetSelect();
        // HINWEIS: switchView wird im späteren DOMContentLoaded Handler aufgerufen,
            // nachdem refreshView definiert wurde (siehe weiter unten im Code)
        });
        
        async function loadTemplatesFromStorage() {
            try {
                const records = await dbLoadAll('templates');
                templateCache = (records || []).map(r => ({ ...r }));
                
                if(templateCache.length === 0) {
                    const fallback = localStorage.getItem(TEMPLATE_FALLBACK_KEY);
                    if(fallback) {
                        templateCache = JSON.parse(fallback);
                        try {
                            await dbClear('templates');
                            for(const tmpl of templateCache) {
                                await dbSave('templates', tmpl.id, tmpl);
                            }
                        } catch(e) {
                            console.warn('Templates Migration fehlgeschlagen:', e);
                        }
                    }
                }
            } catch (e) {
                console.warn('Templates laden fehlgeschlagen:', e);
                try {
                    templateCache = JSON.parse(localStorage.getItem(TEMPLATE_FALLBACK_KEY) || '[]');
                } catch {
                    templateCache = [];
                }
            }
        }
        
        async function loadFilterPresetsFromStorage() {
            try {
                const records = await dbLoadAll('filterPresets');
                filterPresetCache = (records || []).map(r => ({ ...r }));
                
                if(filterPresetCache.length === 0) {
                    const fallback = localStorage.getItem(FILTER_PRESET_FALLBACK_KEY);
                    if(fallback) {
                        filterPresetCache = JSON.parse(fallback);
                        try {
                            await dbClear('filterPresets');
                            for(const preset of filterPresetCache) {
                                await dbSave('filterPresets', preset.id, preset);
                            }
                        } catch(e) {
                            console.warn('Filter-Presets Migration fehlgeschlagen:', e);
                        }
                    }
                }
            } catch (e) {
                console.warn('Filter-Presets laden fehlgeschlagen:', e);
                try {
                    filterPresetCache = JSON.parse(localStorage.getItem(FILTER_PRESET_FALLBACK_KEY) || '[]');
                } catch {
                    filterPresetCache = [];
                }
            }
        }
        
        // --- THEME ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            // Default ist jetzt 'dark' für das moderne Devin-Style Design
            const theme = savedTheme || 'dark';
            setTheme(theme);
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeButton(theme);
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            showToast(newTheme === 'dark' ? 'Dunkelmodus aktiviert' : 'Hellmodus aktiviert', 'info');
        }
        
        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if(icon) icon.textContent = theme === 'dark' ? '☀️' : '🌙';
            if(text) text.textContent = theme === 'dark' ? 'Hellmodus' : 'Dunkelmodus';
        }
        
        // --- TEMPLATES ---
        function getTemplates() {
            return templateCache || [];
        }
        
        async function saveTemplates(templates) {
            templateCache = templates.slice();
            try {
                await dbClear('templates');
                for (const t of templateCache) {
                    await dbSave('templates', t.id, t);
                }
            } catch(e) {
                console.warn('Templates IndexedDB Speichern fehlgeschlagen:', e);
                try {
                    localStorage.setItem(TEMPLATE_FALLBACK_KEY, JSON.stringify(templateCache));
                } catch(storageError) {
                    console.warn('Templates LocalStorage Fallback fehlgeschlagen:', storageError);
                }
            }
        }
        
        async function saveTemplate() {
            const nameInput = document.getElementById('templateName');
            const name = nameInput?.value.trim();
            if(!name) {
                showToast('Bitte einen Namen eingeben', 'warning');
                return;
            }
            
            const template = {
                id: generateId(),
                name: name,
                createdAt: new Date().toISOString(),
                events: appData.events.map(e => ({
                    title: e.title,
                    start: e.start,
                    end: e.end,
                    dayIndex: e.dayIndex,
                    extendedProps: { ...e.extendedProps }
                }))
            };
            
            const templates = getTemplates();
            templates.push(template);
            await saveTemplates(templates);
            
            nameInput.value = '';
            renderTemplateList();
            showToast(`Vorlage "${name}" gespeichert`, 'success');
        }
        
        function loadTemplate(id) {
            const templates = getTemplates();
            const template = templates.find(t => t.id === id);
            if(!template) return;
            
            if(!confirm(`Vorlage "${template.name}" laden? Aktuelle Einsätze werden ersetzt.`)) return;
            
            saveUndoState();
            
            // Clear current events and load template
            appData.events = template.events.map(e => ({
                ...e,
                id: generateId(),
                extendedProps: { ...e.extendedProps }
            }));
            
            queueSave();
            refreshView();
            closeModal('templateModal');
            showToast(`Vorlage "${template.name}" geladen`, 'success');
        }
        
        async function deleteTemplate(id) {
            const templates = getTemplates();
            const template = templates.find(t => t.id === id);
            if(!template) return;
            
            if(!confirm(`Vorlage "${template.name}" löschen?`)) return;
            
            await saveTemplates(templates.filter(t => t.id !== id));
            renderTemplateList();
            showToast('Vorlage gelöscht', 'success');
        }
        
        function renderTemplateList() {
            const container = document.getElementById('templateList');
            if(!container) return;
            
            const templates = getTemplates();
            
            if(templates.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted); font-size:0.85rem;">Keine Vorlagen gespeichert</div>';
                return;
            }
            
            container.innerHTML = templates.map(t => `
                <div class="item-list-entry" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${t.name}</strong>
                        <div style="font-size:0.75rem; color:var(--text-muted);">${t.events.length} Einsätze • ${new Date(t.createdAt).toLocaleDateString('de-DE')}</div>
                    </div>
                    <div style="display:flex; gap:4px;">
                        <button class="btn btn-primary" style="padding:6px 12px; font-size:0.75rem; width:auto; margin:0;" onclick="loadTemplate('${t.id}')">Laden</button>
                        <button class="btn btn-danger" style="padding:6px 10px; font-size:0.75rem; width:auto; margin:0;" onclick="deleteTemplate('${t.id}')">×</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Render template list when modal opens
        const origOpenModal = openModal;
        openModal = function(id) {
            origOpenModal(id);
            if(id === 'templateModal') renderTemplateList();
        };

        function populateZones() { 
            ['poolZone','eventZone'].forEach(id=>{ 
                const s=document.getElementById(id); 
                if(!s) return;
                s.innerHTML=''; 
                CITY_ZONES.forEach(z=>{
                    const o=document.createElement('option');
                    o.value = z;
                    o.text = getZoneWithPostalCode(z);
                    s.add(o);
                });
            }); 
        }
        
        function populatePoolZoneFilter() {
            const filter = document.getElementById('poolZoneFilter');
            if(!filter) return;
            filter.innerHTML = '<option value="">Alle Zonen</option>';
            CITY_ZONES.forEach(z => {
                const opt = document.createElement('option');
                opt.value = z;
                opt.textContent = getZoneWithPostalCode(z);
                filter.appendChild(opt);
            });
        }

        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if(!container) return;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${message}</span>`;
            
            container.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // --- VARIANTEN FUNKTIONEN ---
        async function loadVariants() {
            try {
                const response = await apiCall('/api/variants');
                if(!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                variants = await response.json();
                console.log('Varianten geladen:', variants);
            } catch(e) {
                console.error('Fehler beim Laden der Varianten:', e);
                throw e;
            }
        }
        
        function updateVariantSelect() {
            const select = document.getElementById('variantSelect');
            if (!select) return;
            
            select.innerHTML = '';
            variants.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.id;
                option.textContent = variant.name;
                if (variant.id === currentVariantId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function ensureAppDataDefaults() {
            if(!appData.pool) appData.pool = [];
            if(!appData.events) appData.events = [];
            if(!appData.tours || appData.tours.length === 0) appData.tours = [{id:'t1', name:'Tour 1'}, {id:'t2', name:'Tour 2'}];
            if(!appData.employees) appData.employees = [];
            if(!appData.wageSettings) appData.wageSettings = JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS));
            if(!appData.favorites) appData.favorites = [];
            return appData;
        }
        
        function migrateZoneNames() {
            let changed = false;
            
            // Migrate events
            if(appData.events) {
                appData.events.forEach(evt => {
                    if(evt.extendedProps?.zone === 'Altstadt' || evt.extendedProps?.zone === 'Neustadt') {
                        evt.extendedProps.zone = 'Alt-/Neustadt';
                        changed = true;
                    }
                });
            }
            
            // Migrate pool
            if(appData.pool) {
                appData.pool.forEach(item => {
                    if(item.zone === 'Altstadt' || item.zone === 'Neustadt') {
                        item.zone = 'Alt-/Neustadt';
                        changed = true;
                    }
                });
            }
            
            // Migrate employees homeZone
            if(appData.employees) {
                appData.employees.forEach(emp => {
                    if(emp.homeZone === 'Altstadt' || emp.homeZone === 'Neustadt') {
                        emp.homeZone = 'Alt-/Neustadt';
                        changed = true;
                    }
                });
            }
            
            if(changed) {
                queueSave();
                console.log('Zonen migriert: Altstadt/Neustadt → Alt-/Neustadt');
            }
        }
        
        function cleanupInvalidEvents() {
            if(!appData.events) return;
            
            const initialCount = appData.events.length;
            // Entferne Einsätze ohne dayIndex oder mit ungültigem dayIndex
            appData.events = appData.events.filter(evt => {
                // Behalte nur Einsätze mit gültigem dayIndex (0-6)
                return evt && 
                       evt.dayIndex !== undefined && 
                       evt.dayIndex >= 0 && 
                       evt.dayIndex <= 6;
            });
            
            const removedCount = initialCount - appData.events.length;
            if(removedCount > 0) {
                console.log(`${removedCount} veraltete Einsätze ohne gültigen dayIndex wurden entfernt`);
                queueSave();
            }
        }
        
        function updateTourEmployeeDisplay() {
            const display = document.getElementById('tourEmployeeDisplay');
            const tourSelect = document.getElementById('tourSelect');
            if(!display || !tourSelect) return;
            
            const selectedTourId = tourSelect.value;
            if(!selectedTourId) {
                display.style.display = 'none';
                return;
            }
            
            const tour = appData.tours.find(t => t.id === selectedTourId);
            if(tour && tour.employeeId) {
                const employee = appData.employees.find(e => e.id === tour.employeeId);
                if(employee) {
                    display.textContent = `👤 ${employee.name}`;
                    display.style.display = 'inline-block';
                    return;
                }
            }
            
            // Kein Mitarbeiter zugewiesen
            display.style.display = 'none';
        }
        
        function setZoom(level) {
            zoomLevel = level;
            document.getElementById('btnZoom15')?.classList.toggle('active', level === 15);
            document.getElementById('btnZoom5')?.classList.toggle('active', level === 5);
            if (typeof refreshView === 'function') refreshView();
        }
        
        async function duplicateVariant(sourceVariantId, newName) {
            if (!sourceVariantId) {
                if (typeof showToast === 'function') showToast('Keine Variante zum Duplizieren ausgewählt', 'error');
                return;
            }
            
            if (!newName || newName.trim() === '') {
                if (typeof showToast === 'function') showToast('Variantenname ist erforderlich', 'error');
                return;
            }
            
            try {
                const response = await apiCall(`/api/variants/${sourceVariantId}/duplicate`, {
                    method: 'POST',
                    body: JSON.stringify({ name: newName.trim() })
                });
                
                if(!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Fehler beim Duplizieren');
                }
                
                const newVariant = await response.json();
                variants.push(newVariant);
                if (typeof updateVariantSelect === 'function') updateVariantSelect();
                
                // Wechsle zur neuen Variante
                currentVariantId = newVariant.id;
                const select = document.getElementById('variantSelect');
                if (select) select.value = newVariant.id;
                
                // Lade Daten der neuen Variante
                await loadFromAPI();
                if (typeof refreshUI === 'function') refreshUI();
                if (typeof updatePatientList === 'function') updatePatientList();
                
                if (typeof showToast === 'function') showToast('Variante erfolgreich dupliziert', 'success');
            } catch(e) {
                console.error('Fehler beim Duplizieren der Variante:', e);
                if (typeof showToast === 'function') showToast(e.message || 'Fehler beim Duplizieren der Variante', 'error');
            }
        }
        
        function handleDuplicateVariant(sourceVariantId) {
            if (!sourceVariantId) {
                if (typeof showToast === 'function') showToast('Keine Variante zum Duplizieren ausgewählt', 'error');
                return;
            }
            
            const sourceVariant = variants.find(v => v.id === sourceVariantId);
            const sourceName = sourceVariant ? sourceVariant.name : 'Variante';
            const defaultName = `${sourceName} (Kopie)`;
            
            if (typeof showInputModal === 'function') {
                showInputModal('Variante duplizieren', 'Name der neuen Variante:', defaultName, (newName) => {
                    if (!newName || newName.trim() === '') return;
                    duplicateVariant(sourceVariantId, newName.trim());
                });
            }
        }
        
        // ============================================
        // GLOBALE FUNKTIONEN FÜR HTML-ONCLICK-HANDLER
        // ============================================
        // Diese Funktionen müssen vor dem HTML-Teil definiert sein,
        // da sie direkt per onclick-Attribute aufgerufen werden.
        
        // --- EINFACHE UI-FUNKTIONEN ---
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                // Speichere Zustand in localStorage
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            }
        }
        
        function toggleToolbarGroup(group) {
            if (typeof closeToolbarGroups === 'function') closeToolbarGroups();
            const dropdown = document.getElementById(`toolbarDropdown${group.charAt(0).toUpperCase() + group.slice(1)}`);
            if (dropdown) {
                dropdown.classList.add('show');
            }
        }
        
        function closeToolbarGroups() {
            document.querySelectorAll('.toolbar-dropdown').forEach(dropdown => dropdown.classList.remove('show'));
        }
        
        function toggleMenuSection(section) {
            const content = document.getElementById('menu' + section.charAt(0).toUpperCase() + section.slice(1));
            const toggle = document.getElementById('toggle' + section.charAt(0).toUpperCase() + section.slice(1));
            if(!content) return;
            
            // menuSectionState sollte global sein
            if (typeof menuSectionState === 'undefined') {
                window.menuSectionState = window.menuSectionState || {};
            }
            
            menuSectionState[section] = !menuSectionState[section];
            const isOpen = menuSectionState[section];
            
            if(section === 'pool') {
                // Pool section has special handling for flex layout
                content.style.display = isOpen ? 'flex' : 'none';
            } else if(section === 'zones') {
                content.style.display = isOpen ? 'block' : 'none';
            } else {
                content.style.display = isOpen ? 'block' : 'none';
            }
            
            if(toggle) {
                toggle.textContent = isOpen ? '▼' : '▶';
            }
        }
        
        function toggleNavGroup(group) {
            if (typeof closeNavGroups === 'function') closeNavGroups();
            const btn = document.getElementById(`navGroup${group.charAt(0).toUpperCase() + group.slice(1)}`);
            const dropdown = document.getElementById(`navDropdown${group.charAt(0).toUpperCase() + group.slice(1)}`);
            if (btn && dropdown) {
                btn.classList.add('open');
                dropdown.classList.add('show');
            }
        }
        
        function closeNavGroups() {
            document.querySelectorAll('.nav-group-btn').forEach(btn => btn.classList.remove('open'));
            document.querySelectorAll('.nav-dropdown').forEach(dropdown => dropdown.classList.remove('show'));
        }
        
        function switchView(view) {
        currentView = view;
            
            // Remove active from all navigation items
            document.querySelectorAll('.nav-dropdown-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-group-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('open');
            });
            
            // Set active state
            let btnId = 'btnViewWeek';
            let groupBtnId = null;
            if(view === 'compare') {
                btnId = 'btnViewCompare';
                groupBtnId = 'navGroupAnalysis';
            } else if(view === 'overall') {
                btnId = 'btnViewOverall';
                groupBtnId = 'navGroupPlanning';
            } else if(view === 'admin') {
                btnId = 'btnViewAdmin';
                groupBtnId = 'btnViewAdmin';
            } else if(view === 'dashboard') {
                btnId = 'btnViewDashboard';
                groupBtnId = 'navGroupAnalysis';
            } else if(view === 'week') {
                btnId = 'btnViewWeek';
                groupBtnId = 'navGroupPlanning';
            }
            
            const item = document.getElementById(btnId);
            if (item) {
                item.classList.add('active');
            }
            
            if (groupBtnId) {
                const groupBtn = document.getElementById(groupBtnId);
                if (groupBtn) {
                    groupBtn.classList.add('active');
                }
            }
            
            const weekControls = document.getElementById('weekControls');
            if (weekControls) weekControls.style.display = view === 'week' ? 'flex' : 'none';
            const compareControls = document.getElementById('compareControls');
            if (compareControls) compareControls.style.display = view === 'compare' ? 'flex' : 'none';
            const overallControls = document.getElementById('overallControls');
            if(overallControls) {
                overallControls.style.display = view === 'overall' ? 'flex' : 'none';
                if(view === 'overall') {
                    if (typeof populateOverallTourFilter === 'function') populateOverallTourFilter();
                    // Aktualisiere Checkbox-Styles für Tage nach kurzer Verzögerung
                    setTimeout(() => {
                        if (typeof updateOverallDayFilter === 'function') updateOverallDayFilter();
                    }, 100);
                }
            }
            
            if (typeof refreshView === 'function') refreshView();
            
            // Stelle sicher, dass main-content Overflow korrekt ist
            const mainContent = document.querySelector('.main-content');
            const container = document.getElementById('weekView');
            
            if(mainContent) {
                if(view === 'overall') {
                    // In Gesamtansicht: main-content soll NICHT scrollen, nur der Container
                    mainContent.style.overflowX = 'visible';
                    mainContent.style.overflowY = 'auto';
                } else {
                    // Reset main-content styles für andere Views
                    mainContent.style.overflowX = 'visible';
                    mainContent.style.overflowY = 'auto';
                }
            }
            
            // Reset container styles wenn nicht in overall view
            if(container && view !== 'overall') {
                container.style.width = '';
                container.style.minWidth = '';
                container.style.maxWidth = '';
                container.style.overflowX = '';
                container.style.overflowY = '';
                // Stelle sicher, dass Parent-Container auch zurückgesetzt wird
                const parent = container.parentElement;
                if(parent) {
                    parent.style.overflowX = '';
                    parent.style.minWidth = '';
                }
            }
        }
        function undo() {
            if(undoStack.length === 0) {
                if (typeof showToast === 'function') showToast('Nichts zum Rückgängigmachen', 'info');
                return;
            }
            const state = undoStack.pop();
            appData = JSON.parse(state);
            if (typeof queueSave === 'function') queueSave();
            if (typeof refreshUI === 'function') refreshUI();
            if (typeof showToast === 'function') showToast('Rückgängig gemacht', 'success');
        }
        
        // contextMenuEvent ist bereits oben als globale Variable deklariert
        
        // --- CONTEXT-MENU-FUNKTIONEN ---
        function contextMenuEdit() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToEdit = contextMenuEvent;
            if (typeof hideContextMenu === 'function') hideContextMenu();
            if(!eventToEdit) return;
            if (typeof openEventModal === 'function') openEventModal(eventToEdit);
        }
        
        function contextMenuDuplicate() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToDuplicate = contextMenuEvent;
            if (typeof hideContextMenu === 'function') hideContextMenu();
            if(!eventToDuplicate) return;
            
            const newEvent = {
                id: typeof generateId === 'function' ? generateId() : Date.now().toString(36) + Math.random().toString(36).substring(2),
                title: eventToDuplicate.title,
                start: eventToDuplicate.start,
                end: eventToDuplicate.end,
                dayIndex: eventToDuplicate.dayIndex,
                extendedProps: { ...eventToDuplicate.extendedProps }
            };
            appData.events.push(newEvent);
            if (typeof queueSave === 'function') queueSave();
            if (typeof refreshView === 'function') refreshView();
            if (typeof showToast === 'function') showToast('Einsatz dupliziert', 'success');
        }
        
        function contextMenuToPool() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToMove = contextMenuEvent;
            if (typeof hideContextMenu === 'function') hideContextMenu();
            if(!eventToMove) return;
            
            if (typeof clearAllTooltips === 'function') clearAllTooltips(); // Clear tooltips before removing elements
            // Small delay to ensure browser processes tooltip removal
            setTimeout(() => {
                if (typeof saveUndoState === 'function') saveUndoState();
                appData.pool.push({
                    id: typeof generateId === 'function' ? generateId() : Date.now().toString(36) + Math.random().toString(36).substring(2),
                    title: eventToMove.title,
                    zone: eventToMove.extendedProps?.zone || 'Alt-/Neustadt',
                    types: eventToMove.extendedProps?.types || ['other']
                });
                appData.events = appData.events.filter(e => e.id !== eventToMove.id);
                if (typeof queueSave === 'function') queueSave();
                if (typeof renderPool === 'function') renderPool();
                if (typeof refreshView === 'function') refreshView();
                if (typeof showToast === 'function') showToast('In Pool verschoben', 'success');
            }, 10);
        }
        
        function contextMenuDelete() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToDelete = contextMenuEvent;
            if (typeof hideContextMenu === 'function') hideContextMenu();
            if(!eventToDelete) return;
            
            if (typeof showConfirmInputModal === 'function') {
                showConfirmInputModal('Einsatz löschen', 'Möchten Sie diesen Einsatz wirklich löschen?', () => {
                    if (typeof clearAllTooltips === 'function') clearAllTooltips();
                    setTimeout(() => {
                        if (typeof saveUndoState === 'function') saveUndoState();
                        appData.events = appData.events.filter(e => e.id !== eventToDelete.id);
                        if (typeof queueSave === 'function') queueSave();
                        if (typeof refreshView === 'function') refreshView();
                        if (typeof showToast === 'function') showToast('Einsatz gelöscht', 'success');
                    }, 10);
                });
            }
        }
        
        // --- FILTER & TOOLS ---
        function toggleFilterGroup(group) {
            const toggle = document.getElementById(`filterToggle${group.charAt(0).toUpperCase() + group.slice(1)}`);
            const dropdown = document.getElementById(`filterDropdown${group.charAt(0).toUpperCase() + group.slice(1)}`);
            if (toggle && dropdown) {
                const isOpen = toggle.classList.contains('open');
                if (typeof closeFilterGroups === 'function') closeFilterGroups();
                if (!isOpen) {
                    toggle.classList.add('open');
                    dropdown.classList.add('show');
                }
            }
        }
        
        function selectAllDays() {
            const checkboxes = document.querySelectorAll('#overallControls .day-checkbox-compact input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const label = cb.closest('.day-checkbox-compact');
                if(label) {
                    label.style.borderColor = 'var(--primary)';
                    label.style.background = 'var(--primary-light)';
                    label.style.color = 'var(--primary)';
                }
            });
            if (typeof updateOverallDayFilter === 'function') updateOverallDayFilter();
        }
        
        function deselectAllDays() {
            const checkboxes = document.querySelectorAll('#overallControls .day-checkbox-compact input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                const label = cb.closest('.day-checkbox-compact');
                if(label) {
                    label.style.borderColor = 'var(--border)';
                    label.style.background = 'var(--bg-hover)';
                    label.style.color = 'var(--text-main)';
                }
            });
            // Verhindere, dass alle abgewählt werden (updateOverallDayFilter setzt dann alle wieder)
            setTimeout(() => {
                if(overallDayFilter.length === 0) {
                    selectAllDays();
                } else {
                    if (typeof updateOverallDayFilter === 'function') updateOverallDayFilter();
                }
            }, 10);
        }
        
        function selectAllTours() {
            if(!appData.tours || appData.tours.length === 0) return;
            overallTourFilter = appData.tours.map(t => t.id);
            const container = document.getElementById('overallTourFilterContainer');
            if(container) {
                Array.from(container.children).forEach(btn => {
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.background = 'var(--primary-light)';
                    btn.style.color = 'var(--primary)';
                });
            }
            if (typeof updateTourFilterLabel === 'function') updateTourFilterLabel();
            if (typeof refreshView === 'function') refreshView();
        }
        
        function deselectAllTours() {
            overallTourFilter = [];
            const container = document.getElementById('overallTourFilterContainer');
            if(container) {
                Array.from(container.children).forEach(btn => {
                    btn.style.borderColor = 'var(--border)';
                    btn.style.background = 'var(--bg-hover)';
                    btn.style.color = 'var(--text-main)';
                });
            }
            // Verhindere, dass alle abgewählt werden (zeige dann alle)
            setTimeout(() => {
                if(overallTourFilter.length === 0) {
                    selectAllTours();
                } else {
                    if (typeof updateTourFilterLabel === 'function') updateTourFilterLabel();
                }
            }, 10);
        }
        
        async function saveFilterPreset() {
            if (typeof showInputModal === 'function') {
                showInputModal('Filter-Preset speichern', 'Name für das Filter-Preset:', '', async (name) => {
                    if(!name || !name.trim()) return;
                    
                    const preset = {
                        id: typeof generateId === 'function' ? generateId() : Date.now().toString(36) + Math.random().toString(36).substring(2),
                        name: name.trim(),
                        dayFilter: [...overallDayFilter],
                        tourFilter: [...overallTourFilter]
                    };
                    
                    if (typeof filterPresetCache === 'undefined') {
                        window.filterPresetCache = [];
                    }
                    
                    filterPresetCache.push(preset);
                    if (typeof saveFilterPresets === 'function') await saveFilterPresets(filterPresetCache);
                    if (typeof renderFilterPresetSelect === 'function') renderFilterPresetSelect();
                    if (typeof showToast === 'function') showToast('Filter-Preset gespeichert', 'success');
                });
            }
        }
        
        // --- VARIANTEN-FUNKTIONEN ---
        async function openVariantModal() {
            if (typeof showInputModal === 'function') {
                showInputModal('Neue Variante', 'Name der neuen Variante:', '', async (name) => {
                    if (!name || name.trim() === '') return;
                    const variantName = name.trim();
                
                    try {
                        const response = await apiCall('/api/variants', {
                            method: 'POST',
                            body: JSON.stringify({ name: variantName })
                        });
                        
                        if(!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Fehler beim Erstellen');
                        }
                        
                        const newVariant = await response.json();
                        variants.push(newVariant);
                        if (typeof updateVariantSelect === 'function') updateVariantSelect();
                        currentVariantId = newVariant.id;
                        const select = document.getElementById('variantSelect');
                        if (select) select.value = newVariant.id;
                        
                        // Lade leere Daten für neue Variante
                        appData = {
                            events: [],
                            pool: [],
                            employees: [],
                            tours: [{id:'t1', name:'Tour 1'}, {id:'t2', name:'Tour 2'}],
                            wageSettings: JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS)),
                            favorites: []
                        };
                        if (typeof refreshUI === 'function') refreshUI();
                        if (typeof showToast === 'function') showToast('Variante erstellt', 'success');
                    } catch(e) {
                        console.error('Fehler beim Erstellen der Variante:', e);
                        if (typeof showToast === 'function') showToast(e.message || 'Fehler beim Erstellen der Variante', 'error');
                    }
                });
            }
        }
        
        async function switchVariant(variantId) {
            if (!variantId || variantId === currentVariantId) return;
            
            // Speichere aktuelle Daten vor dem Wechsel
            if (currentVariantId) {
                if (typeof executeSave === 'function') await executeSave();
            }
            
            currentVariantId = parseInt(variantId);
            
            // Lade neue Daten
            try {
                await loadFromAPI();
                if (typeof refreshUI === 'function') refreshUI();
                if (typeof updatePatientList === 'function') updatePatientList();
                if (typeof showToast === 'function') showToast('Variante gewechselt', 'success');
            } catch(e) {
                console.error('Fehler beim Laden der Variante:', e);
                if (typeof showToast === 'function') showToast('Fehler beim Laden der Variante', 'error');
            }
        }
        
        // --- MODAL-FUNKTIONEN werden weiter unten definiert (nach modalHandlers) ---
        
        function openPoolModal() {
            // Reset form for new item
            const modal = document.getElementById('poolModal');
            if (!modal) return;
            delete modal.dataset.editingId;
            const nameInput = document.getElementById('poolName');
            const addressInput = document.getElementById('poolAddress');
            const postalCodeInput = document.getElementById('poolPostalCode');
            const coordinatesDisplay = document.getElementById('poolCoordinatesDisplay');
            if (nameInput) nameInput.value = '';
            if (addressInput) addressInput.value = '';
            if (postalCodeInput) postalCodeInput.value = '';
            if (coordinatesDisplay) coordinatesDisplay.style.display = 'none';
            document.querySelectorAll('.pool-cb').forEach(cb => cb.checked = false);
            openModal('poolModal');
        }
        
        function openPoolImportModal() {
            // Reset import modal
            const textarea = document.getElementById('poolImportTextarea');
            const fileInput = document.getElementById('poolImportFileInput');
            const preview = document.getElementById('poolImportPreview');
            const geocodeProgress = document.getElementById('poolImportGeocodeProgress');
            const autoGeocode = document.getElementById('poolImportAutoGeocode');
            if (textarea) textarea.value = '';
            if (fileInput) fileInput.value = '';
            if (preview) preview.style.display = 'none';
            if (geocodeProgress) geocodeProgress.style.display = 'none';
            if (autoGeocode) autoGeocode.checked = false;
            
            // Reset Button
            const executeBtn = document.getElementById('poolImportExecuteBtn');
            if (executeBtn) {
                executeBtn.disabled = false;
                executeBtn.textContent = '📥 Importieren';
            }
            
            // Prüfe ob SheetJS verfügbar ist
            const warningDiv = document.getElementById('sheetjsWarning');
            if(warningDiv) {
                if(typeof XLSX === 'undefined') {
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.style.display = 'none';
                }
            }
            
            openModal('poolImportModal');
        }
        
        function openManualCoordinatesModal() {
            // Lade aktuelle Koordinaten falls vorhanden
            const modal = document.getElementById('poolModal');
            if (!modal) return;
            const tempCoords = modal.dataset.tempCoordinates;
            if (tempCoords) {
                try {
                    const coords = JSON.parse(tempCoords);
                    const latInput = document.getElementById('manualLat');
                    const lngInput = document.getElementById('manualLng');
                    if (latInput) latInput.value = coords.lat || '';
                    if (lngInput) lngInput.value = coords.lng || '';
                } catch (e) {
                    // Ignoriere Fehler
                }
            }
            openModal('manualCoordinatesModal');
        }
        
        async function geocodePoolAddress() {
            const addressInput = document.getElementById('poolAddress');
            const postalCodeInput = document.getElementById('poolPostalCode');
            const btn = document.getElementById('geocodeBtn');
            const display = document.getElementById('poolCoordinatesDisplay');
            const text = document.getElementById('poolCoordinatesText');
            const modal = document.getElementById('poolModal');
            
            if (!addressInput && !postalCodeInput) {
                showToast('Bitte Adresse oder Postleitzahl eingeben', 'warning');
                return;
            }
            
            const address = addressInput ? addressInput.value.trim() : '';
            const postalCode = postalCodeInput ? postalCodeInput.value.trim() : '';
            
            if (!address && !postalCode) {
                showToast('Bitte Adresse oder Postleitzahl eingeben', 'warning');
                return;
            }
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Ermittle...';
            }
            
            try {
                const response = await fetch('/api/geocoding/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        address: address, 
                        postalCode: postalCode, 
                        city: 'Gelsenkirchen' 
                    })
                });
                
                // Prüfe ob es ein Timeout war
                if (response.status === 504) {
                    throw new Error('Geocoding-Service antwortet nicht rechtzeitig. Bitte versuchen Sie es später erneut.');
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const coordinates = {
                        lat: data.latitude,
                        lng: data.longitude
                    };
                    
                    // Speichere temporär im Modal
                    if (modal) {
                        modal.dataset.tempCoordinates = JSON.stringify(coordinates);
                    }
                    
                    // Zeige Koordinaten
                    if (display) display.style.display = 'block';
                    if (text) {
                        text.textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
                    }
                    
                    showToast('Koordinaten erfolgreich ermittelt', 'success');
                } else {
                    showToast('Koordinaten konnten nicht ermittelt werden: ' + (data.error || 'Unbekannter Fehler'), 'error');
                }
            } catch (error) {
                console.error('Geocoding-Fehler:', error);
                // Zeige spezifische Fehlermeldung für Timeouts
                if (error.message && (error.message.includes('Timeout') || error.message.includes('504'))) {
                    showToast('Geocoding-Service antwortet nicht rechtzeitig. Bitte versuchen Sie es später erneut.', 'error');
                } else if (error.message && error.message.includes('Unexpected token')) {
                    showToast('Geocoding-Service hat ungültige Antwort zurückgegeben. Bitte versuchen Sie es später erneut.', 'error');
                } else {
                    showToast('Fehler beim Ermitteln der Koordinaten: ' + (error.message || 'Unbekannter Fehler'), 'error');
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '🔍 Koordinaten ermitteln';
                }
            }
        }
        
        function saveManualCoordinates() {
            const latInput = document.getElementById('manualLat');
            const lngInput = document.getElementById('manualLng');
            const modal = document.getElementById('poolModal');
            
            if (!latInput || !lngInput) return;
            
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showToast('Ungültige Koordinaten', 'error');
                return;
            }
            
            const coordinates = { lat, lng };
            
            // Speichere temporär im Modal
            if (modal) {
                modal.dataset.tempCoordinates = JSON.stringify(coordinates);
            }
            
            // Zeige Koordinaten
            const display = document.getElementById('poolCoordinatesDisplay');
            const text = document.getElementById('poolCoordinatesText');
            if (display) display.style.display = 'block';
            if (text) {
                text.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
            
            closeModal('manualCoordinatesModal');
            showToast('Koordinaten gespeichert', 'success');
        }
        
        function createPoolItem() {
            const nameInput = document.getElementById('poolName');
            const zoneSelect = document.getElementById('poolZone');
            const addressInput = document.getElementById('poolAddress');
            const postalCodeInput = document.getElementById('poolPostalCode');
            const modal = document.getElementById('poolModal');
            
            if (!nameInput) return;
            
            const name = nameInput.value.trim();
            if (!name) {
                showToast('Bitte geben Sie einen Namen ein', 'warning');
                return;
            }
            
            const zone = zoneSelect ? zoneSelect.value : 'Alt-/Neustadt';
            const address = addressInput ? addressInput.value.trim() : '';
            const postalCode = postalCodeInput ? postalCodeInput.value.trim() : '';
            
            // Lade temporäre Koordinaten falls vorhanden
            let coordinates = null;
            if (modal && modal.dataset.tempCoordinates) {
                try {
                    coordinates = JSON.parse(modal.dataset.tempCoordinates);
                } catch (e) {
                    // Ignoriere Fehler
                }
            }
            
            // Sammle ausgewählte Leistungstypen
            const types = [];
            document.querySelectorAll('.pool-cb:checked').forEach(cb => {
                types.push(cb.value);
            });
            
            if (types.length === 0) {
                showToast('Bitte wählen Sie mindestens einen Leistungstyp aus', 'warning');
                return;
            }
            
            // Erstelle Pool-Item
            if (!appData.pool) appData.pool = [];
            
            const poolItem = {
                id: generateId(),
                title: name,
                zone: zone,
                types: types,
                address: address || null,
                postalCode: postalCode || null,
                extendedProps: {}
            };
            
            if (coordinates) {
                poolItem.extendedProps.coordinates = coordinates;
            }
            
            appData.pool.push(poolItem);
            
            // Reset form
            nameInput.value = '';
            if (addressInput) addressInput.value = '';
            if (postalCodeInput) postalCodeInput.value = '';
            if (zoneSelect) zoneSelect.value = '';
            document.querySelectorAll('.pool-cb').forEach(cb => cb.checked = false);
            if (modal) delete modal.dataset.tempCoordinates;
            const coordinatesDisplay = document.getElementById('poolCoordinatesDisplay');
            if (coordinatesDisplay) coordinatesDisplay.style.display = 'none';
            
            queueSave();
            renderPool();
            closeModal('poolModal');
            showToast('Kunde angelegt', 'success');
        }
        
        async function loadFromAPI(){
            if (!currentVariantId) {
                console.warn('Keine Variante ausgewählt');
                return;
            }
            
            try {
                const response = await apiCall(`/api/data?variant_id=${currentVariantId}`);
                if(!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                appData = data;
                ensureAppDataDefaults();
                
                // Migrate old zone names to new combined zone
                migrateZoneNames();
                
                // Bereinige veraltete Einsätze ohne dayIndex
                cleanupInvalidEvents();
                
                console.log('Daten erfolgreich vom Server geladen');
            } catch(e) {
                console.error('Fehler beim Laden vom Server:', e);
                throw e;
            }
        }
        
        function refreshUI() {
            const ts=document.getElementById('tourSelect'); 
            const ets=document.getElementById('eventTourSelect'); 
            if(!ts || !ets) return;
            ts.innerHTML=''; 
            ets.innerHTML='';
            if(!appData.tours || appData.tours.length === 0) {
                appData.tours = [{id:'t1', name:'Tour 1'}, {id:'t2', name:'Tour 2'}];
            }
            appData.tours.forEach(t=>{
                const o=document.createElement('option');
                o.value = t.id;
                o.textContent = t.name || '';
                ts.appendChild(o);
                const o2=document.createElement('option');
                o2.value = t.id;
                o2.textContent = t.name || '';
                ets.appendChild(o2);
            });
            if (typeof updateTourEmployeeDisplay === 'function') updateTourEmployeeDisplay();
            if (typeof renderPool === 'function') renderPool();
            if (typeof refreshView === 'function') refreshView();
            // Wenn Team-Tab aktiv ist, verwende renderEmployeeList() statt renderList()
            if (currentView === 'admin' && currentAdminTab === 'employees' && typeof renderEmployeeList === 'function') {
                renderEmployeeList();
            } else if (typeof renderList === 'function') {
                renderList('employeeList', appData.employees || [], 
                id => {
                    appData.employees = appData.employees.filter(e => e.id !== id);
                    queueSave();
                    refreshUI();
                },
                (id, newName) => {
                    const emp = appData.employees.find(e => e.id === id);
                    if(emp) {
                        emp.name = newName;
                        queueSave();
                        refreshUI();
                    }
                }
            );
            }
            // Verwende renderTourList() für tourList statt renderList(), wenn renderTourList verfügbar ist
            if (typeof renderTourList === 'function' && document.getElementById('tourList')) {
                renderTourList();
            } else if (typeof renderList === 'function') {
                renderList('tourList', appData.tours || [], 
                id => {
                    if(appData.tours.length <= 1) {
                        showAlertModal('Fehler', 'Mindestens eine Tour muss vorhanden sein.', 'error');
                        return;
                    }
                    appData.tours = appData.tours.filter(t => t.id !== id);
                    queueSave();
                    refreshUI();
                },
                (id, newName) => {
                    const tour = appData.tours.find(t => t.id === id);
                    if(tour) {
                        tour.name = newName;
                        queueSave();
                        refreshUI();
                    }
                }
            );
            }
        }
        
        // --- ZONE LEGEND ---
        function renderZoneLegend() {
            const container = document.getElementById('zoneLegendContent');
            if(!container) return;
            
            container.innerHTML = CITY_ZONES.map(zone => {
                const color = ZONE_COLORS[zone] || '#525252';
                const zoneWithPLZ = getZoneWithPostalCode(zone);
                // Kürze lange Namen
                const shortName = zoneWithPLZ.length > 18 ? zoneWithPLZ.substring(0, 17) + '…' : zoneWithPLZ;
                return `
                    <div style="display:flex; align-items:center; gap:5px; padding:4px 6px; border-radius:4px; background:var(--border-light); cursor:pointer; transition:all 0.15s; border-left:3px solid ${color};" 
                         onclick="filterByZone('${zone}')" title="${zoneWithPLZ} - Klicken zum Filtern"
                         onmouseover="this.style.background='${color}20'; this.style.transform='translateX(2px)';"
                         onmouseout="this.style.background='var(--border-light)'; this.style.transform='none';">
                        <div style="width:12px; height:12px; border-radius:3px; background:${color}; flex-shrink:0; box-shadow:0 1px 3px ${color}40;"></div>
                        <span style="font-size:0.68rem; color:var(--text-main); font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${shortName}</span>
                    </div>
                `;
            }).join('');
        }
        
        function toggleZoneLegend() {
            toggleMenuSection('zones');
        }
        
        // Menu section toggle state
        const menuSectionState = {
            pool: true,
            admin: false,
            analysis: false,
            files: false,
            zones: false,
            settings: false
        };
        
        // toggleMenuSection wurde bereits oben definiert
        
        function filterByZone(zone) {
            const poolZoneFilter = document.getElementById('poolZoneFilter');
            if(poolZoneFilter) {
                poolZoneFilter.value = zone;
                filterPool();
            }
            showToast(`Filter: ${zone}`, 'info');
        }

        // --- CORE RENDER POOL ---
        function renderPool() {
            const container = document.getElementById('external-events'); 
            if(!container) return;
            container.innerHTML = '';
            
            // Get filter values
            const searchVal = (document.getElementById('poolSearchInput')?.value || '').toLowerCase();
            const typeVal = document.getElementById('poolTypeFilter')?.value || '';
            const zoneVal = document.getElementById('poolZoneFilter')?.value || '';
            const sortVal = document.getElementById('poolSort')?.value || 'name';
            
            // Filter pool items
            let filteredPool = [...(appData.pool || [])];
            
            if(searchVal) {
                filteredPool = filteredPool.filter(p => p.title.toLowerCase().includes(searchVal));
            }
            if(typeVal) {
                filteredPool = filteredPool.filter(p => (p.types || []).includes(typeVal));
            }
            if(zoneVal) {
                filteredPool = filteredPool.filter(p => p.zone === zoneVal);
            }
            
            // Sort pool items (favorites first, then by selected sort)
            filteredPool.sort((a, b) => {
                // Favorites always first
                if(a.favorite && !b.favorite) return -1;
                if(!a.favorite && b.favorite) return 1;
                
                switch(sortVal) {
                    case 'name-desc':
                        return b.title.localeCompare(a.title);
                    case 'zone':
                        return (a.zone || '').localeCompare(b.zone || '');
                    case 'name':
                    default:
                        return a.title.localeCompare(b.title);
                }
            });
            
            // Make pool a drop target for events
            container.ondragover = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                container.classList.add('drag-over');
            };
            container.ondragleave = (e) => {
                container.classList.remove('drag-over');
            };
            container.ondrop = (e) => {
                e.preventDefault();
                container.classList.remove('drag-over');
                handleDropToPool();
            };
            
            if(filteredPool.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);font-size:0.85rem;">Keine Einträge</div>';
                return;
            }
            
            // Determine size class based on number of items
            const itemCount = filteredPool.length;
            let sizeClass = 'size-normal';
            if(itemCount > 15) sizeClass = 'size-compact';
            if(itemCount > 25) sizeClass = 'size-mini';
            
            // Add count indicator
            const countBadge = document.createElement('div');
            countBadge.style.cssText = 'font-size:0.65rem; color:var(--text-light); text-align:center; padding:4px 0; margin-bottom:4px; border-bottom:1px solid var(--border-light);';
            countBadge.innerHTML = `<span style="font-weight:600; color:var(--text-muted);">${itemCount}</span> Einträge`;
            if(itemCount > 0) container.appendChild(countBadge);
            
            filteredPool.forEach(p => {
                const d = document.createElement('div'); 
                d.className = 'pool-item ' + sizeClass;
                
                // Baue Tooltip mit Adresse und Koordinaten
                const coordinates = p.extendedProps?.coordinates || p.extended_props?.coordinates;
                let tooltip = p.title;
                if (p.address) tooltip += `\n${p.address}`;
                if (p.postalCode) tooltip += `, ${p.postalCode}`;
                if (p.zone) tooltip += `\nZone: ${getZoneWithPostalCode(p.zone)}`;
                if (coordinates && coordinates.lat && coordinates.lng) {
                    tooltip += `\n📍 Koordinaten: ${coordinates.lat.toFixed(6)}°N, ${coordinates.lng.toFixed(6)}°E`;
                }
                tooltip += '\n\nZiehen zum Planen';
                d.title = tooltip;
                
                d.draggable = true;
                d.ondragstart = (e) => handleDragStart(e, 'pool', p.id);
                
                // Zone color
                const zoneColor = ZONE_COLORS[p.zone] || 'var(--primary)';
                d.style.borderLeftColor = zoneColor;
                
                let dots = (p.types || []).map(t => `<div class="dot ${t}"></div>`).join('');
                const starIcon = p.favorite ? '⭐' : '☆';
                const starStyle = p.favorite ? 'color:#f59e0b;' : 'color:var(--text-light); opacity:0.6;';
                const hasCoordinates = coordinates && coordinates.lat && coordinates.lng;
                const coordIcon = hasCoordinates ? '📍' : '';
                
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:5px; min-width:0; flex:1;">
                            <span class="favorite-star" style="cursor:pointer;font-size:0.9rem;${starStyle}flex-shrink:0;" data-id="${p.id}" title="${p.favorite ? 'Favorit entfernen' : 'Als Favorit markieren'}">${starIcon}</span>
                            <span class="pool-title" style="font-weight:600;color:var(--text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.title}</span>
                            ${coordIcon ? `<span style="font-size:0.75rem;opacity:0.7;" title="Koordinaten vorhanden">${coordIcon}</span>` : ''}
                    </div>
                        <div style="display:flex;align-items:center;gap:3px;flex-shrink:0;">
                            <span style="display:flex;gap:3px;flex-shrink:0;margin-left:6px;">${dots}</span>
                            <button class="pool-delete-btn" onclick="event.stopPropagation(); deletePoolItem('${p.id}')" title="Kunde löschen" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:2px 4px;font-size:0.85rem;opacity:0.6;transition:opacity 0.2s;">🗑️</button>
                        </div>
                    </div>
                    <div class="pool-zone" style="color:var(--text-muted);display:flex;align-items:center;gap:4px;margin-top:2px;">
                        <span style="width:6px;height:6px;background:${zoneColor};border-radius:2px;display:inline-block;flex-shrink:0;"></span>
                        <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${getZoneWithPostalCode(p.zone) || 'Keine Zone'}</span>
                        ${p.address ? `<span style="font-size:0.75rem;opacity:0.7;margin-left:4px;" title="${p.address}">${p.address}</span>` : ''}
                    </div>`;
                
                // Favorite star click handler
                const star = d.querySelector('.favorite-star');
                if(star) {
                    star.onclick = (e) => {
                        e.stopPropagation();
                        toggleFavorite(p.id);
                    };
                }
                
                // Hover-Effekt für Löschen-Button
                const deleteBtn = d.querySelector('.pool-delete-btn');
                if(deleteBtn) {
                    d.addEventListener('mouseenter', () => {
                        deleteBtn.style.opacity = '1';
                    });
                    d.addEventListener('mouseleave', () => {
                        deleteBtn.style.opacity = '0.6';
                    });
                }
                
                // Click to edit pool item (not schedule)
                d.onclick = () => {
                    openPoolItemEdit(p);
                };
                
                container.appendChild(d);
            });
            
            // Show empty state if no items
            if(filteredPool.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light); font-size:0.8rem;">Keine Einträge</div>';
            }
        }
        
        function toggleFavorite(id) {
            const item = appData.pool.find(p => p.id === id);
            if(item) {
                item.favorite = !item.favorite;
                queueSave();
                renderPool();
                showToast(item.favorite ? `"${item.title}" als Favorit markiert` : `"${item.title}" aus Favoriten entfernt`, 'info');
            }
        }
        // --- FILTER PRESETS ---
        function getFilterPresets() {
            return filterPresetCache || [];
        }
        
        async function saveFilterPresets(presets) {
            filterPresetCache = presets.slice();
            try {
                await dbClear('filterPresets');
                for (const p of filterPresetCache) {
                    await dbSave('filterPresets', p.id, p);
                }
            } catch(e) {
                console.warn('FilterPresets IndexedDB Speichern fehlgeschlagen:', e);
                try {
                    localStorage.setItem(FILTER_PRESET_FALLBACK_KEY, JSON.stringify(filterPresetCache));
                } catch(storageError) {
                    console.warn('FilterPresets LocalStorage Fallback fehlgeschlagen:', storageError);
                }
            }
            renderFilterPresetSelect();
        }
        
        // saveFilterPreset wurde bereits oben definiert (für Gesamtansicht-Filter)
        // Diese Version ist für Pool-Filter - behalten, da unterschiedliche Funktionalität
        
        function loadFilterPreset() {
            const select = document.getElementById('filterPresetSelect');
            if(!select || !select.value) return;
            
            const presets = getFilterPresets();
            const preset = presets.find(p => p.id === select.value);
            if(!preset) return;
            
            if(document.getElementById('poolSearchInput')) document.getElementById('poolSearchInput').value = preset.search || '';
            if(document.getElementById('poolTypeFilter')) document.getElementById('poolTypeFilter').value = preset.type || '';
            if(document.getElementById('poolZoneFilter')) document.getElementById('poolZoneFilter').value = preset.zone || '';
            if(document.getElementById('poolSort')) document.getElementById('poolSort').value = preset.sort || 'name';
            
            renderPool();
            select.value = '';
            showToast(`Preset "${preset.name}" geladen`, 'info');
        }
        
        function renderFilterPresetSelect() {
            const select = document.getElementById('filterPresetSelect');
            if(!select) return;
            
            const presets = getFilterPresets();
            select.innerHTML = '<option value="">-- Preset laden --</option>' + 
                presets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
        
        // Sync-Funktionen entfernt - Daten werden jetzt über API verwaltet
        // Diese Funktionen sind nicht mehr benötigt, da alle Daten über die REST API gespeichert werden

        function openPoolItemEdit(poolItem) {
            // Open pool modal for editing
            document.getElementById('poolName').value = poolItem.title || '';
            document.getElementById('poolZone').value = poolItem.zone || '';
            document.getElementById('poolAddress').value = poolItem.address || '';
            document.getElementById('poolPostalCode').value = poolItem.postalCode || '';
            
            // Set checkboxes
            document.querySelectorAll('.pool-cb').forEach(cb => {
                cb.checked = (poolItem.types || []).includes(cb.value);
            });
            
            // Zeige Koordinaten falls vorhanden
            const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
            const display = document.getElementById('poolCoordinatesDisplay');
            const text = document.getElementById('poolCoordinatesText');
            
            if (coordinates && coordinates.lat && coordinates.lng) {
                text.textContent = `${coordinates.lat.toFixed(6)}°N, ${coordinates.lng.toFixed(6)}°E`;
                display.style.display = 'block';
                
                // Speichere Koordinaten temporär im Modal
                const modal = document.getElementById('poolModal');
                modal.dataset.tempCoordinates = JSON.stringify(coordinates);
            } else {
                display.style.display = 'none';
            }
            
            // Store editing ID
            const modal = document.getElementById('poolModal');
            modal.dataset.editingId = poolItem.id;
            
            openModal('poolModal');
        }
        
        function deletePoolItem(poolId) {
            const item = appData.pool.find(p => p.id === poolId);
            if(!item) return;
            
            const itemName = item.title;
            if(confirm(`Möchten Sie den Kunden "${itemName}" wirklich löschen?`)) {
                // Entferne Item aus Pool
                appData.pool = appData.pool.filter(p => p.id !== poolId);
                
                // Speichere Änderungen
                queueSave();
                renderPool();
                
                // Aktualisiere Kundenliste falls im Admin-Tab
                if (currentView === 'admin' && currentAdminTab === 'customers') {
                    renderCustomerList();
                }
                
                showToast(`Kunde "${itemName}" gelöscht`, 'success');
            }
        }
        
        function deleteAllCustomers() {
            // Zähle Pool-Kunden und verplante Kunden
            const poolCount = appData.pool.length;
            const plannedCustomers = new Set();
            appData.events.forEach(evt => {
                if (!evt.extendedProps?.isTravel && evt.title) {
                    plannedCustomers.add(evt.title);
                }
            });
            const plannedCount = plannedCustomers.size;
            const totalCount = poolCount + plannedCount;
            
            if (totalCount === 0) {
                showToast('Keine Kunden zum Löschen vorhanden', 'info');
                return;
            }
            
            // Erstelle Modal für Auswahl
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:500px;">
                    <h3 style="margin-top:0;">🗑️ Kunden löschen</h3>
                    <p style="color:var(--text-muted); margin-bottom:20px;">
                        Welche Kunden möchten Sie löschen?
                    </p>
                    <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:24px;">
                        <label style="display:flex; align-items:center; gap:12px; padding:12px; border:2px solid var(--border); border-radius:var(--radius-md); cursor:pointer; transition:all 0.2s;" 
                               onmouseover="this.style.borderColor='var(--primary)'" 
                               onmouseout="this.style.borderColor='var(--border)'"
                               onclick="document.getElementById('deletePoolOnly').checked=true;">
                            <input type="radio" id="deletePoolOnly" name="deleteType" value="pool" checked style="cursor:pointer;">
                            <div style="flex:1;">
                                <div style="font-weight:600; margin-bottom:4px;">Nur Pool-Kunden (${poolCount})</div>
                                <div style="font-size:0.85rem; color:var(--text-muted);">Löscht nur Kunden aus dem Pool. Verplante Einsätze bleiben erhalten.</div>
                            </div>
                        </label>
                        <label style="display:flex; align-items:center; gap:12px; padding:12px; border:2px solid var(--border); border-radius:var(--radius-md); cursor:pointer; transition:all 0.2s;" 
                               onmouseover="this.style.borderColor='var(--danger)'" 
                               onmouseout="this.style.borderColor='var(--border)'"
                               onclick="document.getElementById('deleteAll').checked=true;">
                            <input type="radio" id="deleteAll" name="deleteType" value="all" style="cursor:pointer;">
                            <div style="flex:1;">
                                <div style="font-weight:600; margin-bottom:4px; color:var(--danger);">Alle Kunden (${totalCount})</div>
                                <div style="font-size:0.85rem; color:var(--text-muted);">Löscht alle Kunden aus dem Pool (${poolCount}) und alle verplanten Einsätze (${plannedCount}).</div>
                            </div>
                        </label>
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button>
                        <button class="btn btn-danger" onclick="confirmDeleteCustomers()">Löschen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Globale Funktion für Bestätigung
            window.confirmDeleteCustomers = function() {
                const deleteType = document.querySelector('input[name="deleteType"]:checked').value;
                modal.remove();
                
                const count = deleteType === 'pool' ? poolCount : totalCount;
                const typeText = deleteType === 'pool' ? 'Pool-Kunden' : 'Kunden';
                
                showConfirmInputModal(
                    'Kunden löschen',
                    `⚠️ WARNUNG: Möchten Sie wirklich ${count} ${typeText} löschen?\n\nDiese Aktion kann nicht rückgängig gemacht werden!`,
                    'LÖSCHEN',
                    'Geben Sie "LÖSCHEN" ein, um zu bestätigen:',
                    (isValid) => {
                        if (!isValid) {
                            showToast('Löschung abgebrochen', 'info');
                            return;
                        }
                        
                        if (deleteType === 'pool') {
                            // Nur Pool-Kunden löschen
                            appData.pool = [];
                        } else {
                            // Alle Kunden löschen (Pool + verplante Einsätze)
                            appData.pool = [];
                            appData.events = appData.events.filter(e => e.extendedProps?.isTravel === true);
                        }
                        
                        // Speichere Änderungen
                        queueSave();
                        renderPool();
                        
                        // Aktualisiere Kundenliste
                        if (currentView === 'admin' && currentAdminTab === 'customers') {
                            renderCustomerList();
                        }
                        
                        // Aktualisiere Ansicht
                        refreshView();
                        
                        showToast(`${count} ${typeText} wurden gelöscht`, 'success');
                    }
                );
            }
        }
        function deleteAllEvents() {
            const eventCount = appData.events.filter(e => !e.extendedProps?.isTravel).length;
            const travelCount = appData.events.filter(e => e.extendedProps?.isTravel).length;
            
            if (eventCount === 0) {
                showToast('Keine Einsätze zum Löschen vorhanden', 'info');
                return;
            }
            
            const confirmed = confirm(
                `⚠️ WARNUNG: Möchten Sie wirklich ALLE ${eventCount} Einsätze löschen?\n\n` +
                `${travelCount > 0 ? `Hinweis: ${travelCount} Fahrtzeiten werden nicht gelöscht.\n\n` : ''}` +
                `Diese Aktion kann nicht rückgängig gemacht werden!\n\n` +
                `Geben Sie "LÖSCHEN" ein, um zu bestätigen:`
            );
            
            if (!confirmed) {
                return;
            }
            
            showConfirmInputModal(
                'Alle Einsätze löschen',
                `⚠️ WARNUNG: Möchten Sie wirklich ALLE ${eventCount} Einsätze löschen?\n\n${travelCount > 0 ? `Hinweis: ${travelCount} Fahrtzeiten werden nicht gelöscht.\n\n` : ''}Diese Aktion kann nicht rückgängig gemacht werden!`,
                'LÖSCHEN',
                'Geben Sie "LÖSCHEN" ein, um zu bestätigen:',
                (isValid) => {
                    if (!isValid) {
                        showToast('Löschung abgebrochen', 'info');
                        return;
                    }
                    
                    // Entferne alle Einsätze (behalte Fahrtzeiten)
                    appData.events = appData.events.filter(e => e.extendedProps?.isTravel === true);
                    
                    // Speichere Änderungen
                    queueSave();
                    
                    // Aktualisiere Ansicht
                    refreshView();
                    
                    showToast(`Alle ${eventCount} Einsätze wurden gelöscht`, 'success');
                }
            );
        }
        
        function renderAdminEvents(container) {
            const eventCount = appData.events.filter(e => !e.extendedProps?.isTravel).length;
            const travelCount = appData.events.filter(e => e.extendedProps?.isTravel).length;
            
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">📅 Einsätze verwalten</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">
                    Verwalten Sie alle geplanten Einsätze der aktuellen Variante.
                </p>
                
                <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border); margin-bottom:24px;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                        <div>
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:4px;">Einsätze</div>
                            <div style="font-size:2rem; font-weight:700; color:var(--primary);">${eventCount}</div>
                        </div>
                        <div>
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:4px;">Fahrtzeiten</div>
                            <div style="font-size:2rem; font-weight:700; color:var(--text-secondary);">${travelCount}</div>
                        </div>
                    </div>
                </div>
                
                <div style="padding:16px; background:var(--warning-light); border:1px solid var(--warning); border-radius:var(--radius-md); margin-bottom:24px;">
                    <div style="font-weight:600; color:var(--warning); margin-bottom:8px;">⚠️ Warnung</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">
                        Das Löschen aller Einsätze kann nicht rückgängig gemacht werden. 
                        Fahrtzeiten werden automatisch beibehalten.
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn btn-danger" onclick="deleteAllEvents()" style="white-space:nowrap;">
                        🗑️ Alle Einsätze löschen
                    </button>
                </div>
            `;
        }

        function handleDropToPool() {
            if(!draggedItem || draggedItem.type !== 'event') return;
            
            clearAllTooltips(); // Clear tooltips before removing elements
            // Small delay to ensure browser processes tooltip removal
            setTimeout(() => {
                saveUndoState(); // Save state before moving to pool
                
                // Get list of events to move (either multi-select or single)
                const eventsToMove = draggedItem.multiSelect 
                    ? draggedItem.multiSelect.map(id => appData.events.find(ev => ev.id === id)).filter(Boolean)
                    : [appData.events.find(ev => ev.id === draggedItem.id)].filter(Boolean);
                
                eventsToMove.forEach(evt => {
                    if(!evt) return;
                    
                    // Prüfe ob bereits ein Pool-Item mit poolId existiert
                    const existingPoolId = evt.extendedProps?.poolId;
                    let poolItem = null;
                    
                    if (existingPoolId) {
                        poolItem = appData.pool.find(p => p.id === existingPoolId);
                    }
                    
                    if (poolItem) {
                        // Pool-Item existiert bereits - kein Duplikat erstellen
                        // Aktualisiere ggf. Adresse/Koordinaten falls im Event vorhanden
                        if (evt.extendedProps?.address && !poolItem.address) {
                            poolItem.address = evt.extendedProps.address;
                        }
                        if (evt.extendedProps?.postalCode && !poolItem.postalCode) {
                            poolItem.postalCode = evt.extendedProps.postalCode;
                        }
                        if (evt.extendedProps?.coordinates && !poolItem.extendedProps?.coordinates) {
                            if (!poolItem.extendedProps) poolItem.extendedProps = {};
                            poolItem.extendedProps.coordinates = evt.extendedProps.coordinates;
                        }
                    } else {
                        // Neues Pool-Item erstellen mit Adresse/Koordinaten aus Event
                        const newPoolItem = {
                            id: existingPoolId || generateId(), 
                            title: evt.title,
                            zone: evt.extendedProps?.zone || 'Alt-/Neustadt',
                            types: evt.extendedProps?.types || ['other']
                        };
                        
                        // Übernehme Adresse/Koordinaten aus Event falls vorhanden
                        if (evt.extendedProps?.address) {
                            newPoolItem.address = evt.extendedProps.address;
                        }
                        if (evt.extendedProps?.postalCode) {
                            newPoolItem.postalCode = evt.extendedProps.postalCode;
                        }
                        if (evt.extendedProps?.coordinates) {
                            if (!newPoolItem.extendedProps) newPoolItem.extendedProps = {};
                            newPoolItem.extendedProps.coordinates = evt.extendedProps.coordinates;
                        }
                        
                        appData.pool.push(newPoolItem);
                    }
                    
                    // Remove from events
                    appData.events = appData.events.filter(e => e.id !== evt.id);
                });
                
                // Clear selection
                clearEventSelection();
                
                queueSave(); 
                renderPool();
                refreshView();
                
                draggedItem = null;
            }, 10);
        }

        // --- NAVIGATION DROPDOWN ---
        // toggleNavGroup, closeNavGroups, switchView wurden bereits oben definiert
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-group')) {
                if (typeof closeNavGroups === 'function') closeNavGroups();
            }
        });

        // switchView wurde bereits oben definiert
        
        // setZoom wurde bereits oben definiert

        // Initialize zoom buttons and view
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof setZoom === 'function') setZoom(15); // Default to 15min
        // Stelle sicher, dass die View initialisiert wird (refreshView ist jetzt definiert)
            setTimeout(() => {
                if (typeof switchView === 'function') {
        switchView(currentView || 'week');
                } else if (typeof refreshView === 'function') {
                    refreshView();
                }
            }, 100);
        });

        // --- STANDARD LOGIC ---
        function refreshView() {
        const container = document.getElementById('weekView');
        if(!container) return;
            
            container.innerHTML = ''; // Clear container

            if(currentView === 'dashboard') {
                renderDashboard(container);
                return;
            }
            
            if(currentView === 'admin') {
                renderAdminView(container);
                return;
            }

            if(currentView === 'week') {
        const tourSelect = document.getElementById('tourSelect');
                const selectedTour = tourSelect ? tourSelect.value : null;
        // Filter events by tour (no date filtering - static week)
                const eventsForTour = (appData.events || []).filter(evt => {
                    if(!evt || evt.dayIndex === undefined) return false;
                    if(selectedTour && (!evt.extendedProps || evt.extendedProps.tour !== selectedTour)) return false;
                    return true;
                });
        // Auto-calculate travel times (with tour ID for commute calculation)
                const withTravel = injectTravelTimes(eventsForTour, selectedTour);

                renderWeekBoard(container, withTravel);
                calculateStats(withTravel);
            } else if(currentView === 'overall') {
                // Gesamtansicht - alle Touren für alle Tage parallel
                const allEvents = (appData.events || []).filter(evt => {
                    if(!evt || evt.dayIndex === undefined) return false;
                    // Filter nach Wochentagen
                    if(!overallDayFilter.includes(evt.dayIndex)) return false;
                    return true;
                });
                
                // Filter by existing tours
                const tourIds = appData.tours.map(t => t.id);
                let validEvents = allEvents.filter(evt => evt.extendedProps && tourIds.includes(evt.extendedProps.tour));
                
                // Filter nach ausgewählten Touren (wenn Filter gesetzt)
                if(overallTourFilter.length > 0) {
                    validEvents = validEvents.filter(evt => overallTourFilter.includes(evt.extendedProps.tour));
                }

                // Auto-calculate travel times PER TOUR for each day
                let allEventsWithTravel = [];
                for(let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    // Nur Tage anzeigen, die im Filter sind
                    if(!overallDayFilter.includes(dayIndex)) continue;
                    
                    const dayEvents = validEvents.filter(evt => evt.dayIndex === dayIndex);
                    appData.tours.forEach(tour => {
                        // Nur Touren anzeigen, die im Filter sind (oder alle, wenn Filter leer)
                        if(overallTourFilter.length > 0 && !overallTourFilter.includes(tour.id)) return;
                        
                        const tourEvents = dayEvents.filter(e => e.extendedProps.tour === tour.id);
                        const withTravel = injectTravelTimes(tourEvents, tour.id);
                        allEventsWithTravel = allEventsWithTravel.concat(withTravel);
                    });
                }

                renderOverallView(container, allEventsWithTravel);
                calculateStats(validEvents);
                
                // Überschneidungen zählen und anzeigen
                updateOverallConflictCount(validEvents);
            } else {
                // Compare View - show all tours for a selected day (default: Montag)
                const selectedDayIndex = currentCompareDayIndex || 0;
                
                const eventsThisDay = (appData.events || []).filter(evt => {
                    if(!evt || evt.dayIndex === undefined) return false;
                    return evt.dayIndex === selectedDayIndex;
                });
                
                // Filter by existing tours
                const tourIds = appData.tours.map(t => t.id);
                const validEvents = eventsThisDay.filter(evt => evt.extendedProps && tourIds.includes(evt.extendedProps.tour));

                // Auto-calculate travel times PER TOUR
                let allEventsWithTravel = [];
                appData.tours.forEach(tour => {
                    const tourEvents = validEvents.filter(e => e.extendedProps.tour === tour.id);
                    const withTravel = injectTravelTimes(tourEvents, tour.id);
                    allEventsWithTravel = allEventsWithTravel.concat(withTravel);
                });

                renderCompareBoard(container, allEventsWithTravel, selectedDayIndex);
                calculateStats(validEvents);
            }
        }

        function injectTravelTimes(events, tourId = null) {
            // Sort by start time
            const sorted = [...events].sort((a, b) => {
                const aMin = parseTimeToMinutes(a.start);
                const bMin = parseTimeToMinutes(b.start);
                return aMin - bMin;
            });
            const result = [];
            const byDay = {};

            // Group by dayIndex
            sorted.forEach(evt => {
                const day = evt.dayIndex || 0;
                if(!byDay[day]) byDay[day] = [];
                byDay[day].push(evt);
            });

            // Get employee home zone and coordinates for this tour
            let employeeHomeZone = null;
            let employeeCoordinates = null;
            if(tourId) {
                const tour = appData.tours?.find(t => t.id === tourId);
                if(tour?.employeeId) {
                    const emp = appData.employees?.find(e => e.id === tour.employeeId);
                    if(emp) {
                        if(emp.homeZone) {
                            employeeHomeZone = emp.homeZone;
                        }
                        if(emp.extendedProps?.coordinates) {
                            employeeCoordinates = emp.extendedProps.coordinates;
                        }
                    }
                }
            }

            // Process each day
            for(let d in byDay) {
                const dayEvents = byDay[d];
                
                // Add commute FROM home (before first event)
                // WICHTIG: Commute-Events werden VOR den normalen Events eingefügt,
                // damit sie zuerst gerendert werden und unter den normalen Events liegen
                const commuteStartEvents = [];
                if(dayEvents.length > 0 && (employeeHomeZone || employeeCoordinates)) {
                    const firstEvent = dayEvents[0];
                    const firstZone = firstEvent.extendedProps?.zone;
                    const firstPoolId = firstEvent.extendedProps?.poolId;
                    
                    let distKm = 0;
                    let travelMin = 0;
                    let usedCoordinates = false;
                    
                    // Versuche zuerst Koordinaten zu verwenden
                    if (employeeCoordinates && firstPoolId) {
                        const poolItem = appData.pool?.find(p => p.id === firstPoolId);
                        const poolCoords = poolItem?.extendedProps?.coordinates;
                        
                        if (poolCoords && poolCoords.lat && poolCoords.lng) {
                            distKm = calculateHaversineDistance(
                                employeeCoordinates.lat, employeeCoordinates.lng,
                                poolCoords.lat, poolCoords.lng
                            );
                            distKm = Math.round(distKm * 1.4 * 10) / 10; // Straßenfaktor 1.4
                            const avgSpeedKmH = 25;
                            travelMin = Math.max(5, Math.round((distKm / avgSpeedKmH) * 60));
                            usedCoordinates = true;
                        }
                    }
                    
                    // Fallback: Zone-basierte Berechnung
                    if (!usedCoordinates && firstZone && employeeHomeZone) {
                        distKm = getZoneDistance(employeeHomeZone, firstZone);
                        travelMin = getZoneTravelTime(employeeHomeZone, firstZone);
                    }
                    
                    if (travelMin > 0) {
                        const startMin = parseTimeToMinutes(firstEvent.start);
                        const commuteStart = startMin - travelMin;
                        
                        if(commuteStart >= TIMELINE_START_HOUR * 60) {
                            commuteStartEvents.push({
                                id: 'commute-start-' + d + '-' + firstEvent.id,
                                title: `🏠→ ${travelMin}min (${distKm.toFixed(1)}km)${usedCoordinates ? '📍' : ''}`,
                                start: minutesToTime(commuteStart),
                                end: firstEvent.start,
                                dayIndex: parseInt(d),
                                extendedProps: { 
                                    isTravel: true, 
                                    isCommute: true,
                                    commuteType: 'start',
                                    tour: tourId,
                                    fromZone: employeeHomeZone,
                                    toZone: firstZone,
                                    distanceKm: distKm,
                                    travelColor: getDistanceColor(distKm),
                                    usedCoordinates: usedCoordinates
                                }
                            });
                        }
                    }
                }
                
                // Füge Commute-Events ZUERST ein (werden zuerst gerendert)
                result.push(...commuteStartEvents);
                
                for(let i=0; i < dayEvents.length; i++) {
                    result.push(dayEvents[i]);
                    
                    if(i < dayEvents.length - 1) {
                        const current = dayEvents[i];
                        const next = dayEvents[i+1];
                        const endMin = parseTimeToMinutes(current.end);
                        const startMin = parseTimeToMinutes(next.start);
                        const diffMin = startMin - endMin;

                        if(diffMin > 0 && diffMin <= 120) { // Max 2h gap
                            // Calculate distance - prefer coordinates, fallback to zones
                            const fromZone = current.extendedProps?.zone;
                            const toZone = next.extendedProps?.zone;
                            const coords1 = current.extendedProps?.coordinates;
                            const coords2 = next.extendedProps?.coordinates;
                            
                            // Verwende Koordinaten wenn vorhanden, sonst Zonen
                            let distKm;
                            let usedCoordinates = false;
                            if (coords1?.lat && coords1?.lng && coords2?.lat && coords2?.lng) {
                                distKm = calculateHaversineDistance(coords1.lat, coords1.lng, coords2.lat, coords2.lng);
                                distKm = Math.round(distKm * 1.3 * 10) / 10; // Faktor 1.3 für Straßenumwege
                                usedCoordinates = true;
                            } else {
                                distKm = getZoneDistance(fromZone, toZone);
                            }
                            const travelColor = getDistanceColor(distKm);
                            
                            result.push({
                                id: 'travel-' + current.id + '-' + next.id,
                                title: `${Math.round(diffMin)}min (${distKm}km)${usedCoordinates ? '📍' : ''}`,
                                start: current.end,
                                end: next.start,
                                dayIndex: current.dayIndex,
                                extendedProps: { 
                                    isTravel: true, 
                                    tour: current.extendedProps?.tour,
                                    fromZone: fromZone,
                                    toZone: toZone,
                                    distanceKm: distKm,
                                    travelColor: travelColor,
                                    usedCoordinates: usedCoordinates
                                }
                            });
                        }
                    }
                }
                
                // Add commute TO home (after last event)
                // WICHTIG: Commute-Events werden NACH den normalen Events eingefügt,
                // aber sie werden trotzdem zuerst gerendert (durch Sortierung)
                const commuteEndEvents = [];
                if(dayEvents.length > 0 && (employeeHomeZone || employeeCoordinates)) {
                    const lastEvent = dayEvents[dayEvents.length - 1];
                    const lastZone = lastEvent.extendedProps?.zone;
                    const lastPoolId = lastEvent.extendedProps?.poolId;
                    
                    let distKm = 0;
                    let travelMin = 0;
                    let usedCoordinates = false;
                    
                    // Versuche zuerst Koordinaten zu verwenden
                    if (employeeCoordinates && lastPoolId) {
                        const poolItem = appData.pool?.find(p => p.id === lastPoolId);
                        const poolCoords = poolItem?.extendedProps?.coordinates;
                        
                        if (poolCoords && poolCoords.lat && poolCoords.lng) {
                            distKm = calculateHaversineDistance(
                                poolCoords.lat, poolCoords.lng,
                                employeeCoordinates.lat, employeeCoordinates.lng
                            );
                            distKm = Math.round(distKm * 1.4 * 10) / 10; // Straßenfaktor 1.4
                            const avgSpeedKmH = 25;
                            travelMin = Math.max(5, Math.round((distKm / avgSpeedKmH) * 60));
                            usedCoordinates = true;
                        }
                    }
                    
                    // Fallback: Zone-basierte Berechnung
                    if (!usedCoordinates && lastZone && employeeHomeZone) {
                        distKm = getZoneDistance(lastZone, employeeHomeZone);
                        travelMin = getZoneTravelTime(lastZone, employeeHomeZone);
                    }
                    
                    if (travelMin > 0) {
                        const endMin = parseTimeToMinutes(lastEvent.end);
                        const commuteEnd = endMin + travelMin;
                        
                        if(commuteEnd <= TIMELINE_END_HOUR * 60) {
                            commuteEndEvents.push({
                                id: 'commute-end-' + d + '-' + lastEvent.id,
                                title: `→🏠 ${travelMin}min (${distKm.toFixed(1)}km)${usedCoordinates ? '📍' : ''}`,
                                start: lastEvent.end,
                                end: minutesToTime(commuteEnd),
                                dayIndex: parseInt(d),
                                extendedProps: { 
                                    isTravel: true, 
                                    isCommute: true,
                                    commuteType: 'end',
                                    tour: tourId,
                                    fromZone: lastZone,
                                    toZone: employeeHomeZone,
                                    distanceKm: distKm,
                                    travelColor: getDistanceColor(distKm),
                                    usedCoordinates: usedCoordinates
                                }
                            });
                        }
                    }
                }
                
                // Füge Commute-Events NACH den normalen Events ein
                result.push(...commuteEndEvents);
            }
            return result;
        }

        function parseTimeToMinutes(timeStr) {
            if(!timeStr) return 0;
            const parts = timeStr.split(':');
            return parseInt(parts[0] || 0) * 60 + parseInt(parts[1] || 0);
        }

        function minutesToTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        function renderCompareBoard(container, events, selectedDayIndex) {
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            
            // Reset container styles from dashboard
            container.style.display = 'grid';
            container.style.gridTemplateColumns = `50px repeat(${appData.tours.length}, 1fr)`;
            container.style.padding = '';
            container.style.overflowY = '';
            container.style.height = '';
            container.innerHTML = '';

            // Time Column
            const pxPerMinCol = getPixelsPerMinute();
            const hourHeightCol = 60 * pxPerMinCol;
            const timeCol = document.createElement('div');
            timeCol.className = 'time-column';
            for(let h = TIMELINE_START_HOUR; h < TIMELINE_END_HOUR; h++) {
                const l = document.createElement('div');
                l.className = 'time-label';
                l.style.height = hourHeightCol + 'px';
                l.textContent = h + ':00';
                timeCol.appendChild(l);
            }
            container.appendChild(timeCol);

            // Tour Columns
            appData.tours.forEach(tour => {
                const tourEvents = events.filter(evt => evt.extendedProps?.tour === tour.id);

                const tourCard = document.createElement('div');
                tourCard.className = 'week-day-card';
                // Drag & Drop Handlers
                tourCard.ondragover = (e) => allowDrop(e);
                tourCard.ondragleave = (e) => removeDropHighlight(e);
                tourCard.ondrop = (e) => handleDrop(e, selectedDayIndex, tour.id);

                const header = document.createElement('div');
                header.className = 'week-day-header';
                const realCount = filterRealEvents(tourEvents).length;
                
                // Get assigned employee name
                const employee = tour.employeeId ? appData.employees.find(e => e.id === tour.employeeId) : null;
                const employeeName = employee ? employee.name : '';
                
                // Calculate total hours for this tour (all days) - biweekly counts half
                const allTourEvents = filterRealEvents(appData.events.filter(e => e.extendedProps?.tour === tour.id));
                let totalHours = 0;
                allTourEvents.forEach(e => {
                    totalHours += getEventDuration(e) / 60;
                });
                const isOverLimit = tour.weeklyHoursLimit && totalHours > tour.weeklyHoursLimit;
                const hoursInfo = tour.weeklyHoursLimit 
                    ? `<span style="font-size:0.6rem;padding:1px 4px;border-radius:3px;${isOverLimit ? 'background:rgba(239,68,68,0.15);color:var(--danger);' : 'background:rgba(16,185,129,0.15);color:var(--success);'}">${totalHours.toFixed(1)}/${tour.weeklyHoursLimit}h</span>`
                    : '';
                
                header.innerHTML = `
                    <div>
                        <div class="week-day-name">${tour.name}</div>
                        ${employeeName ? `<div style="font-size:0.65rem;color:var(--primary);font-weight:600;">👤 ${employeeName}</div>` : ''}
                        <div style="font-size:0.7rem;color:var(--text-muted);">${dayNames[selectedDayIndex]} ${hoursInfo}</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                         <span class="week-day-count">${realCount}</span>
                    </div>
                `;
                tourCard.appendChild(header);

                const list = document.createElement('div');
                list.className = 'week-day-body';
                const pxPerMinCompare = getPixelsPerMinute();
                const hourHeightCompare = 60 * pxPerMinCompare;
                const totalHeightCompare = TIMELINE_HOURS * hourHeightCompare;
                list.style.height = totalHeightCompare + 'px';
                // Lines: 30 min in 15m zoom, 15 min in 5m zoom
                const lineIntervalCompare = zoomLevel === 5 ? 15 : 30;
                const lineHeightCompare = lineIntervalCompare * pxPerMinCompare;
                list.style.backgroundSize = '100% ' + lineHeightCompare + 'px';
                list.onclick = (e) => handleColumnClick(e, selectedDayIndex, tour.id);
                
                // Find overlapping events for side-by-side display
                const overlappingPositions = findOverlappingEvents(tourEvents);
                
                // Sortiere Events: zuerst Travel-Events, dann normale Events
                // Damit Travel-Events zuerst gerendert werden und unter normalen Events liegen (niedrigerer z-index)
                const sortedEvents = [...tourEvents].sort((a, b) => {
                    const aIsTravel = a.extendedProps?.isTravel ? 1 : 0;
                    const bIsTravel = b.extendedProps?.isTravel ? 1 : 0;
                    if(aIsTravel !== bIsTravel) {
                        return bIsTravel - aIsTravel; // Travel-Events zuerst (1), dann normale Events (0)
                    }
                    // Bei gleichem Typ nach Startzeit sortieren
                    const aMin = parseTimeToMinutes(a.start);
                    const bMin = parseTimeToMinutes(b.start);
                    return aMin - bMin;
                });
                
                sortedEvents.forEach(evt => {
                    const overlapPosition = overlappingPositions.get(evt.id);
                    list.appendChild(createWeekEventRow(evt, false, overlapPosition));
                });

                tourCard.appendChild(list);
                container.appendChild(tourCard);
            });
        }

        function renderOverallView(container, events) {
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            
            // Reset container styles from dashboard
            container.style.display = 'grid';
            // Zeit-Spalte + (gefilterte Tage × gefilterte Touren) Spalten
            const filteredTours = overallTourFilter.length > 0 
                ? appData.tours.filter(t => overallTourFilter.includes(t.id))
                : appData.tours;
            const filteredDays = overallDayFilter.length;
            const totalColumns = filteredDays * filteredTours.length;
            // Mindestbreite für Spalten, damit horizontales Scrollen funktioniert
            const minColumnWidth = 200; // Mindestbreite pro Spalte in px
            container.style.gridTemplateColumns = `50px repeat(${totalColumns}, minmax(${minColumnWidth}px, 1fr))`;
            container.style.padding = '';
            container.style.width = 'max-content'; // max-content für horizontales Scrollen
            container.style.maxWidth = 'none'; // Keine max-width Begrenzung
            container.style.minWidth = `${50 + (totalColumns * minColumnWidth)}px`; // Mindestbreite für Scrollen
            container.style.height = 'calc(100vh - 250px)'; // Höhe anpassen, damit Platz für top-bar bleibt
            container.style.overflowY = 'auto';
            container.style.overflowX = 'auto';
            
            // Parent Container (main-content) soll NICHT scrollen, damit top-bar sichtbar bleibt
            const parent = container.parentElement;
            if(parent) {
                parent.style.overflowX = 'visible'; // Wichtig: nicht 'auto', damit top-bar nicht mitwandert
                parent.style.overflowY = 'auto';
                parent.style.minWidth = '0'; // Wichtig für flex children
                parent.style.position = 'relative';
            }
            
            // Stelle sicher, dass main-content NICHT scrollt (nur der Container selbst)
            const mainContent = document.querySelector('.main-content');
            if(mainContent && currentView === 'overall') {
                mainContent.style.overflowX = 'visible'; // Wichtig: nicht 'auto'
                mainContent.style.overflowY = 'auto';
            }
            container.innerHTML = '';

            // Time Column
            const pxPerMinCol = getPixelsPerMinute();
            const hourHeightCol = 60 * pxPerMinCol;
            const timeCol = document.createElement('div');
            timeCol.className = 'time-column';
            for(let h = TIMELINE_START_HOUR; h < TIMELINE_END_HOUR; h++) {
                const l = document.createElement('div');
                l.className = 'time-label';
                l.style.height = hourHeightCol + 'px';
                l.textContent = h + ':00';
                timeCol.appendChild(l);
            }
            container.appendChild(timeCol);

            // Für jeden Tag eine Spalte mit allen Touren (nur gefilterte Tage)
            for(let dayIndex = 0; dayIndex < 7; dayIndex++) {
                // Nur Tage anzeigen, die im Filter sind
                if(!overallDayFilter.includes(dayIndex)) continue;
                
                // Für jede Tour eine Spalte innerhalb des Tages (nur gefilterte Touren)
                appData.tours.forEach(tour => {
                    // Nur Touren anzeigen, die im Filter sind (oder alle, wenn Filter leer)
                    if(overallTourFilter.length > 0 && !overallTourFilter.includes(tour.id)) return;
                    
                    // WICHTIG: Filtere Events für diese spezifische Tour und diesen Tag
                    // Direkt aus dem events Array, nicht erst alle Events des Tages sammeln
                    const tourEvents = events.filter(evt => 
                        evt.dayIndex === dayIndex && 
                        evt.extendedProps?.tour === tour.id
                    );

                    const tourCard = document.createElement('div');
                    tourCard.className = 'week-day-card';
                    // Drag & Drop Handlers
                    tourCard.ondragover = (e) => allowDrop(e);
                    tourCard.ondragleave = (e) => removeDropHighlight(e);
                    tourCard.ondrop = (e) => handleDrop(e, dayIndex, tour.id);

                    const header = document.createElement('div');
                    header.className = 'week-day-header';
                    
                    // WICHTIG: Für die Stundenberechnung direkt aus appData.events lesen
                    // Filtere Events für diese spezifische Tour und diesen Tag
                    const allAppEvents = appData.events || [];
                    const tourIdStr = String(tour.id);
                    
                    // Filtere Events für diese spezifische Tour und diesen Tag
                    // WICHTIG: Nur Events mit korrekter Tour-ID und dayIndex, keine Travel-Events
                    const eventsForThisTourAndDay = allAppEvents.filter(evt => {
                        // Prüfe alle Bedingungen explizit
                        if(!evt) return false;
                        if(evt.dayIndex !== dayIndex) return false;
                        if(evt.extendedProps?.isTravel) return false;
                        // WICHTIG: Prüfe Tour-ID - Events ohne Tour-ID werden ignoriert
                        const eventTourId = evt.extendedProps?.tour;
                        if(!eventTourId) return false; // Events ohne Tour-ID ignorieren
                        return String(eventTourId) === tourIdStr;
                    });
                    
                    const realCount = eventsForThisTourAndDay.length;
                    
                    // Calculate workload for this specific tour and day - NUR Events dieser Tour
                    let totalMin = 0;
                    eventsForThisTourAndDay.forEach(e => {
                        // Nochmal explizit prüfen, dass Event zu dieser Tour gehört (mit String-Vergleich für Konsistenz)
                        const eventTourId = e.extendedProps?.tour;
                        if(String(eventTourId) === tourIdStr && e.dayIndex === dayIndex && !e.extendedProps?.isTravel) {
                            totalMin += getEventDuration(e);
                        }
                    });
                    const workloadPercent = Math.round((totalMin / TARGET_WORKLOAD_MINUTES) * 100);
                    const workloadLevel = totalMin < TARGET_WORKLOAD_MINUTES * 0.8 ? 'low' : (totalMin <= TARGET_WORKLOAD_MINUTES ? 'medium' : 'high');
                    
                    // Get assigned employee name
                    const employee = tour.employeeId ? appData.employees.find(e => e.id === tour.employeeId) : null;
                    const employeeName = employee ? employee.name : '';
                    
                    header.innerHTML = `
                        <div style="flex:1;">
                            <div class="week-day-name" style="font-size:0.75rem;">${dayNames[dayIndex]}</div>
                            <div class="week-day-name" style="font-size:0.7rem; font-weight:600; margin-top:2px;">${tour.name}</div>
                            ${employeeName ? `<div style="font-size:0.6rem;color:var(--primary);font-weight:600;">👤 ${employeeName}</div>` : ''}
                            <div class="workload-bar" style="margin-top:4px;">
                                <div class="workload-bar-fill level-${workloadLevel}" style="width:${Math.min(100, workloadPercent)}%"></div>
                            </div>
                            <div class="workload-text" style="font-size:0.65rem; margin-top:2px;">${Math.floor(totalMin/60)}h ${totalMin%60}m / 8h (${workloadPercent}%)</div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                             <span class="week-day-count">${realCount}</span>
                        </div>
                    `;
                    tourCard.appendChild(header);

                    const list = document.createElement('div');
                    list.className = 'week-day-body';
                    const pxPerMinCompare = getPixelsPerMinute();
                    const hourHeightCompare = 60 * pxPerMinCompare;
                    const totalHeightCompare = TIMELINE_HOURS * hourHeightCompare;
                    list.style.height = totalHeightCompare + 'px';
                    // Lines: 30 min in 15m zoom, 15 min in 5m zoom
                    const lineIntervalCompare = zoomLevel === 5 ? 15 : 30;
                    const lineHeightCompare = lineIntervalCompare * pxPerMinCompare;
                    list.style.backgroundSize = '100% ' + lineHeightCompare + 'px';
                    list.onclick = (e) => handleColumnClick(e, dayIndex, tour.id);
                    
                    // Find biweekly pairs for side-by-side display
                    const biweeklyPairs = findBiweeklyPairs(tourEvents);
                    
                    // Sortiere Events: zuerst Travel-Events, dann normale Events
                    // Damit Travel-Events zuerst gerendert werden und unter normalen Events liegen (niedrigerer z-index)
                    const sortedEvents = [...tourEvents].sort((a, b) => {
                        const aIsTravel = a.extendedProps?.isTravel ? 1 : 0;
                        const bIsTravel = b.extendedProps?.isTravel ? 1 : 0;
                        if(aIsTravel !== bIsTravel) {
                            return bIsTravel - aIsTravel; // Travel-Events zuerst (1), dann normale Events (0)
                        }
                        // Bei gleichem Typ nach Startzeit sortieren
                        const aMin = parseTimeToMinutes(a.start);
                        const bMin = parseTimeToMinutes(b.start);
                        return aMin - bMin;
                    });
                    
                    sortedEvents.forEach(evt => {
                        const biweeklyPosition = biweeklyPairs.get(evt.id);
                        list.appendChild(createWeekEventRow(evt, false, biweeklyPosition));
                    });

                    tourCard.appendChild(list);
                    container.appendChild(tourCard);
                });
            }
        }

        function renderWeekBoard(container, events) {
        const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            const pxPerMin = getPixelsPerMinute();
            const hourHeight = 60 * pxPerMin;
            const totalHeight = TIMELINE_HOURS * hourHeight;
        // Get selected tour for filtering
            const tourSelect = document.getElementById('tourSelect');
            const selectedTour = tourSelect ? tourSelect.value : null;
            
            // Reset container styles from dashboard/overall view
            container.style.display = 'grid';
            container.style.gridTemplateColumns = '50px repeat(7, 1fr)';
            container.style.padding = '';
            container.style.overflowY = '';
            container.style.overflowX = ''; // Reset from overall view
            container.style.height = '';
            container.style.width = ''; // Reset from overall view
            container.style.minWidth = ''; // Reset from overall view
            container.style.maxWidth = ''; // Reset from overall view
            // Reset parent container styles
            const parent = container.parentElement;
            if(parent) {
                parent.style.overflowX = '';
                parent.style.minWidth = '';
            }
            container.innerHTML = '';

            // Get all real events for conflict checking
            const allRealEvents = filterRealEvents(appData.events);

            // Time Column
            const timeCol = document.createElement('div');
            timeCol.className = 'time-column';
            for(let h = TIMELINE_START_HOUR; h < TIMELINE_END_HOUR; h++) {
                const l = document.createElement('div');
                l.className = 'time-label';
                l.style.height = hourHeight + 'px';
                l.textContent = h + ':00';
                timeCol.appendChild(l);
            }
            container.appendChild(timeCol);

            // Day Columns
            for(let dayIndex = 0; dayIndex < 7; dayIndex++) {
                let dayEvents = events.filter(evt => evt.dayIndex === dayIndex);
                
                // Apply search filter
                if(searchTerm) {
                    dayEvents = dayEvents.filter(e => 
                        e.extendedProps?.isTravel || 
                        e.title?.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                // Apply type filter
                if(typeFilter !== 'all') {
                    dayEvents = dayEvents.filter(e => 
                        e.extendedProps?.isTravel || 
                        (e.extendedProps?.types || []).includes(typeFilter)
                    );
                }

                const dayCard = document.createElement('div');
                dayCard.className = 'week-day-card';
                // Drag & Drop Handlers
                dayCard.ondragover = (e) => allowDrop(e);
                dayCard.ondragleave = (e) => removeDropHighlight(e);
                dayCard.ondrop = (e) => handleDrop(e, dayIndex);

                const header = document.createElement('div');
                header.className = 'week-day-header';
                const realCount = filterRealEvents(dayEvents).length;
                
                // Calculate workload - WICHTIG: Nur Events der ausgewählten Tour berücksichtigen
                const eventsForWorkload = selectedTour 
                    ? appData.events.filter(evt => 
                        evt.dayIndex === dayIndex && 
                        evt.extendedProps?.tour === selectedTour &&
                        !evt.extendedProps?.isTravel
                    )
                    : appData.events.filter(evt => 
                        evt.dayIndex === dayIndex && 
                        !evt.extendedProps?.isTravel
                    );
                let totalMin = 0;
                eventsForWorkload.forEach(e => {
                    totalMin += getEventDuration(e);
                });
                const workloadPercent = Math.round((totalMin / TARGET_WORKLOAD_MINUTES) * 100);
                const workloadLevel = totalMin < TARGET_WORKLOAD_MINUTES * 0.8 ? 'low' : (totalMin <= TARGET_WORKLOAD_MINUTES ? 'medium' : 'high');
                const workload = {
                    minutes: totalMin,
                    percent: workloadPercent,
                    level: workloadLevel
                };
                
                header.innerHTML = `
                    <div style="flex:1;">
                        <div class="week-day-name">${dayNames[dayIndex]}</div>
                        <div class="workload-bar">
                            <div class="workload-bar-fill level-${workload.level}" style="width:${Math.min(100, workload.percent)}%"></div>
                        </div>
                        <div class="workload-text">${Math.floor(workload.minutes/60)}h ${workload.minutes%60}m / 8h (${workload.percent}%)</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                         <span class="week-day-count">${realCount}</span>
                    </div>
                `;
                dayCard.appendChild(header);

                const list = document.createElement('div');
                list.className = 'week-day-body';
                list.style.height = totalHeight + 'px';
                // Lines: 30 min in 15m zoom, 15 min in 5m zoom
                const lineInterval = zoomLevel === 5 ? 15 : 30;
                const lineHeight = lineInterval * pxPerMin;
                list.style.backgroundSize = '100% ' + lineHeight + 'px';
                list.onclick = (e) => handleColumnClick(e, dayIndex);
                
                // Find overlapping events for side-by-side display
                const overlappingPositions = findOverlappingEvents(dayEvents);
                
                // Sortiere Events: zuerst Travel-Events, dann normale Events
                // Damit Travel-Events zuerst gerendert werden und unter normalen Events liegen (niedrigerer z-index)
                const sortedDayEvents = [...dayEvents].sort((a, b) => {
                    const aIsTravel = a.extendedProps?.isTravel ? 1 : 0;
                    const bIsTravel = b.extendedProps?.isTravel ? 1 : 0;
                    if(aIsTravel !== bIsTravel) {
                        return bIsTravel - aIsTravel; // Travel-Events zuerst (1), dann normale Events (0)
                    }
                    // Bei gleichem Typ nach Startzeit sortieren
                    const aMin = parseTimeToMinutes(a.start);
                    const bMin = parseTimeToMinutes(b.start);
                    return aMin - bMin;
                });
                
                sortedDayEvents.forEach(evt => {
                    const conflicts = getEventConflicts(evt, allRealEvents);
                    const overlapPosition = overlappingPositions.get(evt.id);
                    list.appendChild(createWeekEventRow(evt, conflicts.length > 0, overlapPosition));
                });

                dayCard.appendChild(list);
                container.appendChild(dayCard);
            }
        }

        // Find all overlapping events and assign positions for side-by-side display
        function findOverlappingEvents(events) {
            const positions = new Map();
            const realEvents = filterRealEvents(events);
            
            // Gruppiere Events nach Überlappungen
            const groups = [];
            const processed = new Set();
            
            for(let i = 0; i < realEvents.length; i++) {
                if(processed.has(realEvents[i].id)) continue;
                
                const group = [realEvents[i]];
                processed.add(realEvents[i].id);
                
                const start1 = parseTimeToMinutes(realEvents[i].start);
                const end1 = parseTimeToMinutes(realEvents[i].end);
                
                // Finde alle Events, die mit diesem Event überlappen
                for(let j = i + 1; j < realEvents.length; j++) {
                    if(processed.has(realEvents[j].id)) continue;
                    
                    const start2 = parseTimeToMinutes(realEvents[j].start);
                    const end2 = parseTimeToMinutes(realEvents[j].end);
                    
                    // Prüfe ob Events überlappen
                    if(start1 < end2 && end1 > start2) {
                        group.push(realEvents[j]);
                        processed.add(realEvents[j].id);
                    }
                }
                
                // Nur Gruppen mit mehr als einem Event speichern
                if(group.length > 1) {
                    groups.push(group);
                }
            }
            
            // Weise Positionen zu
            groups.forEach(group => {
                const numEvents = group.length;
                
                // Sortiere nach Startzeit für konsistente Positionierung
                group.sort((a, b) => {
                    const startA = parseTimeToMinutes(a.start);
                    const startB = parseTimeToMinutes(b.start);
                    return startA - startB;
                });
                
                // Weise Positionen zu basierend auf Anzahl der überlappenden Events
                group.forEach((evt, index) => {
                    if(numEvents === 2) {
                        // Zwei Events: left und right
                        positions.set(evt.id, index === 0 ? 'left' : 'right');
                    } else if(numEvents === 3) {
                        // Drei Events: left, middle, right
                        positions.set(evt.id, index === 0 ? 'left' : index === 1 ? 'middle' : 'right');
                    } else {
                        // Mehr als 3 Events: verteile gleichmäßig
                        const positionNames = ['left', 'middle-left', 'middle-right', 'right'];
                        const posIndex = Math.min(index, positionNames.length - 1);
                        positions.set(evt.id, positionNames[posIndex]);
                    }
                });
            });
            
            return positions;
        }
        
        // Find biweekly events that overlap and should be displayed side by side (deprecated, use findOverlappingEvents)
        function findBiweeklyPairs(events) {
            return findOverlappingEvents(events);
        }

        function handleColumnClick(e, dayIndex, tourId = null) {
            // Only trigger if clicking on the body itself, not on an event
            if(e.target.closest('.week-event-row')) return;
            
            const pxPerMin = getPixelsPerMinute();
            const snapMin = getSnapMinutes();
            const rect = e.currentTarget.getBoundingClientRect();
            const offsetY = e.clientY - rect.top + e.currentTarget.scrollTop;
            const totalMin = Math.floor(offsetY / pxPerMin) + (TIMELINE_START_HOUR * 60);
            const snappedMin = Math.floor(totalMin / snapMin) * snapMin;
            const startTime = minutesToTime(Math.max(TIMELINE_START_HOUR * 60, Math.min((TIMELINE_END_HOUR - 1) * 60 + 45, snappedMin)));
            const endMin = snappedMin + DEFAULT_DURATION_MIN;
            const endTime = minutesToTime(Math.min(TIMELINE_END_HOUR * 60, endMin));
            
            const opts = {
                start: startTime,
                end: endTime,
                dayIndex: dayIndex
            };
            if(tourId) opts.tour = tourId;
            
            openEventModal(null, opts);
        }

        function createWeekEventRow(evt, hasConflict = false, overlapPosition = null) {
            const pxPerMin = getPixelsPerMinute();
            const row = document.createElement('div');
            row.className = 'week-event-row';
            row.setAttribute('data-event-id', evt.id);
            if(evt.extendedProps?.isTravel) row.classList.add('is-travel');
            if(evt.extendedProps?.rhythm === 'biweekly') row.classList.add('is-biweekly');
            if(evt.extendedProps?.rhythm === 'fourweekly') row.classList.add('is-fourweekly');
            if(hasConflict) row.classList.add('has-conflict');
            
            // Unterstütze alle Überlappungspositionen
            if(overlapPosition) {
                if(overlapPosition === 'left') {
                    row.classList.add('overlap-left');
                } else if(overlapPosition === 'right') {
                    row.classList.add('overlap-right');
                } else if(overlapPosition === 'middle') {
                    row.classList.add('overlap-middle');
                } else if(overlapPosition === 'middle-left') {
                    row.classList.add('overlap-middle-left');
                } else if(overlapPosition === 'middle-right') {
                    row.classList.add('overlap-middle-right');
                }
                // Rückwärtskompatibilität für biweekly
                if(overlapPosition === 'left') row.classList.add('biweekly-left');
                if(overlapPosition === 'right') row.classList.add('biweekly-right');
            }
            
            if(selectedEvents.has(evt.id)) row.classList.add('selected');
            
            // Positioning logic: offset by TIMELINE_START_HOUR, scaled by zoom
            const startMin = parseTimeToMinutes(evt.start) - (TIMELINE_START_HOUR * 60);
            const endMin = parseTimeToMinutes(evt.end) - (TIMELINE_START_HOUR * 60);
            const durationMin = endMin - startMin;
            
            // Für Travel-Events (An-/Rückfahrt): Stelle sicher, dass sie genau bis zur Oberkante/Unterkante
            // des normalen Events reichen, ohne sich zu überlappen
            // Die Anfahrt endet bei firstEvent.start, der Einsatz startet bei firstEvent.start
            // WICHTIG: Für Commute-Events (An-/Rückfahrt) die Höhe so anpassen, dass sie genau bis zur
            // Oberkante/Unterkante des normalen Events reichen, ohne sich zu überlappen
            let topPosition = Math.max(0, startMin * pxPerMin);
            let heightValue = Math.max(20, durationMin * pxPerMin);
            
            // Für Commute-Events: Stelle sicher, dass sie genau bis zur Grenze reichen
            // ohne sich zu überlappen (endMin der Anfahrt = startMin des Einsatzes)
            if(evt.extendedProps?.isCommute && durationMin > 0) {
                // Die Anfahrt endet bei firstEvent.start, also sollte die Höhe genau
                // bis zur top Position des Einsatzes reichen
                // Aber eigentlich sollte das bereits korrekt sein, da endMin = startMin des Einsatzes
                // Das Problem könnte sein, dass beide Events die gleiche top Position haben
                // Lösung: Für Commute-Events die Höhe leicht reduzieren, damit sie nicht überlappen
                // Oder: Sicherstellen, dass die Anfahrt-Events einen niedrigeren z-index haben
            }
            
            row.style.top = topPosition + 'px';
            row.style.height = heightValue + 'px';
            
            // Apply zone color
            const zone = evt.extendedProps?.zone;
            if(zone && ZONE_COLORS[zone] && !evt.extendedProps?.isTravel) {
                row.style.borderLeftColor = ZONE_COLORS[zone];
            }

            if(!evt.extendedProps?.isTravel) {
                row.draggable = true;
                row.ondragstart = (e) => handleDragStart(e, 'event', evt.id);
                
                // Context menu on right click
                row.oncontextmenu = (e) => {
                    e.stopPropagation();
                    showContextMenu(e, evt);
                };
                
                row.onclick = (e) => {
                    e.stopPropagation(); // Prevent column click
                    if (row.getAttribute('data-dragging') === 'true') return;
                    
                    // Multi-select with Ctrl key
                    if(e.ctrlKey || e.metaKey) {
                        if(selectedEvents.has(evt.id)) {
                            selectedEvents.delete(evt.id);
                            row.classList.remove('selected');
                        } else {
                            selectedEvents.add(evt.id);
                            row.classList.add('selected');
                        }
                        return;
                    }
                    
                    // Normal click - clear selection and open modal
                    clearEventSelection();
                    currentEvent = evt;
                    openEventModal(evt);
                };
                
                // Add resize handles (top and bottom)
                const resizeHandleTop = document.createElement('div');
                resizeHandleTop.className = 'resize-handle resize-top';
                resizeHandleTop.onmousedown = (e) => startResize(e, evt, row, 'top');
                row.appendChild(resizeHandleTop);
                
                const resizeHandleBottom = document.createElement('div');
                resizeHandleBottom.className = 'resize-handle resize-bottom';
                resizeHandleBottom.onmousedown = (e) => startResize(e, evt, row, 'bottom');
                row.appendChild(resizeHandleBottom);
                
                // Content
                const content = document.createElement('div');
                content.className = 'event-content';
                content.style.pointerEvents = 'none';
                
                // Type badges
                const types = evt.extendedProps?.types || [];
                const typeBadges = types.map(t => {
                    const labels = { care: 'Pflege', house: 'HW', social: 'Betr.', other: 'Sonst.' };
                    return `<span class="type-badge type-${t}">${labels[t] || t}</span>`;
                }).join('');
                
                // Zone display (like in pool)
                const zone = evt.extendedProps?.zone || 'Keine Zone';
                const zoneColor = ZONE_COLORS[zone] || 'var(--primary)';
                
                // Prüfe ob Koordinaten vorhanden sind (aus Pool-Item)
                const poolId = evt.extendedProps?.poolId;
                let hasCoordinates = false;
                if (poolId) {
                    const poolItem = appData.pool?.find(p => p.id === poolId);
                    if (poolItem) {
                        const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
                        hasCoordinates = coordinates && coordinates.lat && coordinates.lng;
                    }
                }
                const coordIcon = hasCoordinates ? '<span style="font-size:0.7rem;opacity:0.8;margin-left:4px;" title="Koordinaten vorhanden">📍</span>' : '';
                
                const zoneDisplay = `<div class="event-zone" style="color:var(--text-muted);display:flex;align-items:center;gap:4px;margin-top:2px;font-size:0.7rem;">
                    <span style="width:4px;height:4px;background:${zoneColor};border-radius:2px;display:inline-block;flex-shrink:0;"></span>
                    <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${getZoneWithPostalCode(zone)}</span>
                    ${coordIcon}
                </div>`;
                
                content.innerHTML = `
                    <div class="event-title">${evt.title}${hasCoordinates ? ' <span style="font-size:0.7rem;opacity:0.7;">📍</span>' : ''}</div>
                    <div class="event-time">${evt.start} - ${evt.end}</div>
                    <div class="event-badges">${typeBadges}</div>
                    ${zoneDisplay}
                `;
                row.appendChild(content);
            } else {
                // Travel event styling with distance color
                const travelColor = evt.extendedProps?.travelColor || '#64748b';
                const isCommute = evt.extendedProps?.isCommute;
                const commuteType = evt.extendedProps?.commuteType;
                const distKm = evt.extendedProps?.distanceKm || 0;
                const fromZone = evt.extendedProps?.fromZone;
                const toZone = evt.extendedProps?.toZone;
                
                // Hover-Handler für Fahrzeit-Vorschläge
                row.onmouseenter = (e) => {
                    showTravelTimeSuggestions(e, evt, distKm, fromZone, toZone);
                };
                row.onmouseleave = () => {
                    hideTravelTimeTooltip();
                };
                
                // Apply colored stripe pattern based on distance
                if(isCommute) {
                    // Commute (An-/Abfahrt) - special styling
                    row.style.background = `repeating-linear-gradient(
                        ${commuteType === 'start' ? '135deg' : '-135deg'},
                        ${travelColor}30,
                        ${travelColor}30 3px,
                        ${travelColor}15 3px,
                        ${travelColor}15 6px
                    )`;
                    row.style.borderLeft = `3px solid ${travelColor}`;
                    row.classList.add('commute-event');
                } else {
                    // Normal travel between events
                    row.style.background = `repeating-linear-gradient(
                        45deg,
                        ${travelColor}25,
                        ${travelColor}25 4px,
                        ${travelColor}10 4px,
                        ${travelColor}10 8px
                    )`;
                    row.style.borderLeft = `3px solid ${travelColor}`;
                }
                
                row.style.borderRadius = 'var(--radius-sm)';
                
                // Create travel content
                const travelContent = document.createElement('div');
                travelContent.style.cssText = 'display:flex; align-items:center; gap:4px; padding:2px 6px; font-size:0.7rem; color:var(--text-muted);';
                
                const icon = isCommute ? (commuteType === 'start' ? '🏠→' : '→🏠') : '🚗';
                travelContent.innerHTML = `<span style="opacity:0.8;">${icon}</span><span style="font-weight:600; color:${travelColor};">${evt.title}</span>`;
                
                row.appendChild(travelContent);
                row.title = `${isCommute ? (commuteType === 'start' ? 'Anfahrt vom Wohnort' : 'Rückfahrt zum Wohnort') : 'Fahrt'}: ${evt.extendedProps?.fromZone || '?'} → ${evt.extendedProps?.toZone || '?'} (${distKm || '?'} km)`;
            }

            return row;
        }

        // --- RESIZE FUNCTIONALITY ---
        let resizeData = null;

        function startResize(e, evt, row, direction) {
            e.stopPropagation();
            e.preventDefault();
            
            // Disable hover effects during resize
            row.style.transition = 'none';
            row.style.zIndex = '100';
            
            const pxPerMin = getPixelsPerMinute();
            
            resizeData = {
                evt: evt,
                row: row,
                startY: e.clientY,
                originalHeight: row.offsetHeight,
                originalTop: row.offsetTop,
                originalStart: evt.start,
                originalEnd: evt.end,
                direction: direction, // 'top' or 'bottom'
                pxPerMin: pxPerMin
            };
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        function doResize(e) {
            if(!resizeData) return;
            
            const deltaY = e.clientY - resizeData.startY;
            const pxPerMin = resizeData.pxPerMin;
            const snapMin = getSnapMinutes(); // Use dynamic snap (5 or 15 min)
            const minHeight = 15 * pxPerMin; // Minimum 15 minutes
            
            let newHeight, newTop, newStart, newEnd;
            
            if(resizeData.direction === 'bottom') {
                // Resize from bottom - change end time
                newHeight = Math.max(minHeight, resizeData.originalHeight + deltaY);
                newTop = resizeData.originalTop;
                
                const startMin = parseTimeToMinutes(resizeData.originalStart);
                const durationMin = Math.round(newHeight / pxPerMin / snapMin) * snapMin; // Snap to zoom level
                const newEndMin = startMin + durationMin;
                
                newStart = resizeData.originalStart;
                newEnd = minutesToTime(Math.min(TIMELINE_END_HOUR * 60, newEndMin));
            } else {
                // Resize from top - change start time
                newHeight = Math.max(minHeight, resizeData.originalHeight - deltaY);
                const heightDiff = resizeData.originalHeight - newHeight;
                newTop = resizeData.originalTop + heightDiff;
                
                const endMin = parseTimeToMinutes(resizeData.originalEnd);
                const durationMin = Math.round(newHeight / pxPerMin / snapMin) * snapMin; // Snap to zoom level
                const newStartMin = endMin - durationMin;
                
                newStart = minutesToTime(Math.max(TIMELINE_START_HOUR * 60, newStartMin));
                newEnd = resizeData.originalEnd;
            }
            
            // Update visual
            resizeData.row.style.height = newHeight + 'px';
            resizeData.row.style.minHeight = newHeight + 'px';
            resizeData.row.style.top = newTop + 'px';
            
            // Update time display
            const timeDiv = resizeData.row.querySelector('.event-time');
            if(timeDiv) timeDiv.textContent = `${newStart} - ${newEnd}`;
        }

        function stopResize(e) {
            if(!resizeData) return;
            
            saveUndoState(); // Save state before resize
            
            const deltaY = e.clientY - resizeData.startY;
            const pxPerMin = resizeData.pxPerMin;
            const snapMin = getSnapMinutes(); // Use dynamic snap (5 or 15 min)
            const minHeight = 15 * pxPerMin;
            
            let newStart, newEnd;
            
            if(resizeData.direction === 'bottom') {
                const newHeight = Math.max(minHeight, resizeData.originalHeight + deltaY);
                const startMin = parseTimeToMinutes(resizeData.originalStart);
                const durationMin = Math.round(newHeight / pxPerMin / snapMin) * snapMin;
                const newEndMin = startMin + durationMin;
                
                newStart = resizeData.originalStart;
                newEnd = minutesToTime(Math.min(TIMELINE_END_HOUR * 60, newEndMin));
            } else {
                const newHeight = Math.max(minHeight, resizeData.originalHeight - deltaY);
                const endMin = parseTimeToMinutes(resizeData.originalEnd);
                const durationMin = Math.round(newHeight / pxPerMin / snapMin) * snapMin;
                const newStartMin = endMin - durationMin;
                
                newStart = minutesToTime(Math.max(TIMELINE_START_HOUR * 60, newStartMin));
                newEnd = resizeData.originalEnd;
            }
            
            // Update event
            const evt = appData.events.find(ev => ev.id === resizeData.evt.id);
            if(evt) {
                evt.start = newStart;
                evt.end = newEnd;
                queueSave();
            }
            
            // Reset styles
            resizeData.row.style.transition = '';
            resizeData.row.style.zIndex = '';
            resizeData.row.style.minHeight = '';
            
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            resizeData = null;
            
            refreshView();
        }

        // --- WEEK NAVIGATION (not used in static mode, kept for potential future use) ---
        function shiftWeek(step) {
            // Not used in static week mode
        }

        function updateWeekLabel() {
            // Not used in static week mode
        }

        function getTagClass(tagText) {
            const txt = (tagText || '').toLowerCase();
            if(txt.includes('wichtig') || txt.includes('dringend')) return 'danger';
            if(txt.includes('info') || txt.includes('hinweis')) return 'info';
            if(txt.includes('erledigt') || txt.includes('fertig')) return 'success';
            if(txt.includes('wartend') || txt.includes('offen')) return 'warning';
            return 'primary';
        }

        function calculateStats(events) {
            const realEvents = filterRealEvents(events || []);
            const travelEvents = (events || []).filter(e => e && e.extendedProps && e.extendedProps.isTravel);
            document.getElementById('hudCount').innerText = realEvents.length;
            
            let totalMin = 0;
            realEvents.forEach(e => {
                totalMin += getEventDuration(e);
            });
            const h = Math.floor(totalMin / 60);
            const m = Math.round(totalMin % 60);
            document.getElementById('hudDuration').innerText = `${h}h ${m}m`;

            let travelMin = 0;
            travelEvents.forEach(e => {
                const startMin = parseTimeToMinutes(e.start);
                const endMin = parseTimeToMinutes(e.end);
                travelMin += (endMin - startMin);
            });
            document.getElementById('hudTravel').innerText = `${travelMin}m`;
            
            // Update capacity display
            updateCapacityDisplay();
        }
        
        function updateCapacityDisplay() {
            // Calculate total available hours from all employees
            let availableHours = 0;
            (appData.employees || []).forEach(emp => {
                availableHours += (emp.weeklyHours || 40);
            });
            
            // Calculate total planned hours from all events (considering biweekly = half)
            let plannedMinutes = 0;
            const allRealEvents = filterRealEvents(appData.events || []);
            allRealEvents.forEach(e => {
                plannedMinutes += getEventDuration(e);
            });
            const plannedHours = plannedMinutes / 60;
            
            // Calculate remaining and percentage
            const remainingHours = Math.max(0, availableHours - plannedHours);
            const percent = availableHours > 0 ? Math.min(100, (plannedHours / availableHours) * 100) : 0;
            
            // Update display elements
            const capAvailable = document.getElementById('capAvailable');
            const capPlanned = document.getElementById('capPlanned');
            const capRemaining = document.getElementById('capRemaining');
            const capBar = document.getElementById('capBar');
            const capPercent = document.getElementById('capPercent');
            
            if(capAvailable) capAvailable.textContent = availableHours.toFixed(1) + 'h';
            if(capPlanned) capPlanned.textContent = plannedHours.toFixed(1) + 'h';
            if(capRemaining) {
                capRemaining.textContent = remainingHours.toFixed(1) + 'h';
                // Color based on remaining capacity
                if(remainingHours < 0) {
                    capRemaining.style.color = 'var(--danger)';
                    capRemaining.textContent = '+' + Math.abs(remainingHours).toFixed(1) + 'h Überlast';
                } else if(remainingHours < availableHours * 0.1) {
                    capRemaining.style.color = 'var(--warning)';
                } else {
                    capRemaining.style.color = 'var(--success)';
                }
            }
            
            if(capBar) {
                capBar.style.width = percent + '%';
                // Color gradient based on utilization
                if(percent > 100) {
                    capBar.style.background = 'var(--danger)';
                } else if(percent > 85) {
                    capBar.style.background = 'linear-gradient(90deg, var(--warning), var(--danger))';
                } else if(percent > 60) {
                    capBar.style.background = 'linear-gradient(90deg, var(--success), var(--primary))';
                } else {
                    capBar.style.background = 'linear-gradient(90deg, var(--primary-light), var(--primary))';
                }
            }
            
            if(capPercent) {
                capPercent.textContent = percent.toFixed(0) + '%';
                if(percent > 100) {
                    capPercent.style.color = 'var(--danger)';
                } else if(percent > 85) {
                    capPercent.style.color = 'var(--warning)';
                } else {
                    capPercent.style.color = 'var(--primary)';
                }
            }
            
            // Show hint if no employees are set up
            const capacityDisplay = document.getElementById('capacityDisplay');
            if(capacityDisplay && (!appData.employees || appData.employees.length === 0)) {
                capAvailable.textContent = '–';
                capPercent.textContent = '–';
                capRemaining.textContent = '–';
                capRemaining.style.color = 'var(--text-muted)';
            }
        }

        function queueSave() { 
            if(saveTimeout) clearTimeout(saveTimeout);
            const statusEl = document.getElementById('fileStatus');
            if(statusEl) statusEl.innerText = "Speichere...";
            saveTimeout = setTimeout(executeSave, SAVE_DEBOUNCE_MS);
        }
        
        async function executeSave() {
            if (!currentVariantId) {
                console.warn('Keine Variante ausgewählt, kann nicht speichern');
                return;
            }
            
            try {
                const response = await apiCall(`/api/data?variant_id=${currentVariantId}`, {
                    method: 'PUT',
                    body: JSON.stringify(appData)
                });
                
                if(!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                lastSaveTime = new Date();
                
                const statusEl = document.getElementById('fileStatus');
                if(statusEl) statusEl.innerText = "✅ Gespeichert";
                showToast('Gespeichert', 'success');
                
                updateLastSaveDisplay();
                updatePatientList();
            } catch(e) {
                console.error('Fehler beim Speichern:', e);
                const statusEl = document.getElementById('fileStatus');
                if(statusEl) statusEl.innerText = "❌ Fehler beim Speichern";
                showToast('Fehler beim Speichern auf dem Server', 'error');
            }
        }
        function updatePatientList() {
            const names = new Set();
            appData.events.forEach(e => names.add(e.title));
            appData.pool.forEach(p => names.add(p.title));
            const dl = document.getElementById('patientList'); dl.innerHTML='';
            names.forEach(n => { const op=document.createElement('option'); op.value=n; dl.appendChild(op); });
        }
        
        function formatTime(date) { 
            const d = new Date(date);
            if(isNaN(d.getTime())) return '00:00:00';
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        }
        
        // createPoolItem, openPoolModal, geocodePoolAddress, openManualCoordinatesModal, saveManualCoordinates, openPoolImportModal wurden bereits oben definiert
        
        function parseImportData(data, isFile) {
            const items = [];
            
            if(isFile) {
                // Excel-Datei parsen
                try {
                    // Prüfe ob SheetJS verfügbar ist
                    if(typeof XLSX === 'undefined') {
                        throw new Error('SheetJS Bibliothek nicht geladen. Bitte verwenden Sie CSV-Format oder Copy&Paste.');
                    }
                    
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                    
                    // Finde Spalten für Name, PLZ und Adresse
                    let nameColIndex = -1;
                    let plzColIndex = -1;
                    let addressColIndex = -1;
                    
                    if(jsonData.length > 0) {
                        const headerRow = jsonData[0];
                        // Suche nach Spaltennamen
                        headerRow.forEach((cell, index) => {
                            const cellLower = String(cell).toLowerCase();
                            if(cellLower.includes('name') || cellLower.includes('kunde') || cellLower.includes('kundenname')) {
                                nameColIndex = index;
                            }
                            if(cellLower.includes('plz') || cellLower.includes('postleitzahl') || cellLower.includes('postal')) {
                                plzColIndex = index;
                            }
                            if(cellLower.includes('adresse') || cellLower.includes('straße') || cellLower.includes('strasse') || cellLower.includes('street') || cellLower.includes('address')) {
                                addressColIndex = index;
                            }
                        });
                        
                        // Falls keine Header gefunden, verwende erste Spalten
                        if(nameColIndex === -1) nameColIndex = 0;
                        if(plzColIndex === -1) plzColIndex = 1;
                        if(addressColIndex === -1 && jsonData[0].length > 2) addressColIndex = 2;
                        
                        // Parse Datenzeilen (überspringe Header)
                        for(let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const name = String(row[nameColIndex] || '').trim();
                            const postalCode = String(row[plzColIndex] || '').trim();
                            const address = addressColIndex >= 0 ? String(row[addressColIndex] || '').trim() : '';
                            
                            if(name && postalCode) {
                                items.push({ name, postalCode, address: address || null });
                            }
                        }
                    }
                } catch(error) {
                    console.error('Fehler beim Parsen der Excel-Datei:', error);
                    throw new Error('Fehler beim Lesen der Excel-Datei: ' + error.message);
                }
            } else {
                // Text parsen (Copy&Paste)
                const lines = data.split('\n').filter(line => line.trim());
                
                lines.forEach(line => {
                    // Unterstütze verschiedene Trennzeichen: Tab, Semikolon, Komma
                    let parts = [];
                    if(line.includes('\t')) {
                        parts = line.split('\t');
                    } else if(line.includes(';')) {
                        parts = line.split(';');
                    } else if(line.includes(',')) {
                        parts = line.split(',');
                    } else {
                        // Versuche Leerzeichen als Trenner (mindestens 2 Leerzeichen oder Tab)
                        parts = line.split(/\s{2,}|\t/);
                        if(parts.length < 2) {
                            // Fallback: Einzelne Leerzeichen
                            const spaceIndex = line.indexOf(' ');
                            if(spaceIndex > 0) {
                                parts = [line.substring(0, spaceIndex), line.substring(spaceIndex + 1).trim()];
                            }
                        }
                    }
                    
                    if(parts.length >= 2) {
                        const name = parts[0].trim();
                        const postalCode = parts[1].trim();
                        const address = parts.length >= 3 ? parts[2].trim() : null;
                        
                        if(name && postalCode) {
                            items.push({ name, postalCode, address: address || null });
                        }
                    }
                });
            }
            
            return items;
        }
        
        function previewPoolImport() {
            const textarea = document.getElementById('poolImportTextarea');
            const text = textarea.value.trim();
            
            if(!text) {
                showToast('Bitte geben Sie Daten ein', 'warning');
                return;
            }
            
            try {
                const items = parseImportData(text, false);
                
                if(items.length === 0) {
                    showToast('Keine gültigen Daten gefunden', 'warning');
                    return;
                }
                
                // Zeige Vorschau
                const previewDiv = document.getElementById('poolImportPreview');
                const previewContent = document.getElementById('poolImportPreviewContent');
                
                let previewHTML = `<p style="margin:0 0 10px 0; font-size:0.85rem; color:var(--text-muted);">${items.length} Kunden gefunden:</p>`;
                previewHTML += '<div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:8px; font-size:0.8rem;">';
                previewHTML += '<div style="font-weight:600;">Name</div><div style="font-weight:600;">PLZ</div><div style="font-weight:600;">Adresse</div><div style="font-weight:600;">Zone</div>';
                
                items.forEach(item => {
                    const zone = getZoneFromPostalCode(item.postalCode) || 'Außerhalb';
                    previewHTML += `<div>${item.name}</div><div>${item.postalCode}</div><div>${item.address || '-'}</div><div style="color:${zone === 'Außerhalb' ? 'var(--warning)' : 'var(--success)'}">${zone}</div>`;
                });
                
                previewHTML += '</div>';
                previewContent.innerHTML = previewHTML;
                previewDiv.style.display = 'block';
            } catch(error) {
                showToast('Fehler bei Vorschau: ' + error.message, 'error');
            }
        }
        
        async function importPoolItems(items) {
            if(!items || items.length === 0) {
                showToast('Keine Daten zum Importieren', 'warning');
                return;
            }
            
            const autoGeocode = document.getElementById('poolImportAutoGeocode')?.checked || false;
            const progressDiv = document.getElementById('poolImportGeocodeProgress');
            const progressBar = document.getElementById('poolImportGeocodeProgressBar');
            const progressText = document.getElementById('poolImportGeocodeProgressText');
            const statusText = document.getElementById('poolImportGeocodeStatus');
            const executeBtn = document.getElementById('poolImportExecuteBtn');
            
            let imported = 0;
            let skipped = 0;
            const warnings = [];
            const poolItems = [];
            
            // Erstelle Pool-Items (ohne Koordinaten)
            items.forEach(item => {
                if(!item.name || !item.postalCode) {
                    skipped++;
                    return;
                }
                
                // Mappe PLZ zu Zone
                let zone = getZoneFromPostalCode(item.postalCode);
                if(!zone) {
                    zone = 'Außerhalb';
                    warnings.push(`${item.name}: PLZ ${item.postalCode} nicht gefunden`);
                }
                
                // Erstelle Pool-Item
                const poolItem = {
                    id: generateId(),
                    title: item.name.trim(),
                    zone: zone,
                    address: item.address || null,
                    postalCode: item.postalCode || null,
                    types: ['other']
                };
                
                poolItems.push(poolItem);
            });
            
            // Zeige Fortschrittsanzeige wenn Geocoding aktiviert
            if (autoGeocode && poolItems.length > 0) {
                const itemsWithAddress = poolItems.filter(p => p.address);
                if (itemsWithAddress.length > 0) {
                    progressDiv.style.display = 'block';
                    executeBtn.disabled = true;
                    executeBtn.textContent = '⏳ Importiere...';
                    
                    // Batch-Geocoding durchführen
                    let geocoded = 0;
                    let geocodeFailed = 0;
                    
                    for (let i = 0; i < itemsWithAddress.length; i++) {
                        const item = itemsWithAddress[i];
                        
                        // Update Progress
                        const progress = Math.round(((i + 1) / itemsWithAddress.length) * 100);
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${i + 1}/${itemsWithAddress.length}`;
                        statusText.textContent = `Ermittle Koordinaten für ${item.title}...`;
                        
                        try {
                            // Rate-Limiting: 1 Request pro Sekunde
                            if (i > 0) {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                            
                            const response = await fetch('/api/geocoding/geocode', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    address: item.address, 
                                    postalCode: item.postalCode, 
                                    city: 'Gelsenkirchen' 
                                })
                            });
                            
                            // Prüfe ob es ein Timeout war
                            if (response.status === 504) {
                                throw new Error('Timeout');
                            }
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                                throw new Error(errorData.error || `HTTP ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                if (!item.extendedProps) item.extendedProps = {};
                                item.extendedProps.coordinates = {
                                    lat: data.latitude,
                                    lng: data.longitude
                                };
                                geocoded++;
                            } else {
                                geocodeFailed++;
                                warnings.push(`${item.title}: Geocoding fehlgeschlagen`);
                            }
                        } catch (error) {
                            console.error(`Geocoding-Fehler für ${item.title}:`, error);
                            geocodeFailed++;
                            if (error.message && (error.message.includes('Timeout') || error.message.includes('504'))) {
                                warnings.push(`${item.title}: Geocoding-Timeout - bitte später erneut versuchen`);
                            } else if (error.message && error.message.includes('Unexpected token')) {
                                warnings.push(`${item.title}: Geocoding-Service-Fehler - bitte später erneut versuchen`);
                            } else {
                                warnings.push(`${item.title}: Geocoding-Fehler`);
                            }
                        }
                    }
                    
                    statusText.textContent = `Geocoding abgeschlossen: ${geocoded} erfolgreich, ${geocodeFailed} fehlgeschlagen`;
                }
            }
            
            // Füge alle Pool-Items hinzu
            poolItems.forEach(item => {
                appData.pool.push(item);
                imported++;
            });
            
            // Speichere Änderungen
            queueSave();
            renderPool();
            
            // Aktualisiere Kundenliste falls im Admin-Tab
            if (currentView === 'admin' && currentAdminTab === 'customers') {
                renderCustomerList();
            }
            
            // Verstecke Fortschrittsanzeige
            if (progressDiv) {
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            }
            
            if (executeBtn) {
                executeBtn.disabled = false;
                executeBtn.textContent = '✅ Importieren';
            }
            
            // Zeige Ergebnis
            let message = `${imported} Kunden erfolgreich importiert`;
            if (autoGeocode) {
                const geocodedCount = poolItems.filter(p => p.extendedProps?.coordinates).length;
                if (geocodedCount > 0) {
                    message += `, ${geocodedCount} mit Koordinaten`;
                }
            }
            if(skipped > 0) {
                message += `, ${skipped} übersprungen`;
            }
            if(warnings.length > 0) {
                message += `. ${warnings.length} Warnung(en)`;
                console.warn('Import-Warnungen:', warnings);
            }
            
            showToast(message, warnings.length > 0 ? 'warning' : 'success');
            closeModal('poolImportModal');
        }
        
        function handlePoolImportFile(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    let data;
                    const fileName = file.name.toLowerCase();
                    
                    if(fileName.endsWith('.csv')) {
                        // CSV-Datei als Text lesen
                        data = e.target.result;
                        const items = parseImportData(data, false);
                        await importPoolItems(items);
                    } else if(fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Excel-Datei mit SheetJS parsen
                        if(typeof XLSX === 'undefined') {
                            throw new Error('Excel-Import nicht verfügbar. SheetJS Bibliothek konnte nicht geladen werden. Bitte verwenden Sie CSV-Format oder Copy&Paste.');
                        }
                        data = e.target.result;
                        const items = parseImportData(data, true);
                        await importPoolItems(items);
                    } else {
                        throw new Error('Nicht unterstütztes Dateiformat. Bitte verwenden Sie .xlsx, .xls oder .csv');
                    }
                } catch(error) {
                    console.error('Import-Fehler:', error);
                    showToast('Fehler beim Import: ' + error.message, 'error');
                    
                    // Reset Button falls Fehler
                    const executeBtn = document.getElementById('poolImportExecuteBtn');
                    if (executeBtn) {
                        executeBtn.disabled = false;
                        executeBtn.textContent = '📥 Importieren';
                    }
                }
            };
            
            const fileName = file.name.toLowerCase();
            if(fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }
        
        async function handlePoolImportPaste() {
            const textarea = document.getElementById('poolImportTextarea');
            const text = textarea.value.trim();
            
            if(!text) {
                showToast('Bitte geben Sie Daten ein', 'warning');
                return;
            }
            
            try {
                const items = parseImportData(text, false);
                await importPoolItems(items);
            } catch(error) {
                console.error('Import-Fehler:', error);
                showToast('Fehler beim Import: ' + error.message, 'error');
                
                // Reset Button falls Fehler
                const executeBtn = document.getElementById('poolImportExecuteBtn');
                if (executeBtn) {
                    executeBtn.disabled = false;
                    executeBtn.textContent = '📥 Importieren';
                }
            }
        }
        function clearAllTooltips() {
            // Remove title attributes from ALL elements to clear native browser tooltips
            // This prevents tooltips from "hanging" when elements are removed from DOM
            const allElements = document.querySelectorAll('[title]');
            allElements.forEach(el => {
                el.removeAttribute('title');
            });
            
            // Hide all event rows temporarily to force tooltip removal
            // They will be recreated by refreshView() anyway
            const eventRows = document.querySelectorAll('.week-event-row');
            eventRows.forEach(row => {
                row.style.display = 'none';
            });
            
            // Force browser to process the changes
            // Use a synchronous approach with immediate style changes
            if(eventRows.length > 0) {
                // Trigger a reflow to ensure browser processes the display:none
                void document.body.offsetHeight;
            }
        }
        
        function moveBackToPool() {
            if(currentEvent) {
                clearAllTooltips(); // Clear tooltips before removing elements
                // Small delay to ensure browser processes tooltip removal
                setTimeout(() => {
                    // Prüfe ob bereits ein Pool-Item mit poolId existiert
                    const existingPoolId = currentEvent.extendedProps?.poolId;
                    let poolItem = null;
                    
                    if (existingPoolId) {
                        poolItem = appData.pool.find(p => p.id === existingPoolId);
                    }
                    
                    if (poolItem) {
                        // Pool-Item existiert bereits - kein Duplikat erstellen
                        // Aktualisiere ggf. Adresse/Koordinaten falls im Event vorhanden
                        if (currentEvent.extendedProps?.address && !poolItem.address) {
                            poolItem.address = currentEvent.extendedProps.address;
                        }
                        if (currentEvent.extendedProps?.postalCode && !poolItem.postalCode) {
                            poolItem.postalCode = currentEvent.extendedProps.postalCode;
                        }
                        if (currentEvent.extendedProps?.coordinates && !poolItem.extendedProps?.coordinates) {
                            if (!poolItem.extendedProps) poolItem.extendedProps = {};
                            poolItem.extendedProps.coordinates = currentEvent.extendedProps.coordinates;
                        }
                    } else {
                        // Neues Pool-Item erstellen mit Adresse/Koordinaten aus Event
                        const newPoolItem = {
                            id: existingPoolId || generateId(), 
                            title: currentEvent.title,
                            zone: currentEvent.extendedProps?.zone || 'Alt-/Neustadt',
                            types: currentEvent.extendedProps?.types || ['other']
                        };
                        
                        // Übernehme Adresse/Koordinaten aus Event falls vorhanden
                        if (currentEvent.extendedProps?.address) {
                            newPoolItem.address = currentEvent.extendedProps.address;
                        }
                        if (currentEvent.extendedProps?.postalCode) {
                            newPoolItem.postalCode = currentEvent.extendedProps.postalCode;
                        }
                        if (currentEvent.extendedProps?.coordinates) {
                            if (!newPoolItem.extendedProps) newPoolItem.extendedProps = {};
                            newPoolItem.extendedProps.coordinates = currentEvent.extendedProps.coordinates;
                        }
                        
                        appData.pool.push(newPoolItem);
                    }
                    
                    appData.events = appData.events.filter(e => e.id !== currentEvent.id);
                    queueSave(); 
                    closeModal('eventModal'); 
                    refreshView(); 
                    renderPool();
                }, 10);
            }
        }
        function saveEvent(){
            try {
                const t=document.getElementById('eventClient').value; 
                const z=document.getElementById('eventZone').value; 
                const tr=document.getElementById('eventTourSelect').value;
                if(!t || !t.trim()) {
                    showAlertModal('Fehler', 'Bitte geben Sie einen Namen ein.', 'error');
                    return;
                }
                let ty=[]; document.querySelectorAll('.event-cb:checked').forEach(c=>ty.push(c.value)); 
                if(!ty.length) ty=['other'];
                if(t){
                    const rhythm = document.getElementById('eventRhythm') ? document.getElementById('eventRhythm').value : 'weekly';
                    const tag = document.getElementById('eventTag') ? document.getElementById('eventTag').value.trim() : '';
                    
                    if(currentEvent && appData.events.find(e=>e.id===currentEvent.id)){
                        const e=appData.events.find(e=>e.id===currentEvent.id); 
                        
                        // Get updated times from input fields
                        const newStart = document.getElementById('eventStartTime').value;
                        const newEnd = document.getElementById('eventEndTime').value;
                        
                        saveUndoState(); // Save state before changes
                        
                        e.title=t.trim(); 
                        e.start = newStart || e.start;
                        e.end = newEnd || e.end;
                        
                        if(!e.extendedProps) e.extendedProps = {};
                        e.extendedProps.zone=z; 
                        e.extendedProps.tour=tr; 
                        e.extendedProps.types=ty;
                        e.extendedProps.rhythm = rhythm;
                        if(tag) e.extendedProps.tag = tag;
                        else delete e.extendedProps.tag;
                        
                        // Behalte poolId falls vorhanden (für Adresse/Koordinaten)
                        const modal = document.getElementById('eventModal');
                        if (modal && modal.dataset.fromPoolId) {
                            e.extendedProps.poolId = modal.dataset.fromPoolId;
                            
                            // Speichere auch Adresse/Koordinaten direkt im Event als Fallback
                            const poolItem = appData.pool?.find(p => p.id === modal.dataset.fromPoolId);
                            if (poolItem) {
                                if (poolItem.address) e.extendedProps.address = poolItem.address;
                                if (poolItem.postalCode) e.extendedProps.postalCode = poolItem.postalCode;
                                const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
                                if (coordinates) e.extendedProps.coordinates = coordinates;
                            }
                        } else if (e.extendedProps.poolId) {
                            // poolId bleibt erhalten - aktualisiere Adresse/Koordinaten aus Pool
                            const poolItem = appData.pool?.find(p => p.id === e.extendedProps.poolId);
                            if (poolItem) {
                                if (poolItem.address) e.extendedProps.address = poolItem.address;
                                if (poolItem.postalCode) e.extendedProps.postalCode = poolItem.postalCode;
                                const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
                                if (coordinates) e.extendedProps.coordinates = coordinates;
                            }
                        }
                        
                        // Handle repeat days for existing events too
                        const repeatDays = [];
                        document.querySelectorAll('.repeat-cb:checked').forEach(cb => {
                            const repeatDay = parseInt(cb.value);
                            if(repeatDay !== e.dayIndex) repeatDays.push(repeatDay);
                        });
                        
                        if(repeatDays.length > 0) {
                            repeatDays.forEach(rd => {
                                const repeatEvent = {
                                    id: generateId(),
                                    title: e.title,
                                    start: e.start,
                                    end: e.end,
                                    dayIndex: rd,
                                    extendedProps: { ...e.extendedProps }
                                };
                                appData.events.push(repeatEvent);
                            });
                        }
                        
                        // Entferne Pool-Item aus Pool wenn Event aus Pool erstellt wurde
                        if (modal && modal.dataset.fromPoolId) {
                            // Prüfe ob Pool-Item noch existiert (könnte bereits entfernt worden sein)
                            const poolItemExists = appData.pool.some(p => p.id === modal.dataset.fromPoolId);
                            if (poolItemExists) {
                                appData.pool = appData.pool.filter(p => p.id !== modal.dataset.fromPoolId);
                                renderPool();
                            }
                        }
                        
                        showToast('Einsatz aktualisiert', 'success');
                    } else {
                        const m=document.getElementById('eventModal');
                        if(!m || !m.dataset.start || !m.dataset.end) {
                            showAlertModal('Fehler', 'Start- oder Endzeit fehlt.', 'error');
                            return;
                        }
                        const dayIdx = parseInt(m.dataset.dayIndex) || 0;
                        const newEvent = {
                            id:generateId(), 
                            title:t.trim(), 
                            start:m.dataset.start, 
                            end:m.dataset.end,
                            dayIndex: dayIdx,
                            extendedProps:{zone:z, tour:tr, types:ty, rhythm: rhythm}
                        };
                        if(tag) newEvent.extendedProps.tag = tag;
                        
                        // Speichere poolId falls vorhanden (für Adresse/Koordinaten)
                        if(m.dataset.fromPoolId) {
                            newEvent.extendedProps.poolId = m.dataset.fromPoolId;
                            
                            // Speichere auch Adresse/Koordinaten direkt im Event als Fallback
                            const poolItem = appData.pool?.find(p => p.id === m.dataset.fromPoolId);
                            if (poolItem) {
                                if (poolItem.address) newEvent.extendedProps.address = poolItem.address;
                                if (poolItem.postalCode) newEvent.extendedProps.postalCode = poolItem.postalCode;
                                const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
                                if (coordinates) newEvent.extendedProps.coordinates = coordinates;
                            }
                        }
                        
                        saveUndoState(); // Save state before changes
                        appData.events.push(newEvent);
                        
                        // Handle repeat days
                        const repeatDays = [];
                        document.querySelectorAll('.repeat-cb:checked').forEach(cb => {
                            const repeatDay = parseInt(cb.value);
                            if(repeatDay !== dayIdx) repeatDays.push(repeatDay);
                        });
                        
                        repeatDays.forEach(rd => {
                            const repeatEvent = {
                                id: generateId(),
                                title: newEvent.title,
                                start: newEvent.start,
                                end: newEvent.end,
                                dayIndex: rd,
                                extendedProps: { ...newEvent.extendedProps }
                            };
                            appData.events.push(repeatEvent);
                        });
                        
                        // Entferne Pool-Item aus Pool wenn Event aus Pool erstellt wurde
                        if(m.dataset.fromPoolId) {
                            appData.pool = appData.pool.filter(p => p.id !== m.dataset.fromPoolId);
                            renderPool();
                        }
                    }
                    // Clear repeat checkboxes
                    document.querySelectorAll('.repeat-cb').forEach(cb => cb.checked = false);
                    queueSave(); refreshView(); closeModal('eventModal');
                }
            } catch(e) { 
                console.error(e); 
                showAlertModal('Fehler', 'Fehler beim Speichern: ' + e.message, 'error'); 
            }
        }
        function deleteEvent(){ 
            if(currentEvent) { 
                clearAllTooltips(); // Clear tooltips before removing elements
                // Small delay to ensure browser processes tooltip removal
                setTimeout(() => {
                    saveUndoState();
                    const title = currentEvent.title;
                    appData.events=appData.events.filter(e=>e.id!==currentEvent.id); 
                    queueSave(); 
                    refreshView(); 
                    closeModal('eventModal'); 
                    showToast(`"${title}" gelöscht`, 'success');
                }, 10);
            } 
        }
        
        function duplicateEvent() {
            if(!currentEvent) return;
            
            try {
                const originalEvent = appData.events.find(e => e.id === currentEvent.id);
                if(!originalEvent) {
                    showAlertModal('Fehler', 'Event nicht gefunden.', 'error');
                    return;
                }
                
                // Erstelle eine Kopie des Events
                const duplicatedEvent = {
                    id: generateId(),
                    title: originalEvent.title,
                    start: originalEvent.start,
                    end: originalEvent.end,
                    dayIndex: originalEvent.dayIndex,
                    extendedProps: {
                        ...originalEvent.extendedProps
                    }
                };
                
                appData.events.push(duplicatedEvent);
                
                queueSave();
                refreshView();
                closeModal('eventModal');
                
            } catch(e) {
                console.error('Fehler beim Duplizieren:', e);
                alert('Fehler beim Duplizieren: ' + e.message);
            }
        }

        // --- COPY DAY FUNCTION ---
        function executeCopyDay() {
            const fromDay = parseInt(document.getElementById('copyFromDay').value);
            const toDay = parseInt(document.getElementById('copyToDay').value);
            
            if(fromDay === toDay) {
                showAlertModal('Fehler', 'Bitte wählen Sie unterschiedliche Tage.', 'error');
                return;
            }
            
            const eventsToCopy = filterRealEvents(appData.events.filter(e => e.dayIndex === fromDay));
            
            if(eventsToCopy.length === 0) {
                showAlertModal('Information', 'Keine Einsätze zum Kopieren an diesem Tag.', 'info');
                return;
            }
            
            saveUndoState();
            
            eventsToCopy.forEach(evt => {
                const newEvent = {
                    id: generateId(),
                    title: evt.title,
                    start: evt.start,
                    end: evt.end,
                    dayIndex: toDay,
                    extendedProps: { ...evt.extendedProps }
                };
                appData.events.push(newEvent);
            });
            
            queueSave();
            refreshView();
            closeModal('copyDayModal');
            showAlertModal('Erfolg', `${eventsToCopy.length} Einsätze kopiert.`, 'success');
        }

        // --- CUSTOMER OVERVIEW ---
        function openCustomerModal() {
            // Öffne Admin-Ansicht mit Kunden-Tab
            currentAdminTab = 'customers';
            switchView('admin');
        }

        function renderCustomerList() {
            const container = document.getElementById('customerList');
            const searchVal = (document.getElementById('customerSearch')?.value || '').toLowerCase();
            const zoneVal = document.getElementById('customerZoneFilter')?.value || '';
            
            // Extract unique customers from events and pool
            const customers = new Map();
            
            appData.events.forEach(evt => {
                if(evt.extendedProps?.isTravel) return;
                const key = evt.title;
                if(!customers.has(key)) {
                    customers.set(key, {
                        name: evt.title,
                        zone: evt.extendedProps?.zone || '',
                        types: evt.extendedProps?.types || [],
                        eventCount: 0
                    });
                }
                customers.get(key).eventCount++;
            });
            
            appData.pool.forEach(p => {
                const key = p.title;
                if(!customers.has(key)) {
                    customers.set(key, {
                        name: p.title,
                        zone: p.zone || '',
                        types: p.types || [],
                        eventCount: 0,
                        inPool: true
                    });
                }
            });
            
            let customerList = Array.from(customers.values());
            
            // Apply filters
            if(searchVal) {
                customerList = customerList.filter(c => c.name.toLowerCase().includes(searchVal));
            }
            if(zoneVal) {
                customerList = customerList.filter(c => c.zone === zoneVal);
            }
            
            // Sort by name
            customerList.sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = '';
            
            if(customerList.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-light);">Keine Kunden gefunden</div>';
                return;
            }
            
            customerList.forEach(c => {
                const entry = document.createElement('div');
                entry.className = 'item-list-entry';
                entry.style.cursor = 'default';
                
                const typeDots = c.types.map(t => `<span class="dot ${t}" style="width:8px;height:8px;"></span>`).join('');
                
                entry.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;flex:1;">
                        <span class="item-name" style="cursor:default;">${c.name}</span>
                        <span style="display:flex;gap:3px;">${typeDots}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:0.75rem;color:var(--text-muted);">${getZoneWithPostalCode(c.zone)}</span>
                        <span style="font-size:0.75rem;background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:10px;">${c.eventCount} Einsätze</span>
                        ${c.inPool ? '<span style="font-size:0.65rem;background:var(--warning);color:#fff;padding:2px 6px;border-radius:10px;">Pool</span>' : ''}
                    </div>
                `;
                container.appendChild(entry);
            });
        }

        // --- DASHBOARD ---
        function renderDashboard(container) {
            // Reset container styles that might have been set by week/compare/overall views
            container.style.gridTemplateColumns = '1fr';
            container.style.display = 'block';
            container.style.padding = '20px';
            container.style.overflowY = 'auto';
            container.style.overflowX = ''; // Reset from overall view
            container.style.width = ''; // Reset from overall view
            container.style.minWidth = ''; // Reset from overall view
            container.style.maxWidth = ''; // Reset from overall view
            container.style.height = 'auto';
            
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            const realEvents = appData.events.filter(e => 
                !e.extendedProps?.isTravel && 
                e.dayIndex !== undefined && 
                e.dayIndex >= 0 && 
                e.dayIndex <= 6
            );
            
            // Calculate stats - biweekly events count half
            let totalMinutes = 0;
            let totalTravelMin = 0;
            const customerSet = new Set();
            const byDay = [0, 0, 0, 0, 0, 0, 0];
            const byTour = {};
            const byType = { care: 0, house: 0, social: 0, other: 0 };
            
            // Calculate employee workload
            const employeeWorkload = {};
            appData.employees?.forEach(emp => {
                employeeWorkload[emp.id] = { name: emp.name, weeklyHours: emp.weeklyHours || 40, actualHours: 0 };
            });
            
            realEvents.forEach(evt => {
                const duration = getEventDuration(evt);
                totalMinutes += duration;
                customerSet.add(evt.title);
                byDay[evt.dayIndex] = (byDay[evt.dayIndex] || 0) + duration;
                
                const tourId = evt.extendedProps?.tour;
                if(tourId) {
                    byTour[tourId] = (byTour[tourId] || 0) + duration;
                    
                    // Add to employee workload
                    const tour = appData.tours.find(t => t.id === tourId);
                    if(tour?.employeeId && employeeWorkload[tour.employeeId]) {
                        employeeWorkload[tour.employeeId].actualHours += duration / 60;
                }
                }
                
                (evt.extendedProps?.types || []).forEach(t => {
                    byType[t] = (byType[t] || 0) + 1;
                });
            });
            
            // Calculate travel times
            const withTravel = injectTravelTimes(realEvents);
            withTravel.filter(e => e.extendedProps?.isTravel).forEach(e => {
                totalTravelMin += parseTimeToMinutes(e.end) - parseTimeToMinutes(e.start);
            });
            
            const maxDayMin = Math.max(...byDay, 1);
            
            container.innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;">
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Einsätze</div>
                        <div style="font-size:2rem; font-weight:700; color:var(--primary);">${realEvents.length}</div>
                    </div>
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Kunden</div>
                        <div style="font-size:2rem; font-weight:700; color:var(--success);">${customerSet.size}</div>
                    </div>
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Gesamtdauer</div>
                        <div style="font-size:2rem; font-weight:700; color:var(--warning);">${Math.floor(totalMinutes/60)}h ${totalMinutes%60}m</div>
                    </div>
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Fahrzeit</div>
                        <div style="font-size:2rem; font-weight:700; color:var(--text-secondary);">${totalTravelMin}m</div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; font-size:0.9rem; color:var(--text-main);">Auslastung pro Wochentag</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            ${dayNames.map((name, i) => `
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="width:60px; font-size:0.8rem; color:var(--text-muted);">${name.substring(0,2)}</span>
                                    <div style="flex:1; height:20px; background:var(--border-light); border-radius:4px; overflow:hidden;">
                                        <div style="height:100%; width:${(byDay[i]/maxDayMin)*100}%; background:var(--primary); border-radius:4px;"></div>
                                    </div>
                                    <span style="width:50px; text-align:right; font-size:0.75rem; color:var(--text-muted);">${Math.floor(byDay[i]/60)}h</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; font-size:0.9rem; color:var(--text-main);">Stunden pro Tour</h4>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            ${appData.tours.map(tour => {
                                const min = byTour[tour.id] || 0;
                                const maxTourMin = Math.max(...Object.values(byTour), 1);
                                return `
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="width:80px; font-size:0.8rem; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${tour.name}</span>
                                    <div style="flex:1; height:20px; background:var(--border-light); border-radius:4px; overflow:hidden;">
                                        <div style="height:100%; width:${(min/maxTourMin)*100}%; background:var(--success); border-radius:4px;"></div>
                                    </div>
                                    <span style="width:50px; text-align:right; font-size:0.75rem; color:var(--text-muted);">${Math.floor(min/60)}h</span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                    <h4 style="margin:0 0 16px 0; font-size:0.9rem; color:var(--text-main);">Leistungsverteilung</h4>
                    <div style="display:flex; gap:20px; flex-wrap:wrap;">
                        <div style="display:flex; align-items:center; gap:8px;"><span class="dot care"></span> Pflege: <strong>${byType.care}</strong></div>
                        <div style="display:flex; align-items:center; gap:8px;"><span class="dot house"></span> HW: <strong>${byType.house}</strong></div>
                        <div style="display:flex; align-items:center; gap:8px;"><span class="dot social"></span> Betreuung: <strong>${byType.social}</strong></div>
                        <div style="display:flex; align-items:center; gap:8px;"><span class="dot other"></span> Sonstiges: <strong>${byType.other}</strong></div>
                    </div>
                </div>
                    
                    <div style="background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; font-size:0.9rem; color:var(--text-main);">Top Zonen</h4>
                        <div style="display:flex; flex-direction:column; gap:6px;">
                            ${(() => {
                                const byZone = {};
                                realEvents.forEach(e => {
                                    const zone = e.extendedProps?.zone || 'Unbekannt';
                                    byZone[zone] = (byZone[zone] || 0) + 1;
                                });
                                return Object.entries(byZone)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 5)
                                    .map(([zone, count]) => `
                                        <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
                                            <span style="color:var(--text-main);">${getZoneWithPostalCode(zone)}</span>
                                            <span style="color:var(--text-muted);">${count} Einsätze</span>
                                        </div>
                                    `).join('') || '<span style="color:var(--text-muted); font-size:0.85rem;">Keine Daten</span>';
                            })()}
                        </div>
                    </div>
                </div>
                
                ${appData.employees?.length > 0 ? `
                <div style="margin-top:20px; background:var(--bg-card); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                    <h4 style="margin:0 0 16px 0; font-size:0.9rem; color:var(--text-main);">Mitarbeiter-Auslastung</h4>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        ${Object.values(employeeWorkload).map(emp => {
                            const percent = Math.min(100, (emp.actualHours / emp.weeklyHours) * 100);
                            const color = percent > 100 ? 'var(--danger)' : percent > 85 ? 'var(--warning)' : 'var(--success)';
                            return `
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="width:100px; font-size:0.85rem; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${emp.name}</span>
                                <div style="flex:1; height:20px; background:var(--border-light); border-radius:4px; overflow:hidden;">
                                    <div style="height:100%; width:${percent}%; background:${color}; border-radius:4px;"></div>
                                </div>
                                <span style="width:80px; text-align:right; font-size:0.75rem; color:var(--text-muted);">${emp.actualHours.toFixed(1)}/${emp.weeklyHours}h</span>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function renderAdminView(container) {
            // Reset container styles
            container.style.gridTemplateColumns = '1fr';
            container.style.display = 'block';
            container.style.padding = '20px';
            container.style.overflowY = 'auto';
            container.style.overflowX = ''; // Reset from overall view
            container.style.width = ''; // Reset from overall view
            container.style.minWidth = ''; // Reset from overall view
            container.style.maxWidth = ''; // Reset from overall view
            container.style.height = 'auto';
            
            const tabs = [
                { id: 'tours', label: '🚗 Touren' },
                { id: 'employees', label: '👥 Team' },
                { id: 'employeehours', label: '⏱️ Stunden' },
                { id: 'wages', label: '💰 Löhne' },
                { id: 'customers', label: '👤 Kunden' },
                { id: 'events', label: '📅 Einsätze' },
                { id: 'templates', label: '📁 Vorlagen' },
                { id: 'copyday', label: '📋 Tag kopieren' },
                { id: 'files', label: '💾 Dateien' }
            ];
            
            container.innerHTML = `
                <div style="margin-bottom:28px;">
                    <h2 style="margin:0 0 8px 0; font-size:1.6rem; font-weight:700; background:var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; display:inline-flex; align-items:center; gap:10px;">
                        <span style="-webkit-text-fill-color:initial;">⚙️</span> Verwaltung
                    </h2>
                    <p style="margin:0; color:var(--text-muted); font-size:0.9rem;">Verwalten Sie Touren, Team, Löhne und weitere Einstellungen</p>
                </div>
                
                <div style="display:flex; gap:6px; margin-bottom:24px; padding:6px; background:var(--bg-elevated); border-radius:var(--radius-lg); overflow-x:auto; border:1px solid var(--border);">
                    ${tabs.map(tab => `
                        <button 
                            class="admin-tab-btn ${currentAdminTab === tab.id ? 'active' : ''}"
                            onclick="switchAdminTab('${tab.id}')"
                            style="
                                padding:10px 16px;
                                border:none;
                                background:${currentAdminTab === tab.id ? 'var(--primary)' : 'transparent'};
                                color:${currentAdminTab === tab.id ? '#0a0a0f' : 'var(--text-muted)'};
                                font-size:0.85rem;
                                font-weight:700;
                                cursor:pointer;
                                border-radius:var(--radius-md);
                                white-space:nowrap;
                                transition:all 0.2s;
                                box-shadow:${currentAdminTab === tab.id ? '0 0 15px rgba(6, 182, 212, 0.4)' : 'none'};
                            "
                            onmouseover="if('${currentAdminTab}' !== '${tab.id}') { this.style.background='var(--bg-hover)'; this.style.color='var(--primary)'; }"
                            onmouseout="if('${currentAdminTab}' !== '${tab.id}') { this.style.background='transparent'; this.style.color='var(--text-muted)'; }"
                        >
                            ${tab.label}
                        </button>
                    `).join('')}
                </div>
                
                <div id="adminContent" style="background:var(--bg-card); padding:24px; border-radius:var(--radius-lg); border:1px solid var(--border); min-height:400px; box-shadow:var(--shadow-md);">
                    <!-- Content wird dynamisch geladen -->
                </div>
            `;
            
            // Render initial tab content
            renderAdminTabContent(currentAdminTab);
        }
        
        function switchAdminTab(tabId) {
            currentAdminTab = tabId;
            refreshView();
        }
        
        function renderAdminTabContent(tabId) {
            const content = document.getElementById('adminContent');
            if(!content) return;
            
            // Update tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                if(btn.onclick.toString().includes(`'${tabId}'`)) {
                    btn.classList.add('active');
                    btn.style.color = 'var(--primary)';
                    btn.style.borderBottomColor = 'var(--primary)';
                } else {
                    btn.classList.remove('active');
                    btn.style.color = 'var(--text-muted)';
                    btn.style.borderBottomColor = 'transparent';
                }
            });
            
            switch(tabId) {
                case 'tours':
                    renderAdminTours(content);
                    break;
                case 'employees':
                    renderAdminEmployees(content);
                    break;
                case 'employeehours':
                    renderEmployeeHoursDashboard();
                    break;
                case 'wages':
                    renderAdminWages(content);
                    break;
                case 'customers':
                    renderAdminCustomers(content);
                    break;
                case 'events':
                    renderAdminEvents(content);
                    break;
                case 'templates':
                    renderAdminTemplates(content);
                    break;
                case 'copyday':
                    renderAdminCopyDay(content);
                    break;
                case 'files':
                    renderAdminFiles(content);
                    break;
            }
        }
        
        function renderAdminFiles(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">💾 Dateien & Backup</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:24px;">Speichern, laden und sichern Sie Ihre Daten.</p>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                    <!-- Schnellzugriff -->
                    <div style="background:var(--bg-elevated); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; color:var(--text-main); font-size:1rem;">📁 Schnellzugriff</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn btn-secondary" onclick="openFile()" title="JSON-Datei laden">
                                📂 Öffnen
                            </button>
                            <button class="btn btn-primary" onclick="saveToFileManual()" title="Speichern (Strg+S)">
                                💾 Sichern
                            </button>
                        </div>
                    </div>
                    
                    <!-- CSV Import/Export -->
                    <div style="background:var(--bg-elevated); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; color:var(--text-main); font-size:1rem;">📊 CSV Import/Export</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn btn-secondary" onclick="importCSV()" title="CSV importieren">
                                📤 Import
                            </button>
                            <button class="btn btn-secondary" onclick="exportCSV()" title="CSV exportieren">
                                📥 Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Backup -->
                    <div style="background:var(--bg-elevated); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; color:var(--text-main); font-size:1rem;">🔒 Backup</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn btn-secondary" onclick="exportAllData()" title="Alle Daten als Backup exportieren">
                                💾 Exportieren
                            </button>
                            <button class="btn btn-secondary" onclick="importAllData()" title="Backup importieren">
                                📂 Importieren
                            </button>
                        </div>
                        <p style="margin:12px 0 0 0; font-size:0.75rem; color:var(--text-muted);">
                            ⚠️ Beim Import werden alle bestehenden Daten überschrieben!
                        </p>
                    </div>
                    
                    <!-- Drucken & Export -->
                    <div style="background:var(--bg-elevated); padding:20px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 16px 0; color:var(--text-main); font-size:1rem;">🖨️ Drucken & Export</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <button class="btn btn-secondary" onclick="exportToPDF()" title="Als PDF exportieren">
                                📄 PDF
                            </button>
                            <button class="btn btn-secondary" onclick="printView()" title="Drucken">
                                🖨️ Drucken
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div style="margin-top:24px; padding:16px; background:var(--bg-elevated); border-radius:var(--radius-md); border:1px solid var(--border);">
                    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="width:8px; height:8px; background:var(--success); border-radius:50%; animation: pulse 2s infinite;"></span>
                            <span style="font-size:0.85rem; color:var(--text-muted);">Auto-Save aktiv (IndexedDB)</span>
                        </div>
                        <div id="adminLastSaveDisplay" style="font-size:0.8rem; color:var(--text-muted);">💾 Zuletzt: ${document.getElementById('lastSaveDisplay')?.textContent?.replace('💾 Zuletzt: ', '') || '–'}</div>
                    </div>
                </div>
            `;
        }
        
        function renderAdminTours(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">🚐 Touren verwalten</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">Erstellen und verwalten Sie Ihre Touren für die Einsatzplanung.</p>
                
                <div class="input-group" style="margin-bottom:24px;">
                    <label class="section-title">Neue Tour hinzufügen</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <input id="newTourName" placeholder="🚗 Name der Tour..." style="flex:2; min-width:200px;">
                        <input id="newTourHoursLimit" type="number" placeholder="⏱️ Std/Woche" style="flex:1; min-width:100px;" min="0" max="168">
                        <button class="btn btn-primary" style="width:auto; min-width:100px; height:44px;" onclick="addTour(); renderAdminTabContent('tours');">
                            <span style="font-size:1.1rem; font-weight:400;">+</span> Hinzufügen
                        </button>
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); margin-bottom:4px; display:block;">Bevorzugte Leistungstypen (optional):</label>
                        <div class="checkbox-group" style="display:flex; gap:12px; flex-wrap:wrap;">
                            <label class="cb-item"><input type="checkbox" class="new-tour-type-cb" value="care"><div class="dot care"></div>Pflege</label>
                            <label class="cb-item"><input type="checkbox" class="new-tour-type-cb" value="house"><div class="dot house"></div>HW</label>
                            <label class="cb-item"><input type="checkbox" class="new-tour-type-cb" value="social"><div class="dot social"></div>Betr.</label>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="section-title">Vorhandene Touren</label>
                    <div id="tourList" class="item-list"></div>
                </div>
            `;
            renderTourList();
        }
        
        function renderTourList() {
            const container = document.getElementById('tourList');
            if (!container) return;
            
            if (!appData.tours || appData.tours.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-light);">Keine Touren vorhanden</div>';
                return;
            }
            
            container.innerHTML = '';
            
            appData.tours.forEach(tour => {
                const entry = document.createElement('div');
                entry.className = 'item-list-entry';
                entry.style.cssText = 'display:flex; flex-direction:column; padding:12px; border-bottom:1px solid var(--border-light);';
                
                const topRow = document.createElement('div');
                topRow.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;';
                
                const tourEvents = appData.events.filter(e => e.extendedProps?.tour === tour.id && !e.extendedProps?.isTravel);
                const eventCount = tourEvents.length;
                
                // Prüfe wie viele Events Koordinaten haben
                let eventsWithCoords = 0;
                tourEvents.forEach(evt => {
                    const poolId = evt.extendedProps?.poolId;
                    if (poolId) {
                        const poolItem = appData.pool?.find(p => p.id === poolId);
                        if (poolItem) {
                            const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
                            if (coordinates && coordinates.lat && coordinates.lng) {
                                eventsWithCoords++;
                            }
                        }
                    }
                });
                const coordsInfo = eventsWithCoords > 0 
                    ? `<span style="font-size:0.7rem; color:var(--text-muted);" title="${eventsWithCoords} von ${eventCount} Einsätzen haben Koordinaten">📍 ${eventsWithCoords}/${eventCount}</span>`
                    : '';
                
                const preferredTypes = tour.preferredTypes || [];
                const typesDisplay = preferredTypes.length > 0 
                    ? preferredTypes.map(t => {
                        const labels = { care: 'Pflege', house: 'HW', social: 'Betr.' };
                        return `<span style="font-size:0.7rem; background:var(--border-light); color:var(--text-muted); padding:2px 6px; border-radius:4px;">${labels[t] || t}</span>`;
                    }).join('')
                    : '<span style="font-size:0.7rem; color:var(--text-light);">Alle</span>';
                
                topRow.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; flex:1; flex-wrap:wrap;">
                        <span class="item-name" style="font-weight:600;">${tour.name}</span>
                        ${tour.weeklyHoursLimit ? `<span style="font-size:0.75rem; color:var(--text-muted);">⏱️ ${tour.weeklyHoursLimit} Std/Woche</span>` : ''}
                        <div style="display:flex; align-items:center; gap:4px; margin-left:8px;">
                            <span style="font-size:0.7rem; color:var(--text-muted);">Typen:</span>
                            ${typesDisplay}
                        </div>
                        ${coordsInfo}
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:0.75rem; background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:10px;">${eventCount} Einsätze</span>
                        <button class="btn btn-sm btn-secondary" onclick="editTour('${tour.id}')" style="padding:4px 10px; font-size:0.75rem;">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTour('${tour.id}')" style="padding:4px 10px; font-size:0.75rem;">🗑️</button>
                    </div>
                `;
                entry.appendChild(topRow);
                
                // Settings-Row mit Mitarbeiter-Zuweisung
                const settingsRow = document.createElement('div');
                settingsRow.style.cssText = 'width:100%; margin-top:8px; padding-top:8px; border-top:1px dashed var(--border); display:flex; gap:16px; flex-wrap:wrap; align-items:center;';
                
                // Mitarbeiter-Zuweisung
                const empDiv = document.createElement('div');
                empDiv.style.cssText = 'display:flex; align-items:center; gap:6px;';
                
                const empLabel = document.createElement('span');
                empLabel.style.cssText = 'font-size:0.75rem; color:var(--text-muted);';
                empLabel.textContent = 'Mitarbeiter:in:';
                
                if(appData.employees && appData.employees.length > 0) {
                    const empSelect = document.createElement('select');
                    empSelect.style.cssText = 'width:auto; min-width:120px; height:36px; padding:0 24px 0 8px; font-size:0.8rem; margin:0;';
                    empSelect.innerHTML = '<option value="">-- Auswählen --</option>';
                    appData.employees.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.id;
                        opt.textContent = emp.name;
                        if(tour.employeeId === emp.id) opt.selected = true;
                        empSelect.appendChild(opt);
                    });
                    
                    empSelect.onchange = () => {
                        const tourObj = appData.tours.find(t => t.id === tour.id);
                        if(tourObj) {
                            tourObj.employeeId = empSelect.value || null;
                            queueSave();
                            renderTourList(); // Liste neu rendern
                            updateTourEmployeeDisplay(); // Aktualisiere Anzeige wenn Tour ausgewählt ist
                        }
                    };
                    
                    empDiv.appendChild(empLabel);
                    empDiv.appendChild(empSelect);
                } else {
                    const empHint = document.createElement('span');
                    empHint.style.cssText = 'font-size:0.75rem; color:var(--text-light); font-style:italic;';
                    empHint.textContent = 'Erst Team anlegen';
                    empDiv.appendChild(empLabel);
                    empDiv.appendChild(empHint);
                }
                
                settingsRow.appendChild(empDiv);
                entry.appendChild(settingsRow);
                
                container.appendChild(entry);
            });
        }
        
        function deleteTour(tourId) {
            const tour = appData.tours.find(t => t.id === tourId);
            if (!tour) return;
            
            const eventCount = appData.events.filter(e => e.extendedProps?.tour === tourId && !e.extendedProps?.isTravel).length;
            
            if (eventCount > 0) {
                if (!confirm(`Die Tour "${tour.name}" hat ${eventCount} zugeordnete Einsätze.\n\nMöchten Sie die Tour trotzdem löschen?`)) {
                    return;
                }
            } else {
                if (!confirm(`Möchten Sie die Tour "${tour.name}" wirklich löschen?`)) {
                    return;
                }
            }
            
            // Entferne Tour aus Liste
            appData.tours = appData.tours.filter(t => t.id !== tourId);
            
            // Entferne Tour-Zuordnung aus Events (optional - oder Events ohne Tour lassen)
            // appData.events.forEach(e => {
            //     if (e.extendedProps?.tour === tourId) {
            //         delete e.extendedProps.tour;
            //     }
            // });
            
            // Speichere Änderungen
            queueSave();
            refreshUI();
            
            // Aktualisiere Tour-Liste
            renderTourList();
            
            showToast(`Tour "${tour.name}" gelöscht`, 'success');
        }
        
        function renderAdminEmployees(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">👥 Team verwalten</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">Verwalten Sie Ihre Mitarbeiter:innen, deren Wochenstunden, Lohngruppe und Transportmittel.</p>
                
                <div class="input-group" style="margin-bottom:24px;">
                    <label class="section-title">Neues Teammitglied hinzufügen</label>
                    <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr auto; gap:8px; align-items:end;">
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-muted);">Name</label>
                            <input id="newEmpName" placeholder="👤 Name...">
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-muted);">Std/Woche</label>
                            <input id="newEmpHours" type="number" placeholder="40" min="0" max="60" value="40">
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-muted);">Lohngruppe</label>
                            <select id="newEmpWageGroup"></select>
                        </div>
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-muted);">Transport</label>
                            <select id="newEmpTransport">
                                <option value="car">🚘 PKW</option>
                                <option value="public">🚌 Öffis</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr auto; gap:8px; margin-top:8px; align-items:end;">
                        <div>
                            <label style="font-size:0.75rem; color:var(--text-muted);">🏠 Wohnort (Zone)</label>
                            <select id="newEmpHomeZone"></select>
                        </div>
                        <button class="btn btn-primary" style="height:44px; min-width:100px;" onclick="addEmployee(); renderAdminTabContent('employees');" title="Hinzufügen">
                            <span style="font-size:1.1rem; font-weight:400;">+</span> Hinzufügen
                        </button>
                    </div>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                        <label class="section-title" style="font-size:0.9rem; margin-bottom:8px;">📍 Adresse (optional, für präzise An-/Abfahrt-Berechnung)</label>
                        <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px; margin-bottom:8px;">
                            <div>
                                <label style="font-size:0.75rem; color:var(--text-muted);">Straße + Hausnummer</label>
                                <input id="newEmpAddress" placeholder="Musterstraße 123">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; color:var(--text-muted);">Postleitzahl</label>
                                <input id="newEmpPostalCode" placeholder="45879" maxlength="10">
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-secondary" onclick="geocodeEmployeeAddress('admin')" id="geocodeEmpBtn" style="flex:1;">🔍 Koordinaten ermitteln</button>
                            <button class="btn btn-secondary" onclick="openManualEmployeeCoordinatesModal('admin')" style="flex:1;">✏️ Manuell eingeben</button>
                        </div>
                        <div id="employeeCoordinatesDisplay" style="display:none; margin-top:10px; padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.9rem;">
                            <strong>Koordinaten:</strong> <span id="employeeCoordinatesText"></span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="section-title">Teammitglieder <span id="employeeCount" style="font-size:0.85rem; color:var(--text-muted); font-weight:normal;">(0)</span></label>
                    <div id="employeeList" class="item-list"></div>
                </div>
            `;
            try {
                if (typeof ensureWageSettings === 'function') ensureWageSettings();
                if (typeof updateEmployeeWageGroupSelects === 'function') updateEmployeeWageGroupSelects();
            } catch (e) {
                throw e;
            }
            try {
                if (typeof populateHomeZoneSelects === 'function') populateHomeZoneSelects();
            } catch (e) {
                throw e;
            }
            try {
                renderEmployeeList();
            } catch (e) {
                throw e;
            }
        }
        
        function renderEmployeeList() {
            const container = document.getElementById('employeeList');
            if (!container || !appData.employees) return;
            
            // Aktualisiere Anzahl-Anzeige
            const countElement = document.getElementById('employeeCount');
            if (countElement) {
                countElement.textContent = `(${appData.employees.length})`;
            }
            
            container.innerHTML = '';
            
            appData.employees.forEach(emp => {
                const entry = document.createElement('div');
                entry.className = 'item-list-entry';
                entry.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--border-light); flex-wrap:wrap;';
                
                const hasAddress = emp.address || emp.postalCode;
                const hasCoordinates = emp.extendedProps?.coordinates;
                const coordsInfo = hasCoordinates 
                    ? `<span style="font-size:0.7rem; color:var(--text-muted);" title="Koordinaten: ${emp.extendedProps.coordinates.lat.toFixed(6)}, ${emp.extendedProps.coordinates.lng.toFixed(6)}">📍</span>`
                    : '';
                
                entry.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; flex:1; flex-wrap:wrap;">
                        <span class="item-name" style="font-weight:600; cursor:pointer;" onclick="openEmployeeEditModal('${emp.id}')">${emp.name}</span>
                        ${emp.homeZone ? `<span style="font-size:0.75rem; color:var(--text-muted);">🏠 ${emp.homeZone}</span>` : ''}
                        ${hasAddress ? `<span style="font-size:0.7rem; color:var(--text-muted);">📍 ${emp.address || ''} ${emp.postalCode || ''}</span>` : ''}
                        ${coordsInfo}
                        <span style="font-size:0.75rem; background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:10px;">${emp.weeklyHours || 40} Std/Woche</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="btn btn-sm btn-secondary" onclick="openEmployeeEditModal('${emp.id}')" style="padding:4px 10px; font-size:0.75rem;">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${emp.id}')" style="padding:4px 10px; font-size:0.75rem;">🗑️</button>
                    </div>
                `;
                container.appendChild(entry);
            });
        }
        
        function editEmployee(employeeId) {
            const emp = appData.employees.find(e => e.id === employeeId);
            if (!emp) return;

            // Neuer Editor (vollständiges Modal)
            openEmployeeEditModal(employeeId);
            return;
            // (ehemalige Admin-Überbleibsel entfernt): alter InputModal-Editor
        }

        // ===== Mitarbeiter bearbeiten (vollständiges Modal) =====
        function openEmployeeEditModal(employeeId) {
            const emp = appData.employees?.find(e => e.id === employeeId);
            if (!emp) return;
            const modal = document.getElementById('employeeEditModal');
            if (!modal) return;
            
            modal.dataset.employeeId = employeeId;
            delete modal.dataset.tempCoordinates;
            
            const nameEl = document.getElementById('editEmpName');
            const hoursEl = document.getElementById('editEmpHours');
            const wageEl = document.getElementById('editEmpWageGroup');
            const transportEl = document.getElementById('editEmpTransport');
            const zoneEl = document.getElementById('editEmpHomeZone');
            const addrEl = document.getElementById('editEmpAddress2');
            const pcEl = document.getElementById('editEmpPostalCode2');
            const coordsBox = document.getElementById('editEmpCoordinatesDisplay2');
            const coordsText = document.getElementById('editEmpCoordinatesText2');
            
            if (nameEl) nameEl.value = emp.name || '';
            if (hoursEl) hoursEl.value = String(emp.weeklyHours ?? 40);
            if (transportEl) transportEl.value = emp.transport || 'car';
            if (addrEl) addrEl.value = emp.address || '';
            if (pcEl) pcEl.value = emp.postalCode || '';
            
            // Wage groups
            if (typeof ensureWageSettings === 'function') ensureWageSettings();
            const groups = appData.wageSettings?.wageGroups || DEFAULT_WAGE_SETTINGS.wageGroups;
            if (wageEl) {
                wageEl.innerHTML = groups.map(g => `<option value="${g.id}">${g.name} (${g.hourlyRate.toFixed(2)}€/h)</option>`).join('');
                wageEl.value = emp.wageGroup || groups[0]?.id || 'hilfskraft';
            }
            
            // Zones
            if (zoneEl) {
                const current = emp.homeZone || '';
                zoneEl.innerHTML = '<option value="">-- Wohnort wählen --</option>' + CITY_ZONES.map(z => `<option value="${z}">${getZoneWithPostalCode(z)}</option>`).join('');
                zoneEl.value = current;
            }
            
            // Coordinates display
            const coords = emp.extendedProps?.coordinates;
            if (coords && typeof coords.lat === 'number' && typeof coords.lng === 'number') {
                modal.dataset.tempCoordinates = JSON.stringify(coords);
                if (coordsBox) coordsBox.style.display = 'block';
                if (coordsText) coordsText.textContent = `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
            } else {
                if (coordsBox) coordsBox.style.display = 'none';
                if (coordsText) coordsText.textContent = '';
            }
            
            openModal('employeeEditModal');
        }
        
        function saveEmployeeEditModal() {
            const modal = document.getElementById('employeeEditModal');
            const employeeId = modal?.dataset?.employeeId;
            const emp = appData.employees?.find(e => e.id === employeeId);
            if (!modal || !emp) return;
            
            const name = document.getElementById('editEmpName')?.value?.trim() || '';
            if (!name) {
                showToast('Name darf nicht leer sein', 'error');
                return;
            }
            
            const hoursRaw = document.getElementById('editEmpHours')?.value;
            const hours = hoursRaw === '' || hoursRaw === null || hoursRaw === undefined ? 40 : (parseInt(hoursRaw) || 40);
            const wageGroup = document.getElementById('editEmpWageGroup')?.value || emp.wageGroup || 'hilfskraft';
            const transport = document.getElementById('editEmpTransport')?.value || emp.transport || 'car';
            const homeZone = document.getElementById('editEmpHomeZone')?.value || '';
            const address = document.getElementById('editEmpAddress2')?.value?.trim() || null;
            const postalCode = document.getElementById('editEmpPostalCode2')?.value?.trim() || null;
            
            emp.name = name;
            emp.weeklyHours = hours;
            emp.wageGroup = wageGroup;
            emp.transport = transport;
            emp.homeZone = homeZone;
            emp.address = address;
            emp.postalCode = postalCode;
            
            const tmp = modal.dataset.tempCoordinates;
            if (tmp) {
                try {
                    emp.extendedProps = emp.extendedProps || {};
                    emp.extendedProps.coordinates = JSON.parse(tmp);
                } catch (_) {}
            }
            
            queueSave();
            if (typeof renderEmployeeList === 'function') renderEmployeeList();
            closeModal('employeeEditModal');
            showToast('Mitarbeiter aktualisiert', 'success');
        }
        
        async function geocodeEmployeeAddressEmployeeEditModal() {
            const modal = document.getElementById('employeeEditModal');
            const addressInput = document.getElementById('editEmpAddress2');
            const postalInput = document.getElementById('editEmpPostalCode2');
            const btn = document.getElementById('editEmpGeocodeBtn');
            const display = document.getElementById('editEmpCoordinatesDisplay2');
            const text = document.getElementById('editEmpCoordinatesText2');
            
            const address = addressInput ? addressInput.value.trim() : '';
            const postalCode = postalInput ? postalInput.value.trim() : '';
            if (!address && !postalCode) {
                showToast('Bitte Adresse oder Postleitzahl eingeben', 'warning');
                return;
            }
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Ermittle...';
            }
            
            try {
                const response = await fetch('/api/geocoding/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, postalCode, city: 'Gelsenkirchen' })
                });
                
                // Prüfe ob es ein Timeout war
                if (response.status === 504) {
                    throw new Error('Geocoding-Service antwortet nicht rechtzeitig. Bitte versuchen Sie es später erneut.');
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const coordinates = { lat: data.latitude, lng: data.longitude };
                    if (modal) modal.dataset.tempCoordinates = JSON.stringify(coordinates);
                    if (display) display.style.display = 'block';
                    if (text) text.textContent = `${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}`;
                    showToast('Koordinaten erfolgreich ermittelt', 'success');
                } else {
                    showToast('Koordinaten konnten nicht ermittelt werden: ' + (data.error || 'Unbekannter Fehler'), 'error');
                }
            } catch (e) {
                console.error('Geocoding-Fehler:', e);
                // Zeige spezifische Fehlermeldung für Timeouts
                if (e.message && (e.message.includes('Timeout') || e.message.includes('504'))) {
                    showToast('Geocoding-Service antwortet nicht rechtzeitig. Bitte versuchen Sie es später erneut.', 'error');
                } else if (e.message && e.message.includes('Unexpected token')) {
                    showToast('Geocoding-Service hat ungültige Antwort zurückgegeben. Bitte versuchen Sie es später erneut.', 'error');
                } else {
                    showToast('Fehler beim Ermitteln der Koordinaten: ' + (e.message || 'Unbekannter Fehler'), 'error');
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '🔍 Koordinaten ermitteln';
                }
            }
        }
        
        function openManualEmployeeCoordinatesEmployeeEditModal() {
            const editModal = document.getElementById('employeeEditModal');
            const coordsModal = document.getElementById('manualEmployeeCoordinatesModal');
            if (coordsModal) {
                coordsModal.dataset.source = 'employeeEdit';
                // Erhöhe z-index, damit Modal über dem Edit-Modal erscheint
                coordsModal.style.zIndex = '2000';
            }
            
            const tmp = editModal?.dataset?.tempCoordinates;
            if (tmp) {
                try {
                    const coords = JSON.parse(tmp);
                    const latInput = document.getElementById('manualEmpLat');
                    const lngInput = document.getElementById('manualEmpLng');
                    if (latInput) latInput.value = coords.lat ?? '';
                    if (lngInput) lngInput.value = coords.lng ?? '';
                } catch (_) {}
            }
            
            openModal('manualEmployeeCoordinatesModal');
        }
        
        // (ehemalige Admin-Überbleibsel entfernt): editEmployee-InputModal-Editor + helpers (geocodeEmployeeAddressEdit/openManualEmployeeCoordinatesModalEdit)
        
        function deleteEmployee(employeeId) {
            const emp = appData.employees.find(e => e.id === employeeId);
            if (!emp) return;
            
            if (!confirm(`Möchten Sie "${emp.name}" wirklich löschen?`)) {
                return;
            }
            
            appData.employees = appData.employees.filter(e => e.id !== employeeId);
            queueSave();
            renderEmployeeList();
            updateCapacityDisplay();
            showToast('Mitarbeiter gelöscht', 'success');
        }
        
        function renderAdminWages(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">💰 Lohnkonfiguration</h3>
                
                <!-- Lohngruppen -->
                <div style="margin-bottom:24px;">
                    <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>👥 Lohngruppen</span>
                        <button class="btn btn-sm btn-secondary" style="padding:4px 10px; font-size:0.75rem;" onclick="addWageGroup();">+ Hinzufügen</button>
                    </div>
                    <div id="wageGroupsList" style="display:flex; flex-direction:column; gap:8px;"></div>
                </div>
                
                <!-- Zuschläge -->
                <div style="margin-bottom:24px;">
                    <div class="section-title">📈 Zuschläge (%)</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Sonntag</label>
                            <input type="number" id="surchargeSunday" min="0" max="200" value="25" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Feiertag</label>
                            <input type="number" id="surchargeHoliday" min="0" max="200" value="100" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Nacht (20-06 Uhr)</label>
                            <input type="number" id="surchargeNight" min="0" max="200" value="25" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                    </div>
                </div>
                
                <!-- Erlöse pro Leistungsart -->
                <div style="margin-bottom:24px;">
                    <div class="section-title">💶 Erlöse pro Stunde (€)</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--c-care); margin-bottom:4px;">🏥 Pflege</label>
                            <input type="number" id="revenueCare" min="0" step="0.5" value="45" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--c-house); margin-bottom:4px;">🏠 Hauswirtschaft</label>
                            <input type="number" id="revenueHouse" min="0" step="0.5" value="35" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--c-social); margin-bottom:4px;">🤝 Betreuung</label>
                            <input type="number" id="revenueSocial" min="0" step="0.5" value="40" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                    </div>
                </div>
                
                <!-- Fahrtkosten -->
                <div style="margin-bottom:24px;">
                    <div class="section-title">🚗 Fahrtkosten</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">⏱️ Ø Geschwindigkeit (km/h)</label>
                            <input type="number" id="avgSpeed" min="10" max="80" value="30" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">🚘 PKW (€/km)</label>
                            <input type="number" id="kmRate" min="0" step="0.05" value="0.30" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">🚌 Öffis (€/Monat)</label>
                            <input type="number" id="publicTransportMonthly" min="0" step="5" value="30" style="width:100%;" onchange="updateWageSettings()">
                        </div>
                    </div>
                </div>
                
                <!-- Arbeitgeberfaktor & Zielmarge -->
                <div style="margin-bottom:24px;">
                    <div class="section-title">🎯 Kalkulation</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Arbeitgeberfaktor (1.0 = nur Lohn)</label>
                            <input type="number" id="employerFactor" min="1" max="2" step="0.05" value="1.5" style="width:100%;" onchange="updateWageSettings()">
                            <span style="font-size:0.7rem; color:var(--text-light);">1.5 = 50% Arbeitgeberanteil</span>
                        </div>
                        <div>
                            <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">Zielmarge (%)</label>
                            <input type="number" id="targetMargin" min="0" max="80" value="50" style="width:100%;" onchange="updateWageSettings()">
                            <span style="font-size:0.7rem; color:var(--text-light);">50% = Erlös ist doppelt so hoch wie Kosten</span>
                        </div>
                    </div>
                </div>
                
                <div style="padding:12px; background:var(--primary-light); border-radius:var(--radius-md); font-size:0.85rem; color:var(--primary); margin-bottom:16px;">
                    💡 <strong>Hinweis:</strong> Die Lohnkosten werden mit dem Arbeitgeberfaktor multipliziert (z.B. 1,5 für 50% Sozialabgaben). Die Zielmarge gibt an, wie hoch der Erlös im Verhältnis zu den Kosten sein soll.
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="resetWageSettings(); renderAdminTabContent('wages');">↩️ Zurücksetzen</button>
                    <button class="btn btn-primary" onclick="updateWageSettings(); showToast('Lohnkonfiguration gespeichert', 'success');">✅ Speichern</button>
                </div>
            `;
            ensureWageSettings();
            // Verwende renderWageGroupsList() statt der nicht existierenden renderWageGroups()
            renderWageGroupsList();
            // Lade die aktuellen Wage Settings in die Input-Felder
            if (typeof populateWageSettingsModal === 'function') {
                populateWageSettingsModal();
            }
        }
        
        function renderAdminCustomers(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">👥 Kundenübersicht</h3>
                
                <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
                    <input type="text" id="customerSearch" placeholder="🔍 Kunde suchen..." style="flex:1; min-width:200px;" oninput="renderCustomerList()">
                    <select id="customerZoneFilter" onchange="renderCustomerList()" style="width:150px;">
                        <option value="">Alle Zonen</option>
                    </select>
                    <button class="btn btn-primary" onclick="openModal('poolImportModal')" style="white-space:nowrap;">📥 Kunden importieren</button>
                    <button class="btn btn-danger" onclick="deleteAllCustomers()" style="white-space:nowrap;">🗑️ Alle löschen</button>
                </div>
                
                <div id="customerList" class="item-list" style="max-height:500px; overflow-y:auto;"></div>
            `;
            // Populate zone filter
            const zoneFilter = document.getElementById('customerZoneFilter');
            if(zoneFilter) {
                zoneFilter.innerHTML = '<option value="">Alle Zonen</option>';
                CITY_ZONES.forEach(z => {
                    const opt = document.createElement('option');
                    opt.value = z;
                    opt.textContent = getZoneWithPostalCode(z);
                    zoneFilter.appendChild(opt);
                });
            }
            renderCustomerList();
        }
        
        function renderAdminTemplates(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">📁 Wochenvorlagen</h3>
                
                <div style="margin-bottom:20px;">
                    <label class="section-title">Aktuelle Woche als Vorlage speichern</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="templateName" placeholder="Name der Vorlage..." style="flex:1;">
                        <button class="btn btn-primary" style="width:auto; min-width:100px;" onclick="saveTemplate(); renderAdminTabContent('templates');">
                            💾 Speichern
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="section-title">Gespeicherte Vorlagen</label>
                    <div id="templateList" class="item-list" style="max-height:400px; overflow-y:auto;"></div>
                </div>
                
                <div style="margin-top:20px; padding:12px; background:var(--border-light); border-radius:var(--radius-md); font-size:0.85rem; color:var(--text-muted);">
                    ⚠️ Beim Laden einer Vorlage werden die aktuellen Einsätze ersetzt.
                </div>
            `;
            renderTemplateList();
        }
        
        function renderAdminCopyDay(container) {
            container.innerHTML = `
                <h3 style="margin:0 0 8px 0; font-size:1.2rem; color:var(--text-main);">📋 Tag kopieren</h3>
                <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">Alle Einsätze eines Tages auf einen anderen Tag kopieren.</p>
                
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <div style="flex:1">
                        <label class="section-title">Von Tag</label>
                        <select id="copyFromDay">
                            <option value="0">Montag</option>
                            <option value="1">Dienstag</option>
                            <option value="2">Mittwoch</option>
                            <option value="3">Donnerstag</option>
                            <option value="4">Freitag</option>
                            <option value="5">Samstag</option>
                            <option value="6">Sonntag</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label class="section-title">Nach Tag</label>
                        <select id="copyToDay">
                            <option value="0">Montag</option>
                            <option value="1">Dienstag</option>
                            <option value="2">Mittwoch</option>
                            <option value="3">Donnerstag</option>
                            <option value="4">Freitag</option>
                            <option value="5">Samstag</option>
                            <option value="6">Sonntag</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button class="btn btn-secondary" onclick="document.getElementById('copyFromDay').value='0'; document.getElementById('copyToDay').value='0';">❌ Zurücksetzen</button>
                    <button class="btn btn-primary" onclick="executeCopyDay(); showToast('Tag erfolgreich kopiert', 'success');">📋 Kopieren</button>
                </div>
            `;
        }

        // --- EXPORT FUNCTIONS ---
        function printView() {
            // Add print header
            let header = document.querySelector('.print-header');
            if(!header) {
                header = document.createElement('div');
                header.className = 'print-header';
                header.style.display = 'none';
                document.body.insertBefore(header, document.body.firstChild);
            }
            
            const realEvents = filterValidEvents(appData.events);
            const totalMinutes = realEvents.reduce((sum, e) => sum + getEventDuration(e), 0);
            
            header.innerHTML = `
                <h1>Tourenplanung - Wochenübersicht</h1>
                <p>Erstellt am ${new Date().toLocaleDateString('de-DE')} • ${realEvents.length} Einsätze • ${Math.floor(totalMinutes/60)}h ${totalMinutes%60}m Gesamtdauer</p>
            `;
            
            window.print();
        }

        // --- EXPORT FUNKTIONEN ---
        function exportCSV() {
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            const realEvents = appData.events.filter(e => !e.extendedProps?.isTravel);
            
            let csv = 'Kunde;Tag;Start;Ende;Tour;Zone;Leistungen;Rhythmus\n';
            
            realEvents.forEach(evt => {
                const tour = appData.tours.find(t => t.id === evt.extendedProps?.tour);
                const types = (evt.extendedProps?.types || []).join(', ');
                const rhythm = evt.extendedProps?.rhythm === 'biweekly' ? '2-wöchentlich' : '1-wöchentlich';
                
                csv += `"${evt.title}";"${dayNames[evt.dayIndex]}";"${evt.start}";"${evt.end}";"${tour?.name || ''}";"${evt.extendedProps?.zone || ''}";"${types}";"${rhythm}"\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tourenplanung.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importCSV() {
            openModal('csvImportModal');
        }
        
        function exportToPDF() {
            // Nutze die Druckfunktion als PDF-Export (Browser kann als PDF speichern)
            showToast('Druckdialog wird geöffnet - wählen Sie "Als PDF speichern"', 'info');
            printView();
        }
        
        // --- DATEI FUNKTIONEN ---
        async function openFile() {
            try {
                if(!window.showOpenFilePicker) {
                    showToast('File System Access API wird von diesem Browser nicht unterstützt', 'error');
                    return;
                }
                [fileHandle] = await showOpenFilePicker();
                const f = await fileHandle.getFile();
                const content = await f.text();
                const parsed = JSON.parse(content);
                appData = parsed;
                ensureAppDataDefaults();
                migrateZoneNames();
                refreshUI();
                updatePatientList();
                queueSave();
                showToast('Datei geladen und gespeichert', 'success');
            } catch(e) {
                if(e.name !== 'AbortError') {
                    console.error('Fehler beim Öffnen:', e);
                    showToast('Fehler beim Öffnen der Datei', 'error');
                }
            }
        }
        
        async function saveToFileManual() {
            if(!fileHandle) {
                if(!window.showSaveFilePicker) {
                    showToast('File System Access API wird von diesem Browser nicht unterstützt', 'error');
                    return;
                }
                try {
                    fileHandle = await showSaveFilePicker({suggestedName:'Plan.json'});
                } catch(e) {
                    if(e.name !== 'AbortError') {
                        console.error('Datei-Auswahl fehlgeschlagen:', e);
                    }
                    return;
                }
            }
            queueSave();
        }
        
        // --- BACKUP FUNKTIONEN ---
        let pendingBackupImport = null;
        
        function exportAllData() {
            const backup = {
                version: '2.2.0',
                exportDate: new Date().toISOString(),
                events: appData.events || [],
                pool: appData.pool || [],
                employees: appData.employees || [],
                tours: appData.tours || [],
                wageSettings: appData.wageSettings || {},
                favorites: appData.favorites || []
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tourenplanung-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup exportiert', 'success');
        }
        
        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Validierung
                    if(!data.events && !data.pool && !data.tours) {
                        showToast('Ungültiges Backup-Format', 'error');
                        return;
                    }
                    
                    pendingBackupImport = data;
                    openModal('backupImportConfirmModal');
                } catch(err) {
                    console.error('Fehler beim Lesen des Backups:', err);
                    showToast('Fehler beim Lesen des Backups', 'error');
                }
            };
            input.click();
        }
        
        async function executeOptimization() {
            const scope = document.getElementById('optimizeScopeSelect').value;
            const optimizeFor = document.getElementById('optimizeForSelect').value;
            const typeSeparation = document.getElementById('optimizeTypeSeparation')?.value || 'flexible';
            
            let dayIndex = null;
            let tourId = null;
            
            if (scope === 'tour') {
                tourId = document.getElementById('optimizeTourSelect').value;
                if (!tourId) {
                    showToast('Bitte wähle eine Tour aus', 'error');
                    return;
                }
            } else {
                dayIndex = parseInt(document.getElementById('optimizeDaySelect').value);
            }
            
            try {
                showToast('Optimierung läuft...', 'info');
                
                const requestBody = {
                    variant_id: currentVariantId,
                    optimizeFor: optimizeFor,
                    typeSeparation: typeSeparation,
                    optimizeScope: scope
                };
                
                if (scope === 'tour') {
                    requestBody.tourId = tourId;
                } else {
                    requestBody.dayIndex = dayIndex;
                }
                
                const response = await apiCall('/api/optimize/tours', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.success) {
                    // Speichere Assignments in globaler Variable für späteren Zugriff
                    window.currentOptimizationAssignments = result.optimizedAssignments.assignments;
                    window.currentOptimizationOptimizedEvents = result.optimizedAssignments.optimizedEvents || [];
                    window.currentOptimizationDayIndex = dayIndex;
                    window.currentOptimizationScope = scope;
                    window.currentOptimizationTourId = tourId;
                    
                    // Berechne Statistiken für Anzeige
                    const totalEvents = result.statistics.totalEvents;
                    const assignedEvents = result.statistics.assignedEvents;
                    const unassignedEvents = result.statistics.unassignedEvents;
                    const assignmentRate = totalEvents > 0 ? Math.round((assignedEvents / totalEvents) * 100) : 0;
                    
                    // Prüfe auf Warnungen
                    const warnings = [];
                    if (unassignedEvents > 0) {
                        warnings.push(`${unassignedEvents} Event(s) konnten nicht zugewiesen werden`);
                    }
                    
                    // Zeige Ergebnisse
                    const resultsDiv = document.getElementById('optimizationResults');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <h4 style="margin-top:0; color:var(--success);">✓ Optimierung abgeschlossen</h4>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:15px;">
                            <div style="padding:12px; background:var(--bg-body); border-radius:var(--radius-sm);">
                                <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Zugewiesen</div>
                                <div style="font-size:1.5rem; font-weight:700; color:var(--success);">${assignedEvents}</div>
                                <div style="font-size:0.7rem; color:var(--text-muted);">von ${totalEvents} (${assignmentRate}%)</div>
                            </div>
                            <div style="padding:12px; background:var(--bg-body); border-radius:var(--radius-sm);">
                                <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Touren genutzt</div>
                                <div style="font-size:1.5rem; font-weight:700; color:var(--primary);">${result.statistics.toursUsed}</div>
                                <div style="font-size:0.7rem; color:var(--text-muted);">von ${result.statistics.totalTours}</div>
                            </div>
                        </div>
                        ${warnings.length > 0 ? `
                            <div style="padding:10px; margin-bottom:15px; background:rgba(245, 158, 11, 0.1); border-left:3px solid var(--warning); border-radius:var(--radius-sm);">
                                <strong style="color:var(--warning);">⚠️ Warnungen:</strong>
                                <ul style="margin:8px 0 0 0; padding-left:20px; color:var(--text-muted); font-size:0.85rem;">
                                    ${warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <h4 style="margin-top:15px; margin-bottom:10px;">Tour-Auslastung:</h4>
                        <div style="max-height:200px; overflow-y:auto;">
                            ${result.optimizedAssignments.tourWorkloads.filter(tw => tw.events.length > 0).map(tw => `
                                <div style="padding:8px; margin:5px 0; background:var(--bg-body); border-radius:var(--radius-sm); font-size:0.85rem;">
                                    <strong>${tw.tourName}</strong> ${tw.employeeName !== 'Kein Mitarbeiter' ? `(${tw.employeeName})` : ''}: ${tw.totalHours} h (${tw.events.length} Event${tw.events.length !== 1 ? 's' : ''})
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
                            <button class="btn btn-primary" onclick="applyOptimization(window.currentOptimizationDayIndex, window.currentOptimizationAssignments, window.currentOptimizationScope, window.currentOptimizationTourId, window.currentOptimizationOptimizedEvents)" style="width:100%;">
                                ✓ Optimierung anwenden
                            </button>
                        </div>
                    `;
                    
                    showToast(`Optimierung abgeschlossen: ${assignedEvents} von ${totalEvents} Events zugewiesen`, 'success');
                } else {
                    throw new Error('Optimierung fehlgeschlagen');
                }
            } catch (error) {
                console.error('Optimierungsfehler:', error);
                showToast('Fehler bei Optimierung: ' + error.message, 'error');
            }
        }
        
        async function applyOptimization(dayIndex, assignmentsJson, scope = 'day', tourId = null, optimizedEvents = []) {
            // Konvertiere dayIndex zu Number falls nötig
            if (dayIndex !== null && dayIndex !== undefined) {
                dayIndex = typeof dayIndex === 'string' ? parseInt(dayIndex, 10) : dayIndex;
            }
            try {
                if (!assignmentsJson) {
                    throw new Error('Keine Assignments übergeben');
                }
                const assignments = typeof assignmentsJson === 'string' ? JSON.parse(assignmentsJson) : assignmentsJson;
                if (!Array.isArray(assignments)) {
                    throw new Error('Assignments müssen ein Array sein');
                }
                
                let foundCount = 0;
                let notFoundEventIds = [];
                // Wende Optimierung an
                assignments.forEach(assignment => {
                    if (!assignment || !assignment.eventId || !assignment.tourId) {
                        console.warn('[DEBUG] Invalid assignment', assignment);
                        return;
                    }
                    // Finde Event - für Tour-Optimierung ohne dayIndex-Filter
                    const event = appData.events.find(e => {
                        if (scope === 'tour') {
                            // Bei Tour-Optimierung: nur Event-ID prüfen
                            return e.id === assignment.eventId;
                        } else {
                            // Bei Tag-Optimierung: Event-ID und dayIndex prüfen
                            const eventDayMatch = e.dayIndex === dayIndex || e.dayIndex === String(dayIndex) || String(e.dayIndex) === String(dayIndex);
                            const eventIdMatch = e.id === assignment.eventId;
                            return eventDayMatch && eventIdMatch;
                        }
                    });
                    if (event) {
                        event.extendedProps = event.extendedProps || {};
                        event.extendedProps.tour = assignment.tourId;
                        foundCount++;
                    } else {
                        notFoundEventIds.push(assignment.eventId);
                    }
                });
                
                // Aktualisiere Event-Zeiten basierend auf optimierten Zeiten
                if (optimizedEvents && optimizedEvents.length > 0) {
                    let timeUpdatesCount = 0;
                    optimizedEvents.forEach(optEvent => {
                        const event = appData.events.find(e => e.id === optEvent.id);
                        if (event) {
                            event.start = optEvent.start;
                            event.end = optEvent.end;
                            timeUpdatesCount++;
                        }
                    });
                }
                await executeSave();
                
                refreshView();
                
                // Prüfe Optimierungspotential erneut nach Anwendung
                if (typeof checkOptimizationPotential === 'function') {
                    setTimeout(checkOptimizationPotential, 500);
                }
                closeModal('optimizationModal');
                showToast('Optimierung angewendet', 'success');
                
                // Prüfe Optimierungspotential erneut nach Anwendung
                if (typeof checkOptimizationPotential === 'function') {
                    setTimeout(checkOptimizationPotential, 500);
                }
            } catch (error) {
                console.error('Fehler beim Anwenden der Optimierung:', error);
                showToast('Fehler beim Anwenden der Optimierung', 'error');
            }
        }
        
        async function confirmBackupImport() {
            if(!pendingBackupImport) {
                showToast('Keine Daten zum Importieren', 'error');
                closeModal('backupImportConfirmModal');
                return;
            }
            
            if (!currentVariantId) {
                showToast('Keine Variante ausgewählt', 'error');
                closeModal('backupImportConfirmModal');
                return;
            }
            
            try {
                // Ersetze alle Daten
                appData = {
                    events: pendingBackupImport.events || [],
                    pool: pendingBackupImport.pool || [],
                    employees: pendingBackupImport.employees || [],
                    tours: pendingBackupImport.tours || [],
                    wageSettings: pendingBackupImport.wageSettings || JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS)),
                    favorites: pendingBackupImport.favorites || []
                };
                
                // Führe Migrationen durch
                ensureAppDataDefaults();
                migrateZoneNames();
                cleanupInvalidEvents();
                
                // Speichere über API
                const response = await apiCall('/api/backup/restore', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        data: appData,
                        variant_id: currentVariantId
                    })
                });
                
                if(!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Aktualisiere UI
                refreshUI();
                updatePatientList();
                
                // Zurücksetzen
                pendingBackupImport = null;
                closeModal('backupImportConfirmModal');
                
                showToast('Backup erfolgreich importiert', 'success');
            } catch(e) {
                console.error('Fehler beim Import:', e);
                showAlertModal('Fehler', 'Fehler beim Importieren des Backups:\n\n' + e.message, 'error');
                showToast('Fehler beim Importieren', 'error');
                pendingBackupImport = null;
                closeModal('backupImportConfirmModal');
            }
        }

        // importCSV wurde bereits oben definiert
        
        function startCSVUpload() {
            closeModal('csvImportModal');
            document.getElementById('csvFileInput').click();
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    
                    if(lines.length < 2) {
                        showAlertModal('Fehler', 'CSV-Datei ist leer oder hat kein gültiges Format.', 'error');
                        return;
                    }
                    
                    // Skip header
                    let imported = 0;
                    for(let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(';').map(p => p.replace(/"/g, '').trim());
                        if(parts.length >= 1 && parts[0]) {
                            const name = parts[0];
                            const zone = parts[1] || 'Alt-/Neustadt';
                            const typesStr = parts[2] || 'care';
                            const types = typesStr.split(',').map(t => t.trim().toLowerCase()).filter(t => ['care', 'house', 'social', 'other'].includes(t));
                            
                            // Add to pool
                            appData.pool.push({
                                id: generateId(),
                                title: name,
                                zone: zone,
                                types: types.length ? types : ['other']
                            });
                            imported++;
                        }
                    }
                    
                    queueSave();
                    renderPool();
                    showAlertModal('Erfolg', `${imported} Kunden importiert.`, 'success');
                } catch(err) {
                    console.error(err);
                    showAlertModal('Fehler', 'Fehler beim Import: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            // Escape = Clear selection
            if(e.key === 'Escape') {
                clearEventSelection();
            }
            // Strg+Z = Undo
            if(e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            // Strg+S = Save
            if(e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToFileManual();
            }
            // Strg+A = Select all visible events
            if(e.ctrlKey && e.key === 'a' && !document.querySelector('.modal-overlay[style*="flex"]')) {
                e.preventDefault();
                document.querySelectorAll('.week-event-row:not(.is-travel)').forEach(el => {
                    const evtId = el.getAttribute('data-event-id');
                    if(evtId) {
                        selectedEvents.add(evtId);
                        el.classList.add('selected');
                    }
                });
            }
            // N = New event (when no modal open)
            if(e.key && String(e.key).toLowerCase() === 'n') {
                const t = e.target;
                const tag = t && t.tagName ? String(t.tagName).toLowerCase() : null;
                const isInputLike = !!(t && (t.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select'));
                const modalOpen = !!document.querySelector('.modal-overlay[style*="flex"]');
                if (!modalOpen && !isInputLike) {
                e.preventDefault();
                openEventModal(null, { start: '08:00', end: '09:00', dayIndex: 0 });
                } else {
                }
            }
            // ? or F1 = Show keyboard help
            if((e.key === '?' || e.key === 'F1') && !document.querySelector('.modal-overlay[style*="flex"]')) {
                e.preventDefault();
                openModal('keyboardHelpModal');
            }
            // Delete = Delete current event
            if(e.key === 'Delete' && currentEvent && document.getElementById('eventModal').style.display === 'flex') {
                e.preventDefault();
                deleteEvent();
            }
        });

        // --- CONTEXT MENU ---
        // contextMenuEvent ist bereits oben als globale Variable deklariert
        
        function showContextMenu(e, evt) {
            e.preventDefault();
            contextMenuEvent = evt;
            
            const menu = document.getElementById('contextMenu');
            if(!menu) return;
            
            // Position menu at cursor
            const x = e.clientX;
            const y = e.clientY;
            
            // Ensure menu doesn't go off screen
            menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
            menu.classList.add('visible');
        }
        
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            if(menu) menu.classList.remove('visible');
            contextMenuEvent = null;
        }
        
        function contextMenuEdit() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToEdit = contextMenuEvent;
            hideContextMenu();
            if(eventToEdit) {
                currentEvent = eventToEdit;
                openEventModal(eventToEdit);
            }
        }
        
        function contextMenuDuplicate() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToDuplicate = contextMenuEvent;
            hideContextMenu();
            if(!eventToDuplicate) return;
            
            saveUndoState();
            const newEvent = {
                id: generateId(),
                title: eventToDuplicate.title,
                start: eventToDuplicate.start,
                end: eventToDuplicate.end,
                dayIndex: eventToDuplicate.dayIndex,
                extendedProps: { ...eventToDuplicate.extendedProps }
            };
            appData.events.push(newEvent);
            queueSave();
            refreshView();
            showToast('Einsatz dupliziert', 'success');
        }
        
        function contextMenuToPool() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToMove = contextMenuEvent;
            hideContextMenu();
            if(!eventToMove) return;
            
            clearAllTooltips(); // Clear tooltips before removing elements
            // Small delay to ensure browser processes tooltip removal
            setTimeout(() => {
                saveUndoState();
                appData.pool.push({
                    id: generateId(),
                    title: eventToMove.title,
                    zone: eventToMove.extendedProps?.zone || 'Alt-/Neustadt',
                    types: eventToMove.extendedProps?.types || ['other']
                });
                appData.events = appData.events.filter(e => e.id !== eventToMove.id);
                queueSave();
                renderPool();
                refreshView();
                showToast('In Pool verschoben', 'success');
            }, 10);
        }
        
        function contextMenuDelete() {
            // Speichere Event bevor hideContextMenu() es auf null setzt
            const eventToDelete = contextMenuEvent;
            hideContextMenu();
            if(!eventToDelete) return;
            
            clearAllTooltips(); // Clear tooltips before removing elements
            // Small delay to ensure browser processes tooltip removal
            setTimeout(() => {
                saveUndoState();
                const title = eventToDelete.title;
                appData.events = appData.events.filter(e => e.id !== eventToDelete.id);
                queueSave();
                refreshView();
                showToast(`"${title}" gelöscht`, 'success');
            }, 10);
        }
        
        // Close context menu on click anywhere
        document.addEventListener('click', hideContextMenu);
        document.addEventListener('contextmenu', (e) => {
            if(!e.target.closest('.week-event-row')) {
                hideContextMenu();
            }
        });

        // showToast wurde bereits oben definiert

        // --- AUTO-SAVE ---
        let lastSaveTime = null;
        
        function updateLastSaveDisplay() {
            const el = document.getElementById('lastSaveDisplay');
            if(el && lastSaveTime) {
                const timeStr = lastSaveTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                el.textContent = `💾 Zuletzt gespeichert: ${timeStr}`;
            }
        }
        
        setInterval(async () => {
            if(appData.events.length > 0 || appData.pool.length > 0) {
                try {
                    await dbSave(STORE_NAME, 'mainData', appData);
                    // Sync-Funktion entfernt - Daten werden über API gespeichert
                lastSaveTime = new Date();
                const statusEl = document.getElementById('fileStatus');
                if(statusEl && !fileHandle) {
                        statusEl.innerText = `Auto-Save aktiv (IndexedDB)`;
                    }
                    updateLastSaveDisplay();
                } catch(e) {
                    console.error('Auto-Save Fehler:', e);
                    localStorage.setItem('pd_v16_data', JSON.stringify(appData)); // Fallback
                }
            }
        }, 60000); // Every 60 seconds

        // Zeige zugewiesenen Mitarbeiter für ausgewählte Tour an
        // updateTourEmployeeDisplay wurde bereits oben definiert

        // Filter-Funktionen für Gesamtansicht
        // toggleFilterGroup wurde bereits oben definiert

        function closeFilterGroups() {
            document.querySelectorAll('.filter-group-toggle').forEach(btn => btn.classList.remove('open'));
            document.querySelectorAll('.filter-dropdown').forEach(dropdown => dropdown.classList.remove('show'));
        }

        // Close filter dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-group-compact')) {
                closeFilterGroups();
            }
        });

        function updateOverallDayFilter() {
            const checkboxes = document.querySelectorAll('#overallControls .day-checkbox-compact input[type="checkbox"]');
            overallDayFilter = [];
            checkboxes.forEach(cb => {
                const label = cb.closest('.day-checkbox-compact');
                if(cb.checked) {
                    overallDayFilter.push(parseInt(cb.value));
                    if(label) {
                        label.style.borderColor = 'var(--primary)';
                        label.style.background = 'var(--primary-light)';
                        label.style.color = 'var(--primary)';
                    }
                } else {
                    if(label) {
                        label.style.borderColor = 'var(--border)';
                        label.style.background = 'var(--bg-hover)';
                        label.style.color = 'var(--text-main)';
                    }
                }
            });
            
            // Mindestens ein Tag muss ausgewählt sein
            if(overallDayFilter.length === 0) {
                overallDayFilter = [0, 1, 2, 3, 4, 5, 6];
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    const label = cb.closest('.day-checkbox-compact');
                    if(label) {
                        label.style.borderColor = 'var(--primary)';
                        label.style.background = 'var(--primary-light)';
                        label.style.color = 'var(--primary)';
                    }
                });
            }
            
            // Update label
            updateDayFilterLabel();
            
            refreshView();
        }
        
        // selectAllDays, deselectAllDays wurden bereits oben definiert

        function populateOverallTourFilter() {
            const container = document.getElementById('overallTourFilterContainer');
            if(!container) return;
            container.innerHTML = '';
            if(!appData.tours || appData.tours.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted); font-size:0.85rem; padding:8px;">Keine Touren vorhanden</div>';
                return;
            }
            
            appData.tours.forEach(tour => {
                const isSelected = overallTourFilter.length === 0 || overallTourFilter.includes(tour.id);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-sm';
                button.style.cssText = `
                    padding:8px 14px;
                    border:2px solid ${isSelected ? 'var(--primary)' : 'var(--border)'};
                    background:${isSelected ? 'var(--primary-light)' : 'var(--bg-hover)'};
                    color:${isSelected ? 'var(--primary)' : 'var(--text-main)'};
                    font-size:0.85rem;
                    font-weight:500;
                    border-radius:var(--radius-md);
                    cursor:pointer;
                    transition:all 0.2s;
                    white-space:nowrap;
                `;
                button.textContent = tour.name;
                button.onclick = (e) => {
                    e.stopPropagation();
                    if(overallTourFilter.includes(tour.id)) {
                        overallTourFilter = overallTourFilter.filter(id => id !== tour.id);
                        button.style.borderColor = 'var(--border)';
                        button.style.background = 'var(--bg-hover)';
                        button.style.color = 'var(--text-main)';
                    } else {
                        overallTourFilter.push(tour.id);
                        button.style.borderColor = 'var(--primary)';
                        button.style.background = 'var(--primary-light)';
                        button.style.color = 'var(--primary)';
                    }
                    // Wenn keine Tour ausgewählt, zeige alle
                    if(overallTourFilter.length === 0) {
                        overallTourFilter = appData.tours.map(t => t.id);
                        appData.tours.forEach(t => {
                            const btn = Array.from(container.children).find(b => b.textContent === t.name);
                            if(btn) {
                                btn.style.borderColor = 'var(--primary)';
                                btn.style.background = 'var(--primary-light)';
                                btn.style.color = 'var(--primary)';
                            }
                        });
                    }
                    updateTourFilterLabel();
                    refreshView();
                };
                button.onmouseover = function() {
                    if(!overallTourFilter.includes(tour.id)) {
                        this.style.borderColor = 'var(--primary)';
                        this.style.background = 'var(--primary-light)';
                    }
                };
                button.onmouseout = function() {
                    if(!overallTourFilter.includes(tour.id)) {
                        this.style.borderColor = 'var(--border)';
                        this.style.background = 'var(--bg-hover)';
                    }
                };
                container.appendChild(button);
            });
            updateTourFilterLabel();
        }

        function updateOverallTourFilter() {
            // Wird jetzt direkt in populateOverallTourFilter() Button-Handlers behandelt
            refreshView();
        }
        
        function updateDayFilterLabel() {
            const dayNamesShort = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const selectedDaysStr = overallDayFilter.map(i => dayNamesShort[i]).join(', ');
            const labelEl = document.getElementById('filterDaysLabel');
            if (labelEl) {
                labelEl.textContent = overallDayFilter.length === 7 ? 'Alle Tage' : selectedDaysStr;
            }
        }

        function updateTourFilterLabel() {
            const labelEl = document.getElementById('filterToursLabel');
            if (!labelEl || !appData.tours) return;
            
            if (overallTourFilter.length === 0 || overallTourFilter.length === appData.tours.length) {
                labelEl.textContent = 'Alle Touren';
            } else {
                const selectedTours = appData.tours.filter(t => overallTourFilter.includes(t.id));
                if (selectedTours.length === 1) {
                    labelEl.textContent = selectedTours[0].name;
                } else {
                    labelEl.textContent = `${selectedTours.length} Touren`;
                }
            }
        }

        // selectAllTours, deselectAllTours wurden bereits oben definiert

        function updateOverallConflictCount(events) {
            const conflictInfo = document.getElementById('overallConflictInfo');
            const conflictCount = document.getElementById('overallConflictCount');
            if(!conflictInfo || !conflictCount) return;
            
            // Zähle alle Überschneidungen
            const realEvents = filterRealEvents(events);
            let totalConflicts = 0;
            const conflictPairs = new Set(); // Um doppelte Zählung zu vermeiden
            
            realEvents.forEach((evt1, idx) => {
                const conflicts = getEventConflicts(evt1, realEvents);
                conflicts.forEach(evt2 => {
                    // Erstelle ein eindeutiges Paar (immer kleinerer Index zuerst)
                    const pairId = evt1.id < evt2.id ? `${evt1.id}-${evt2.id}` : `${evt2.id}-${evt1.id}`;
                    if(!conflictPairs.has(pairId)) {
                        conflictPairs.add(pairId);
                        totalConflicts++;
                    }
                });
            });
            
            if(totalConflicts > 0) {
                conflictCount.textContent = totalConflicts;
                conflictInfo.style.display = 'inline-block';
            } else {
                conflictInfo.style.display = 'none';
            }
        }

        // refreshUI wurde bereits oben definiert
        function renderList(id, l, cb, updateCb){
            const el = document.getElementById(id); 
            if(!el) return;
            el.innerHTML = ''; 
            const isTourList = id === 'tourList';
            const isEmployeeList = id === 'employeeList';
            
            l.forEach(i => {
                const entry = document.createElement('div');
                entry.className = 'item-list-entry';
                entry.style.flexWrap = 'wrap';
                
                const name = String(i.name || '').replace(/[<>]/g, '');
                
                const topRow = document.createElement('div');
                topRow.style.cssText = 'display:flex; align-items:center; justify-content:space-between; width:100%;';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'item-name';
                nameSpan.textContent = name;
                nameSpan.title = 'Klicken zum Bearbeiten';
                nameSpan.style.cursor = 'pointer';
                
                // Click to edit
                nameSpan.onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = name;
                    input.className = 'item-edit-input';
                    input.style.cssText = 'flex:1; margin:0; padding:6px 10px; font-size:0.9rem;';
                    
                    const saveEdit = () => {
                        const newName = input.value.trim();
                        if(newName && newName !== name) {
                            updateCb(i.id, newName);
                        } else {
                            refreshUI(); // Restore
                        }
                    };
                    
                    input.onblur = saveEdit;
                    input.onkeydown = (e) => {
                        if(e.key === 'Enter') saveEdit();
                        if(e.key === 'Escape') refreshUI();
                    };
                    
                    topRow.innerHTML = '';
                    topRow.appendChild(input);
                    input.focus();
                    input.select();
                };
                
                const actionsDiv = document.createElement('div');
                actionsDiv.style.cssText = 'display:flex; gap:4px; align-items:center;';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'item-edit';
                editBtn.innerHTML = '✏️';
                editBtn.title = 'Bearbeiten';
                editBtn.onclick = () => nameSpan.click();
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'item-delete';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Löschen';
                deleteBtn.onclick = () => cb(i.id);
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                
                topRow.appendChild(nameSpan);
                topRow.appendChild(actionsDiv);
                entry.appendChild(topRow);
                
                // Add hours limit and employee assignment for tours
                if(isTourList) {
                    const settingsRow = document.createElement('div');
                    settingsRow.style.cssText = 'width:100%; margin-top:8px; padding-top:8px; border-top:1px dashed var(--border); display:flex; gap:16px; flex-wrap:wrap; align-items:center;';
                    
                    // Hours limit
                    const hoursDiv = document.createElement('div');
                    hoursDiv.style.cssText = 'display:flex; align-items:center; gap:6px;';
                    
                    const hoursLabel = document.createElement('span');
                    hoursLabel.style.cssText = 'font-size:0.75rem; color:var(--text-muted);';
                    hoursLabel.textContent = 'Std/Woche:';
                    
                    const hoursInput = document.createElement('input');
                    hoursInput.type = 'number';
                    hoursInput.min = '0';
                    hoursInput.max = '168';
                    hoursInput.value = i.weeklyHoursLimit || '';
                    hoursInput.placeholder = '∞';
                    hoursInput.style.cssText = 'width:70px; height:36px; padding:0 8px; font-size:0.8rem; margin:0; text-align:center;';
                    
                    // Calculate current hours for this tour - biweekly counts half
                    const tourEvents = filterRealEvents(appData.events.filter(e => e.extendedProps?.tour === i.id));
                    let currentHours = 0;
                    tourEvents.forEach(e => {
                        currentHours += getEventDuration(e) / 60;
                    });
                    
                    const hoursStatus = document.createElement('span');
                    hoursStatus.style.cssText = 'font-size:0.7rem; padding:2px 6px; border-radius:4px;';
                    if(i.weeklyHoursLimit && currentHours > i.weeklyHoursLimit) {
                        hoursStatus.style.background = 'rgba(239, 68, 68, 0.15)';
                        hoursStatus.style.color = 'var(--danger)';
                        hoursStatus.textContent = `${currentHours.toFixed(1)}h ⚠`;
                    } else if(i.weeklyHoursLimit) {
                        hoursStatus.style.background = 'rgba(16, 185, 129, 0.15)';
                        hoursStatus.style.color = 'var(--success)';
                        hoursStatus.textContent = `${currentHours.toFixed(1)}h`;
                    } else {
                        hoursStatus.style.color = 'var(--text-light)';
                        hoursStatus.textContent = `${currentHours.toFixed(1)}h`;
                    }
                    
                    hoursInput.onchange = () => {
                        const tour = appData.tours.find(t => t.id === i.id);
                        if(tour) {
                            tour.weeklyHoursLimit = hoursInput.value ? parseInt(hoursInput.value) : null;
                            queueSave();
                            refreshUI();
                        }
                    };
                    
                    hoursDiv.appendChild(hoursLabel);
                    hoursDiv.appendChild(hoursInput);
                    hoursDiv.appendChild(hoursStatus);
                    settingsRow.appendChild(hoursDiv);
                    
                    // Employee assignment - always show
                    const empDiv = document.createElement('div');
                    empDiv.style.cssText = 'display:flex; align-items:center; gap:6px;';
                    
                    const empLabel = document.createElement('span');
                    empLabel.style.cssText = 'font-size:0.75rem; color:var(--text-muted);';
                    empLabel.textContent = 'Mitarbeiter:in:';
                    
                    if(appData.employees && appData.employees.length > 0) {
                        const empSelect = document.createElement('select');
                        empSelect.style.cssText = 'width:auto; min-width:120px; height:36px; padding:0 24px 0 8px; font-size:0.8rem; margin:0;';
                        empSelect.innerHTML = '<option value="">-- Auswählen --</option>';
                        appData.employees.forEach(emp => {
                            const opt = document.createElement('option');
                            opt.value = emp.id;
                            opt.textContent = emp.name;
                            if(i.employeeId === emp.id) opt.selected = true;
                            empSelect.appendChild(opt);
                        });
                        
                        empSelect.onchange = () => {
                            const tour = appData.tours.find(t => t.id === i.id);
                            if(tour) {
                                tour.employeeId = empSelect.value || null;
                                queueSave();
                                refreshUI();
                                updateTourEmployeeDisplay(); // Aktualisiere Anzeige wenn Tour ausgewählt ist
                            }
                        };
                        
                        empDiv.appendChild(empLabel);
                        empDiv.appendChild(empSelect);
                    } else {
                        const empHint = document.createElement('span');
                        empHint.style.cssText = 'font-size:0.75rem; color:var(--text-light); font-style:italic;';
                        empHint.textContent = 'Erst Team anlegen';
                        empDiv.appendChild(empLabel);
                        empDiv.appendChild(empHint);
                    }
                    
                    settingsRow.appendChild(empDiv);
                    
                    entry.appendChild(settingsRow);
                }
                
                // Add hours for employees
                if(isEmployeeList) {
                    const settingsRow = document.createElement('div');
                    settingsRow.style.cssText = 'width:100%; margin-top:8px; padding-top:8px; border-top:1px dashed var(--border); display:flex; gap:12px; flex-wrap:wrap; align-items:center;';
                    
                    // Weekly hours
                    const hoursDiv = document.createElement('div');
                    hoursDiv.style.cssText = 'display:flex; align-items:center; gap:4px;';
                    
                    const hoursLabel = document.createElement('span');
                    hoursLabel.style.cssText = 'font-size:0.7rem; color:var(--text-muted);';
                    hoursLabel.textContent = 'Std:';
                    
                    const hoursInput = document.createElement('input');
                    hoursInput.type = 'number';
                    hoursInput.min = '0';
                    hoursInput.max = '60';
                    hoursInput.value = i.weeklyHours || 40;
                    hoursInput.style.cssText = 'width:55px; height:32px; padding:0 6px; font-size:0.8rem; margin:0; text-align:center;';
                    
                    hoursInput.onchange = () => {
                        const emp = appData.employees.find(e => e.id === i.id);
                        if(emp) {
                            emp.weeklyHours = hoursInput.value ? parseInt(hoursInput.value) : 40;
                            queueSave();
                            updateCapacityDisplay();
                        }
                    };
                    
                    hoursDiv.appendChild(hoursLabel);
                    hoursDiv.appendChild(hoursInput);
                    settingsRow.appendChild(hoursDiv);
                    
                    // Wage Group
                    const wageDiv = document.createElement('div');
                    wageDiv.style.cssText = 'display:flex; align-items:center; gap:4px;';
                    
                    const wageLabel = document.createElement('span');
                    wageLabel.style.cssText = 'font-size:0.7rem; color:var(--text-muted);';
                    wageLabel.textContent = '💰';
                    
                    const wageSelect = document.createElement('select');
                    wageSelect.className = 'emp-wage-group-select';
                    wageSelect.style.cssText = 'width:auto; min-width:100px; height:32px; padding:0 20px 0 6px; font-size:0.75rem; margin:0;';
                    
                    const groups = appData.wageSettings?.wageGroups || DEFAULT_WAGE_SETTINGS.wageGroups;
                    groups.forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g.id;
                        opt.textContent = g.name + ' (' + g.hourlyRate.toFixed(2) + '€)';
                        if(i.wageGroup === g.id) opt.selected = true;
                        wageSelect.appendChild(opt);
                    });
                    
                    // Default to first group if not set
                    if(!i.wageGroup && groups.length > 0) {
                        wageSelect.value = groups[1]?.id || groups[0]?.id;
                    }
                    
                    wageSelect.onchange = () => {
                        const emp = appData.employees.find(e => e.id === i.id);
                        if(emp) {
                            emp.wageGroup = wageSelect.value;
                            queueSave();
                        }
                    };
                    
                    wageDiv.appendChild(wageLabel);
                    wageDiv.appendChild(wageSelect);
                    settingsRow.appendChild(wageDiv);
                    
                    // Transport
                    const transportDiv = document.createElement('div');
                    transportDiv.style.cssText = 'display:flex; align-items:center; gap:4px;';
                    
                    const transportSelect = document.createElement('select');
                    transportSelect.style.cssText = 'width:auto; min-width:80px; height:32px; padding:0 20px 0 6px; font-size:0.75rem; margin:0;';
                    transportSelect.innerHTML = `
                        <option value="car" ${i.transport === 'car' ? 'selected' : ''}>🚘 PKW</option>
                        <option value="public" ${i.transport === 'public' ? 'selected' : ''}>🚌 Öffis</option>
                    `;
                    
                    transportSelect.onchange = () => {
                        const emp = appData.employees.find(e => e.id === i.id);
                        if(emp) {
                            emp.transport = transportSelect.value;
                            queueSave();
                        }
                    };
                    
                    transportDiv.appendChild(transportSelect);
                    settingsRow.appendChild(transportDiv);
                    
                    // Home Zone
                    const homeZoneDiv = document.createElement('div');
                    homeZoneDiv.style.cssText = 'display:flex; align-items:center; gap:4px;';
                    
                    const homeLabel = document.createElement('span');
                    homeLabel.style.cssText = 'font-size:0.7rem; color:var(--text-muted);';
                    homeLabel.textContent = '🏠';
                    
                    const homeZoneSelect = document.createElement('select');
                    homeZoneSelect.className = 'emp-home-zone-select';
                    homeZoneSelect.style.cssText = 'width:auto; min-width:90px; height:32px; padding:0 20px 0 6px; font-size:0.75rem; margin:0;';
                    homeZoneSelect.innerHTML = '<option value="">-- Wohnort --</option>';
                    CITY_ZONES.forEach(zone => {
                        const opt = document.createElement('option');
                        opt.value = zone;
                        opt.textContent = getZoneWithPostalCode(zone);
                        if(i.homeZone === zone) opt.selected = true;
                        homeZoneSelect.appendChild(opt);
                    });
                    
                    homeZoneSelect.onchange = () => {
                        const emp = appData.employees.find(e => e.id === i.id);
                        if(emp) {
                            emp.homeZone = homeZoneSelect.value;
                            queueSave();
                            refreshView(); // Update commute display
                        }
                    };
                    
                    homeZoneDiv.appendChild(homeLabel);
                    homeZoneDiv.appendChild(homeZoneSelect);
                    settingsRow.appendChild(homeZoneDiv);
                    
                    // Show which tour this employee is assigned to
                    const assignedTour = appData.tours.find(t => t.employeeId === i.id);
                    if(assignedTour) {
                        const tourBadge = document.createElement('span');
                        tourBadge.style.cssText = 'font-size:0.65rem; padding:2px 6px; border-radius:4px; background:rgba(99, 102, 241, 0.15); color:var(--primary);';
                        tourBadge.textContent = '🚗 ' + assignedTour.name;
                        settingsRow.appendChild(tourBadge);
                    }
                    
                    entry.appendChild(settingsRow);
                }
                
                el.appendChild(entry);
            });
        }

        function openEventModal(ev, info){
            currentEvent=ev; 
            document.getElementById('modalTitle').innerText=ev?'Bearbeiten':'Neu';
            document.getElementById('eventId').value = ev ? ev.id : '';
            
            // Handle Pool Data or Info
            const title = ev ? ev.title : (info && info.title ? info.title : '');
            const zone = ev ? ev.extendedProps.zone : (info && info.zone ? info.zone : 'Alt-/Neustadt');
            const types = ev ? ev.extendedProps.types : (info && info.types ? info.types : ['care']);
            
            document.getElementById('eventClient').value = title;
            document.getElementById('eventZone').value = zone;
            
            // Handle Pool Origin
            const modal = document.getElementById('eventModal');
            const poolId = ev ? ev.extendedProps?.poolId : (info && info.fromPoolId ? info.fromPoolId : null);
            
            if(info && info.fromPoolId) {
                modal.dataset.fromPoolId = info.fromPoolId;
            } else if (ev && ev.extendedProps?.poolId) {
                // Behalte poolId aus Event beim Bearbeiten
                modal.dataset.fromPoolId = ev.extendedProps.poolId;
            } else {
                delete modal.dataset.fromPoolId;
            }
            
            // Zeige Adresse und Koordinaten falls vorhanden (aus Pool-Item) - kombiniert in einem Block
            const locationDisplay = document.getElementById('eventLocationDisplay');
            const addressText = document.getElementById('eventAddressText');
            const coordinatesText = document.getElementById('eventCoordinatesText');
            
            let hasAddress = false;
            let hasCoordinates = false;
            
            if (poolId) {
                const poolItem = appData.pool?.find(p => p.id === poolId);
                if (poolItem) {
                    // Zeige Adresse falls vorhanden
                    if (poolItem.address || poolItem.postalCode) {
                        let addressParts = [];
                        if (poolItem.address) addressParts.push(poolItem.address);
                        if (poolItem.postalCode) addressParts.push(poolItem.postalCode);
                        addressText.innerHTML = `<strong>📍 Adresse:</strong> ${addressParts.join(', ')}`;
                        hasAddress = true;
                    } else {
                        addressText.textContent = '';
                    }
                    
                    // Zeige Koordinaten falls vorhanden
                    const coordinates = poolItem.extendedProps?.coordinates || poolItem.extended_props?.coordinates;
                    if (coordinates && coordinates.lat && coordinates.lng) {
                        coordinatesText.textContent = `Koordinaten: ${coordinates.lat.toFixed(6)}°N, ${coordinates.lng.toFixed(6)}°E`;
                        hasCoordinates = true;
                    } else {
                        coordinatesText.textContent = '';
                    }
                } else {
                    // Pool-Item nicht gefunden - verwende Fallback aus Event extendedProps
                    const eventAddress = ev?.extendedProps?.address;
                    const eventPostalCode = ev?.extendedProps?.postalCode;
                    const eventCoordinates = ev?.extendedProps?.coordinates;
                    
                    if (eventAddress || eventPostalCode) {
                        let addressParts = [];
                        if (eventAddress) addressParts.push(eventAddress);
                        if (eventPostalCode) addressParts.push(eventPostalCode);
                        addressText.innerHTML = `<strong>📍 Adresse:</strong> ${addressParts.join(', ')}`;
                        hasAddress = true;
                    } else {
                        addressText.textContent = '';
                    }
                    
                    if (eventCoordinates && eventCoordinates.lat && eventCoordinates.lng) {
                        coordinatesText.textContent = `Koordinaten: ${eventCoordinates.lat.toFixed(6)}°N, ${eventCoordinates.lng.toFixed(6)}°E`;
                        hasCoordinates = true;
                    } else {
                        coordinatesText.textContent = '';
                    }
                }
            } else {
                addressText.textContent = '';
                coordinatesText.textContent = '';
            }
            
            // Zeige Location-Display nur wenn mindestens eine Information vorhanden ist
            if (hasAddress || hasCoordinates) {
                locationDisplay.style.display = 'block';
            } else {
                locationDisplay.style.display = 'none';
            }

            const defaultTour = document.getElementById('tourSelect') ? document.getElementById('tourSelect').value : ((appData.tours && appData.tours.length) ? appData.tours[0].id : 't1');
            const preselectedTour = ev ? ev.extendedProps.tour : (info && info.tour ? info.tour : defaultTour);
            document.getElementById('eventTourSelect').value = preselectedTour;
            
            if(document.getElementById('eventRhythm')) {
                document.getElementById('eventRhythm').value=ev?(ev.extendedProps.rhythm || 'weekly'):'weekly';
            }
            if(document.getElementById('eventTag')) {
                document.getElementById('eventTag').value=ev?(ev.extendedProps.tag || ''):'';
            }
            
            // Set time fields
            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            let startVal, endVal, dayIdx;
            
            if(ev) {
                // Editing existing event
                startVal = ev.start;
                endVal = ev.end;
                dayIdx = ev.dayIndex;
            } else {
                // New event (from pool drop or manual)
                startVal = info && info.start ? info.start : '08:00';
                endVal = info && info.end ? info.end : '09:00';
                dayIdx = info && info.dayIndex !== undefined ? info.dayIndex : 0;
            }
            
            // Store in dataset
                modal.dataset.start = startVal;
                modal.dataset.end = endVal;
                modal.dataset.dayIndex = dayIdx;
            
            // Fill time inputs
            document.getElementById('eventStartTime').value = startVal;
            document.getElementById('eventEndTime').value = endVal;
            const dayLabel = document.getElementById('eventDayLabel');
            if(dayLabel) {
                dayLabel.textContent = dayNames[dayIdx] ? `📅 ${dayNames[dayIdx]}` : '';
            }
            
            // Update duration display
            updateEventDuration();
            
            // Add change listeners for duration calculation
            document.getElementById('eventStartTime').onchange = updateEventDuration;
            document.getElementById('eventEndTime').onchange = updateEventDuration;
            
            document.querySelectorAll('.event-cb').forEach(c=>c.checked=false);
            // Zeige/Verstecke Duplizieren-Button nur beim Bearbeiten
            const duplicateBtn = document.getElementById('duplicateBtn');
            if(duplicateBtn) {
                duplicateBtn.style.display = ev ? 'inline-flex' : 'none';
            }
            
            types.forEach(t=>{const c=document.querySelector(`.event-cb[value="${t}"]`);if(c)c.checked=true;});
            
            openModal('eventModal');
            document.getElementById('eventClient').focus();
        }
        
        function updateEventDuration() {
            const startTime = document.getElementById('eventStartTime').value;
            const endTime = document.getElementById('eventEndTime').value;
            const durationEl = document.getElementById('eventDuration');
            
            if(startTime && endTime) {
                const startMin = parseTimeToMinutes(startTime);
                const endMin = parseTimeToMinutes(endTime);
                const duration = endMin - startMin;
                
                if(duration > 0) {
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    durationEl.textContent = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                    durationEl.style.color = 'var(--primary)';
                } else {
                    durationEl.textContent = 'Ungültig';
                    durationEl.style.color = 'var(--danger)';
                }
            } else {
                durationEl.textContent = '--';
            }
            
            // Update dataset
            const modal = document.getElementById('eventModal');
            modal.dataset.start = startTime;
            modal.dataset.end = endTime;
        }

        // openFile, saveToFileManual wurden bereits oben definiert
        // ensureAppDataDefaults, migrateZoneNames, cleanupInvalidEvents wurden bereits oben definiert
        
        async function loadFromAPI(){
            if (!currentVariantId) {
                console.warn('Keine Variante ausgewählt');
                return;
            }
            
            try {
                const response = await apiCall(`/api/data?variant_id=${currentVariantId}`);
                if(!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                appData = data;
                ensureAppDataDefaults();
                
                // Migrate old zone names to new combined zone
                migrateZoneNames();
                
                // Bereinige veraltete Einsätze ohne dayIndex
                cleanupInvalidEvents();
                
                console.log('Daten erfolgreich vom Server geladen');
                
                // Starte Monitoring des Optimierungspotentials nach dem Laden
                if (typeof startOptimizationPotentialMonitoring === 'function') {
                    startOptimizationPotentialMonitoring();
                }
            } catch(e) {
                console.error('Fehler beim Laden vom Server:', e);
                throw e;
            }
        }
        
        // updateVariantSelect, switchVariant wurden bereits oben definiert
        
        // openVariantModal wurde bereits oben definiert
        
        // duplicateVariant und handleDuplicateVariant wurden bereits oben definiert
        
        function showVariantContextMenu(event, variantId) {
            if (!variantId) return;
            
            // Entferne vorhandenes Menü falls vorhanden
            const existingMenu = document.getElementById('variantContextMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Erstelle Kontextmenü
            const menu = document.createElement('div');
            menu.id = 'variantContextMenu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                min-width: 180px;
                padding: 4px;
            `;
            
            // Hilfsfunktion zum Erstellen von Menüoptionen
            const createMenuItem = (text, onClick, isDanger = false) => {
                const item = document.createElement('div');
                item.textContent = text;
                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    border-radius: var(--radius-sm);
                    font-size: 0.875rem;
                    ${isDanger ? 'color: var(--danger);' : ''}
                `;
                item.onmouseenter = () => {
                    item.style.background = isDanger ? 'rgba(239, 68, 68, 0.1)' : 'var(--border-light)';
                };
                item.onmouseleave = () => {
                    item.style.background = 'transparent';
                };
                item.onclick = () => {
                    menu.remove();
                    onClick();
                };
                return item;
            };
            
            // Umbenennen-Option
            const renameOption = createMenuItem('✏️ Umbenennen', () => {
                handleRenameVariant(variantId);
            });
            menu.appendChild(renameOption);
            
            // Duplizieren-Option
            const duplicateOption = createMenuItem('📋 Duplizieren', () => {
                handleDuplicateVariant(variantId);
            });
            menu.appendChild(duplicateOption);
            
            // Trennlinie
            const separator = document.createElement('div');
            separator.style.cssText = `
                height: 1px;
                background: var(--border);
                margin: 4px 0;
            `;
            menu.appendChild(separator);
            
            // Löschen-Option
            const deleteOption = createMenuItem('🗑️ Löschen', () => {
                handleDeleteVariant(variantId);
            }, true);
            menu.appendChild(deleteOption);
            
            document.body.appendChild(menu);
            
            // Schließe Menü beim Klick außerhalb
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }
        
        async function handleRenameVariant(variantId) {
            if (!variantId) {
                showToast('Keine Variante zum Umbenennen ausgewählt', 'error');
                return;
            }
            
            const variant = variants.find(v => v.id === variantId);
            if (!variant) {
                showToast('Variante nicht gefunden', 'error');
                return;
            }
            
            showInputModal('Variante umbenennen', 'Neuer Name der Variante:', variant.name, async (newName) => {
                if (!newName || newName.trim() === '' || newName.trim() === variant.name) {
                    return;
                }
                
                try {
                    const response = await apiCall(`/api/variants/${variantId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name: newName.trim() })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Fehler beim Umbenennen');
                    }
                    
                    const updatedVariant = await response.json();
                    
                    // Aktualisiere Variantenliste
                    const index = variants.findIndex(v => v.id === variantId);
                    if (index !== -1) {
                        variants[index] = updatedVariant;
                    }
                    
                    // Aktualisiere UI
                    updateVariantSelect();
                    
                    showToast(`Variante umbenannt zu "${updatedVariant.name}"`, 'success');
                } catch (error) {
                    console.error('Fehler beim Umbenennen der Variante:', error);
                    showToast('Fehler beim Umbenennen: ' + error.message, 'error');
                }
            });
        }
        
        async function handleDeleteVariant(variantId) {
            if (!variantId) {
                showToast('Keine Variante zum Löschen ausgewählt', 'error');
                return;
            }
            
            const variant = variants.find(v => v.id === variantId);
            if (!variant) {
                showToast('Variante nicht gefunden', 'error');
                return;
            }
            
            // Warnung wenn es die letzte Variante ist
            if (variants.length === 1) {
                showToast('Die letzte Variante kann nicht gelöscht werden', 'error');
                return;
            }
            
            // Bestätigung
            const confirmed = confirm(
                `⚠️ WARNUNG: Möchten Sie die Variante "${variant.name}" wirklich löschen?\n\n` +
                `Alle zugehörigen Daten (Termine, Kunden, Mitarbeiter, Touren) werden ebenfalls gelöscht!\n\n` +
                `Diese Aktion kann nicht rückgängig gemacht werden!`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await apiCall(`/api/variants/${variantId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Fehler beim Löschen');
                }
                
                // Entferne Variante aus Liste
                variants = variants.filter(v => v.id !== variantId);
                
                // Wenn die gelöschte Variante die aktuelle war, wechsle zur ersten verfügbaren
                if (currentVariantId === variantId) {
                    if (variants.length > 0) {
                        currentVariantId = variants[0].id;
                        await switchVariant(currentVariantId);
                    } else {
                        currentVariantId = null;
                        appData = {
                            events: [],
                            pool: [],
                            employees: [],
                            tours: [{id:'t1', name:'Tour 1'}, {id:'t2', name:'Tour 2'}],
                            wageSettings: JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS)),
                            favorites: []
                        };
                        refreshUI();
                    }
                }
                
                // Aktualisiere UI
                updateVariantSelect();
                
                showToast(`Variante "${variant.name}" wurde gelöscht`, 'success');
            } catch (error) {
                console.error('Fehler beim Löschen der Variante:', error);
                showToast('Fehler beim Löschen: ' + error.message, 'error');
            }
        }
        
        function addTour(){
            const n=document.getElementById('newTourName');
            const h=document.getElementById('newTourHoursLimit');
            if(!n) return;
            const name = n.value.trim();
            const hoursLimit = h ? parseInt(h.value) || null : null;
            
            // Sammle bevorzugte Types
            const preferredTypes = [];
            document.querySelectorAll('.new-tour-type-cb:checked').forEach(cb => {
                preferredTypes.push(cb.value);
            });
            
            if(name) {
                if(!appData.tours) appData.tours = [];
                appData.tours.push({
                    id:'t'+generateId(), 
                    name:name, 
                    weeklyHoursLimit: hoursLimit,
                    preferredTypes: preferredTypes.length > 0 ? preferredTypes : null
                });
                queueSave();
                refreshUI();
                n.value='';
                if(h) h.value='';
                document.querySelectorAll('.new-tour-type-cb').forEach(cb => cb.checked = false);
            }
        }
        
        function editTour(tourId) {
            const tour = appData.tours.find(t => t.id === tourId);
            if(!tour) return;
            
            // Öffne Modal oder bearbeite direkt in der Liste
            showInputModal('Tour bearbeiten', 'Tour-Name:', tour.name, (newName) => {
                if(!newName || !newName.trim()) return;
                const tourName = newName.trim();
                
                showInputModal('Wochenstunden-Limit', 'Wochenstunden-Limit (leer für kein Limit):', tour.weeklyHoursLimit || '', (newHoursLimit) => {
                    const hoursLimit = newHoursLimit === null || newHoursLimit === '' ? null : parseInt(newHoursLimit);
                    
                    // Bevorzugte Types bearbeiten
                    const currentTypes = tour.preferredTypes || [];
                    showInputModal('Leistungstypen', 'Bevorzugte Leistungstypen (Komma-getrennt: care, house, social) oder leer für alle:', currentTypes.join(', '), (typeStr) => {
                        let preferredTypes = null;
                        if(typeStr && typeStr.trim()) {
                            preferredTypes = typeStr.split(',').map(t => t.trim()).filter(t => ['care', 'house', 'social'].includes(t));
                            if(preferredTypes.length === 0) preferredTypes = null;
                        }
                        
                        tour.name = tourName;
                        tour.weeklyHoursLimit = hoursLimit;
                        tour.preferredTypes = preferredTypes;
                        
                        tour.name = tourName;
                        tour.weeklyHoursLimit = hoursLimit;
                        tour.preferredTypes = preferredTypes;
                        
                        queueSave();
                        renderAdminTabContent('tours');
                        showToast('Tour aktualisiert', 'success');
                    });
                });
            });
        }
        
        // Temp-Koordinaten für neues Teammitglied (Admin-Ansicht)
        let tempNewEmployeeCoordinates = null;

        function addEmployee(){
            const n = document.getElementById('newEmpName');
            const h = document.getElementById('newEmpHours');
            const wg = document.getElementById('newEmpWageGroup');
            const t = document.getElementById('newEmpTransport');
            const hz = document.getElementById('newEmpHomeZone');
            const addr = document.getElementById('newEmpAddress');
            const pc = document.getElementById('newEmpPostalCode');
            if(!n) return;
            const name = n.value.trim();
            const hours = h ? (parseInt(h.value) || 40) : 40;
            const wageGroup = wg ? wg.value : 'hilfskraft';
            const transport = t ? t.value : 'car';
            const homeZone = hz ? hz.value : '';
            const address = addr ? addr.value.trim() : '';
            const postalCode = pc ? pc.value.trim() : '';
            
            const coordinates = tempNewEmployeeCoordinates;
            
            if(name) {
                if(!appData.employees) appData.employees = [];
                const extendedProps = {};
                if (coordinates) {
                    extendedProps.coordinates = coordinates;
                }
                appData.employees.push({
                    id: generateId(), 
                    name: name, 
                    weeklyHours: hours,
                    wageGroup: wageGroup,
                    transport: transport,
                    homeZone: homeZone,
                    address: address || null,
                    postalCode: postalCode || null,
                    extendedProps: extendedProps
                });
                queueSave();
                refreshUI();
                updateCapacityDisplay();
                // Aktualisiere die Mitarbeiterliste im Team-Tab, falls dieser aktiv ist
                if (typeof renderEmployeeList === 'function') {
                    renderEmployeeList();
                }
                tempNewEmployeeCoordinates = null;
                n.value = '';
                if(h) h.value = '40';
                if(addr) addr.value = '';
                if(pc) pc.value = '';
                const coordsDisplay = document.getElementById('employeeCoordinatesDisplay');
                if(coordsDisplay) coordsDisplay.style.display = 'none';
            }
        }
        
        async function geocodeEmployeeAddress() {
            const addressInput = document.getElementById('newEmpAddress');
            const postalCodeInput = document.getElementById('newEmpPostalCode');
            const btn = document.getElementById('geocodeEmpBtn');
            const display = document.getElementById('employeeCoordinatesDisplay');
            const text = document.getElementById('employeeCoordinatesText');
            
            if (!addressInput && !postalCodeInput) {
                showToast('Bitte Adresse oder Postleitzahl eingeben', 'warning');
                return;
            }
            
            const address = addressInput ? addressInput.value.trim() : '';
            const postalCode = postalCodeInput ? postalCodeInput.value.trim() : '';
            
            if (!address && !postalCode) {
                showToast('Bitte Adresse oder Postleitzahl eingeben', 'warning');
                return;
            }
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = '⏳ Ermittle...';
            }
            
            try {
                const response = await fetch('/api/geocoding/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        address: address, 
                        postalCode: postalCode, 
                        city: 'Gelsenkirchen' 
                    })
                });
                
                // Prüfe ob es ein Timeout war
                if (response.status === 504) {
                    throw new Error('Geocoding-Service antwortet nicht rechtzeitig. Bitte versuchen Sie es später erneut.');
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const coordinates = {
                        lat: data.latitude,
                        lng: data.longitude
                    };
                    
                    // Speichere temporär in-memory (für addEmployee)
                    tempNewEmployeeCoordinates = coordinates;
                    
                    // Zeige Koordinaten
                    if (display) display.style.display = 'block';
                    if (text) {
                        text.textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
                    }
                    
                    showToast('Koordinaten erfolgreich ermittelt', 'success');
                } else {
                    showToast('Koordinaten konnten nicht ermittelt werden: ' + (data.error || 'Unbekannter Fehler'), 'error');
                }
            } catch (error) {
                console.error('Geocoding-Fehler:', error);
                // Zeige spezifische Fehlermeldung für Timeouts
                if (error.message && error.message.includes('Timeout') || error.message.includes('504')) {
                    showToast('Geocoding-Service antwortet nicht rechtzeitig. Bitte versuchen Sie es später erneut.', 'error');
                } else if (error.message && error.message.includes('Unexpected token')) {
                    showToast('Geocoding-Service hat ungültige Antwort zurückgegeben. Bitte versuchen Sie es später erneut.', 'error');
                } else {
                    showToast('Fehler beim Ermitteln der Koordinaten: ' + (error.message || 'Unbekannter Fehler'), 'error');
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '🔍 Koordinaten ermitteln';
                }
            }
        }

        function openManualEmployeeCoordinatesModal(source) {
            const coordsModal = document.getElementById('manualEmployeeCoordinatesModal');
            if (coordsModal) {
                coordsModal.dataset.source = 'admin';
                // Erhöhe z-index, damit Modal über anderen Modals erscheint
                coordsModal.style.zIndex = '2000';
            }
            if (tempNewEmployeeCoordinates) {
                const latInput = document.getElementById('manualEmpLat');
                const lngInput = document.getElementById('manualEmpLng');
                if (latInput) latInput.value = tempNewEmployeeCoordinates.lat ?? '';
                if (lngInput) lngInput.value = tempNewEmployeeCoordinates.lng ?? '';
            }
            openModal('manualEmployeeCoordinatesModal');
        }
        
        function saveManualEmployeeCoordinates() {
            const latInput = document.getElementById('manualEmpLat');
            const lngInput = document.getElementById('manualEmpLng');
            const coordsModal = document.getElementById('manualEmployeeCoordinatesModal');
            const editingEmployeeId = coordsModal?.dataset.editingEmployeeId;
            
            if (!latInput || !lngInput) return;
            
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showToast('Ungültige Koordinaten', 'error');
                return;
            }
            
            const coordinates = { lat, lng };
            
            if (editingEmployeeId) {
                // Bearbeitungsmodus: Speichere direkt im Employee
                const emp = appData.employees.find(e => e.id === editingEmployeeId);
                if (emp) {
                    emp.extendedProps = emp.extendedProps || {};
                    emp.extendedProps.coordinates = coordinates;
                    queueSave();
                    if (typeof renderEmployeeList === 'function') {
                        renderEmployeeList();
                    }
                    closeModal('manualEmployeeCoordinatesModal');
                    const inputModal = document.querySelector('.input-modal');
                    if (inputModal) {
                        // Aktualisiere Anzeige im Edit-Modal
                        const display = document.getElementById('editEmployeeCoordinatesDisplay');
                        const text = document.getElementById('editEmployeeCoordinatesText');
                        if (display) display.style.display = 'block';
                        if (text) {
                            text.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        }
                        // Speichere auch temporär für den Save-Button
                        inputModal.dataset.tempCoordinates = JSON.stringify(coordinates);
                    }
                    showToast('Koordinaten gespeichert', 'success');
                    return;
                }
            } else {
                const source = coordsModal?.dataset?.source || 'admin';
                
                if (source === 'employeeEdit') {
                    const editModal = document.getElementById('employeeEditModal');
                    if (editModal) {
                        editModal.dataset.tempCoordinates = JSON.stringify(coordinates);
                    }
                    const display = document.getElementById('editEmpCoordinatesDisplay2');
                    const text = document.getElementById('editEmpCoordinatesText2');
                    if (display) display.style.display = 'block';
                    if (text) text.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                } else {
                    // Neuer Mitarbeiter (Admin): Speichere temporär in-memory
                    tempNewEmployeeCoordinates = coordinates;
                    const display = document.getElementById('employeeCoordinatesDisplay');
                    const text = document.getElementById('employeeCoordinatesText');
                    if (display) display.style.display = 'block';
                    if (text) text.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            }
            
            closeModal('manualEmployeeCoordinatesModal');
            // Reset z-index
            if (coordsModal) coordsModal.style.zIndex = '';
            showToast('Koordinaten gespeichert', 'success');
        }
        
        // Populate home zone selects
        function populateHomeZoneSelects() {
            const selects = document.querySelectorAll('#newEmpHomeZone, .emp-home-zone-select');
            selects.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = '<option value="">-- Wohnort wählen --</option>';
                CITY_ZONES.forEach(zone => {
                    const opt = document.createElement('option');
                    opt.value = zone;
                    opt.textContent = getZoneWithPostalCode(zone);
                    sel.appendChild(opt);
                });
                if(currentVal) sel.value = currentVal;
            });
        }
        
        // --- WAGE SETTINGS FUNCTIONS ---
        function openWageSettings() {
            // Öffne Admin-Ansicht mit Löhne-Tab
            currentAdminTab = 'wages';
            switchView('admin');
        }
        
        function ensureWageSettings() {
            if (!appData.wageSettings) {
                appData.wageSettings = JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS));
            }
            // Ensure all fields exist
            if (!appData.wageSettings.wageGroups) appData.wageSettings.wageGroups = DEFAULT_WAGE_SETTINGS.wageGroups;
            if (!appData.wageSettings.surcharges) appData.wageSettings.surcharges = DEFAULT_WAGE_SETTINGS.surcharges;
            if (!appData.wageSettings.revenueRates) appData.wageSettings.revenueRates = DEFAULT_WAGE_SETTINGS.revenueRates;
        }
        
        function populateWageSettingsModal() {
            const ws = appData.wageSettings;
            
            // Surcharges
            document.getElementById('surchargeSunday').value = ws.surcharges?.sunday ?? 25;
            document.getElementById('surchargeHoliday').value = ws.surcharges?.holiday ?? 100;
            document.getElementById('surchargeNight').value = ws.surcharges?.night ?? 25;
            
            // Revenue rates
            document.getElementById('revenueCare').value = ws.revenueRates?.care ?? 45;
            document.getElementById('revenueHouse').value = ws.revenueRates?.house ?? 35;
            document.getElementById('revenueSocial').value = ws.revenueRates?.social ?? 40;
            
            // Travel
            document.getElementById('avgSpeed').value = ws.avgSpeed ?? 30;
            document.getElementById('kmRate').value = ws.kmRate ?? 0.30;
            document.getElementById('publicTransportMonthly').value = ws.publicTransportMonthly ?? 30;
            
            // Calculation
            document.getElementById('employerFactor').value = ws.employerFactor ?? 1.5;
            document.getElementById('targetMargin').value = ws.targetMargin ?? 50;
            
            renderWageGroupsList();
        }
        
        function renderWageGroupsList() {
            const container = document.getElementById('wageGroupsList');
            if (!container) return;
            
            const groups = appData.wageSettings?.wageGroups || [];
            
            container.innerHTML = groups.map((g, idx) => `
                <div style="display:grid; grid-template-columns:1fr auto auto; gap:12px; align-items:center; padding:12px; background:var(--border-light); border-radius:var(--radius-md);">
                    <input type="text" value="${g.name}" placeholder="Bezeichnung" onchange="updateWageGroup(${idx}, 'name', this.value)" style="font-weight:600; padding:8px 12px; font-size:0.9rem;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <input type="number" value="${g.hourlyRate}" min="8" max="100" step="0.5" onchange="updateWageGroup(${idx}, 'hourlyRate', parseFloat(this.value))" style="width:100px; padding:8px 12px; font-size:0.9rem; text-align:right;">
                        <span style="font-size:0.9rem; color:var(--text-muted); font-weight:500; white-space:nowrap;">€/h</span>
                    </div>
                    <button class="btn btn-sm" style="padding:6px 10px; background:var(--danger); color:white; border:none; min-width:40px;" onclick="deleteWageGroup(${idx})" title="Löschen">🗑️</button>
                </div>
            `).join('');
        }
        
        function addWageGroup() {
            ensureWageSettings();
            const newId = 'gruppe_' + Date.now();
            appData.wageSettings.wageGroups.push({
                id: newId,
                name: 'Neue Lohngruppe',
                hourlyRate: 15.00
            });
            renderWageGroupsList();
            updateWageSettings();
        }
        
        function updateWageGroup(idx, field, value) {
            if (appData.wageSettings?.wageGroups?.[idx]) {
                appData.wageSettings.wageGroups[idx][field] = value;
                if (field === 'name') {
                    // Update ID based on name
                    appData.wageSettings.wageGroups[idx].id = value.toLowerCase().replace(/[^a-z0-9]/g, '_');
                }
                updateWageSettings();
            }
        }
        
        function deleteWageGroup(idx) {
            if (appData.wageSettings?.wageGroups?.length <= 1) {
                showToast('Mindestens eine Lohngruppe erforderlich', 'error');
                return;
            }
            appData.wageSettings.wageGroups.splice(idx, 1);
            renderWageGroupsList();
            updateWageSettings();
        }
        
        function updateWageSettings() {
            ensureWageSettings();
            
            appData.wageSettings.surcharges = {
                sunday: parseFloat(document.getElementById('surchargeSunday').value) || 25,
                holiday: parseFloat(document.getElementById('surchargeHoliday').value) || 100,
                night: parseFloat(document.getElementById('surchargeNight').value) || 25
            };
            
            appData.wageSettings.revenueRates = {
                care: parseFloat(document.getElementById('revenueCare').value) || 45,
                house: parseFloat(document.getElementById('revenueHouse').value) || 35,
                social: parseFloat(document.getElementById('revenueSocial').value) || 40
            };
            
            appData.wageSettings.avgSpeed = parseFloat(document.getElementById('avgSpeed').value) || 30;
            appData.wageSettings.kmRate = parseFloat(document.getElementById('kmRate').value) || 0.30;
            appData.wageSettings.publicTransportMonthly = parseFloat(document.getElementById('publicTransportMonthly').value) || 30;
            appData.wageSettings.employerFactor = parseFloat(document.getElementById('employerFactor').value) || 1.5;
            appData.wageSettings.targetMargin = parseFloat(document.getElementById('targetMargin').value) || 50;
            
            queueSave();
            updateEmployeeWageGroupSelects();
        }
        
        function resetWageSettings() {
            if (!confirm('Alle Lohneinstellungen auf Standard zurücksetzen?')) return;
            appData.wageSettings = JSON.parse(JSON.stringify(DEFAULT_WAGE_SETTINGS));
            populateWageSettingsModal();
            queueSave();
            showToast('Lohneinstellungen zurückgesetzt', 'success');
        }
        
        function updateEmployeeWageGroupSelects() {
            const selects = document.querySelectorAll('#newEmpWageGroup, .emp-wage-group-select');
            const groups = appData.wageSettings?.wageGroups || DEFAULT_WAGE_SETTINGS.wageGroups;
            
            selects.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = groups.map(g => 
                    `<option value="${g.id}">${g.name} (${g.hourlyRate.toFixed(2)}€/h)</option>`
                ).join('');
                if (currentVal && groups.find(g => g.id === currentVal)) {
                    sel.value = currentVal;
                }
            });
        }
        
        function getWageGroupRate(groupId) {
            const groups = appData.wageSettings?.wageGroups || DEFAULT_WAGE_SETTINGS.wageGroups;
            const group = groups.find(g => g.id === groupId);
            return group ? group.hourlyRate : groups[1]?.hourlyRate || 14; // Default to Hilfskraft
        }
        
        function getWageGroupName(groupId) {
            const groups = appData.wageSettings?.wageGroups || DEFAULT_WAGE_SETTINGS.wageGroups;
            const group = groups.find(g => g.id === groupId);
            return group ? group.name : 'Hilfskraft';
        }
        
        // --- PROFITABILITY FUNCTIONS ---
        function openProfitability() {
            ensureWageSettings();
            renderProfitabilityDashboard();
            openModal('profitabilityModal');
        }
        
        function calculateEventCosts(evt, travelMinutes = 0) {
            if (!evt || evt.extendedProps?.isTravel) return null;
            
            const ws = appData.wageSettings || DEFAULT_WAGE_SETTINGS;
            const type = evt.extendedProps?.type || 'other';
            const dayIndex = evt.dayIndex || 0;
            const startMin = parseTimeToMinutes(evt.start);
            const endMin = parseTimeToMinutes(evt.end);
            const durationMin = endMin - startMin;
            const durationHours = durationMin / 60;
            const travelHours = travelMinutes / 60;
            
            // Determine employee wage group based on tour assignment
            let wageRate = ws.wageGroups?.[1]?.hourlyRate || 14; // Default Hilfskraft
            let transportType = 'car'; // Default PKW
            const tourId = evt.extendedProps?.tour;
            if (tourId) {
                const tour = appData.tours?.find(t => t.id === tourId);
                if (tour?.employeeId) {
                    const emp = appData.employees?.find(e => e.id === tour.employeeId);
                    if (emp) {
                        wageRate = getWageGroupRate(emp.wageGroup);
                        transportType = emp.transport || 'car';
                    }
                }
            }
            
            // Calculate surcharges
            let surchargePercent = 0;
            const isSunday = dayIndex === 6; // Sonntag
            const isNight = startMin < 360 || endMin > 1200; // vor 6:00 oder nach 20:00
            
            if (isSunday) surchargePercent += ws.surcharges?.sunday || 0;
            if (isNight) surchargePercent += ws.surcharges?.night || 0;
            // Feiertage müssten manuell markiert werden - hier nicht implementiert
            
            // Work costs
            const baseLohnWork = durationHours * wageRate;
            const surchargeLohnWork = baseLohnWork * (surchargePercent / 100);
            const totalLohnWork = baseLohnWork + surchargeLohnWork;
            
            // Travel costs (same wage, no surcharge typically)
            const baseLohnTravel = travelHours * wageRate;
            
            // Employer factor
            const employerFactor = ws.employerFactor || 1.5;
            const agKostenWork = totalLohnWork * employerFactor;
            const agKostenTravel = baseLohnTravel * employerFactor;
            
            // Revenue
            const revenueRate = ws.revenueRates?.[type] || ws.revenueRates?.care || 45;
            const revenue = durationHours * revenueRate;
            
            // Travel distance & vehicle costs
            const avgSpeed = ws.avgSpeed || 30;
            const km = (travelMinutes / 60) * avgSpeed;
            const kmRate = ws.kmRate || 0.30;
            // Only calculate km costs for PKW users
            const vehicleCosts = transportType === 'car' ? (km * kmRate) : 0;
            
            return {
                durationHours,
                travelHours,
                baseLohnWork,
                surchargeLohnWork,
                totalLohnWork,
                baseLohnTravel,
                agKostenWork,
                agKostenTravel,
                totalAgKosten: agKostenWork + agKostenTravel,
                revenue,
                km,
                vehicleCosts,
                surchargePercent,
                profit: revenue - agKostenWork - agKostenTravel - vehicleCosts,
                type,
                dayIndex
            };
        }
        
        function calculateEmployeeHours(employeeId) {
            if (!employeeId || !appData.employees || !appData.tours || !appData.events) {
                return { currentHours: 0, targetHours: 0, difference: 0, percentage: 0 };
            }
            
            const employee = appData.employees.find(e => e.id === employeeId);
            if (!employee) {
                return { currentHours: 0, targetHours: 0, difference: 0, percentage: 0 };
            }
            
            // Finde alle Touren dieses Mitarbeiters
            const employeeTours = appData.tours.filter(t => t.employeeId === employeeId);
            
            // Sammle alle Events aus diesen Touren über alle Tage
            let totalMinutes = 0;
            employeeTours.forEach(tour => {
                const tourEvents = filterRealEvents(appData.events.filter(e => 
                    e.extendedProps?.tour === tour.id
                ));
                
                tourEvents.forEach(event => {
                    totalMinutes += getEventDuration(event);
                });
            });
            
            const currentHours = totalMinutes / 60;
            const targetHours = employee.weeklyHours || 40;
            const difference = currentHours - targetHours;
            const percentage = targetHours > 0 ? (currentHours / targetHours) * 100 : 0;
            
            return { currentHours, targetHours, difference, percentage };
        }
        
        function renderEmployeeHoursDashboard() {
            const container = document.getElementById('adminContent');
            if (!container) return;
            
            if (!appData.employees || appData.employees.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:20px;">Keine Mitarbeiter vorhanden</p>';
                return;
            }
            
            const employees = [...appData.employees];
            
            // Berechne Stunden für jeden Mitarbeiter
            const employeeStats = employees.map(emp => {
                const hours = calculateEmployeeHours(emp.id);
                return {
                    ...emp,
                    ...hours
                };
            });
            
            // Sortiere nach Differenz (größte Abweichung zuerst)
            employeeStats.sort((a, b) => Math.abs(b.difference) - Math.abs(a.difference));
            
            let html = `
                <div style="margin-bottom:20px;">
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="text" id="employeeHoursSearch" placeholder="🔍 Mitarbeiter suchen..." 
                               style="flex:1; padding:8px; border:1px solid var(--border); border-radius:var(--radius-sm);" 
                               oninput="filterEmployeeHours()">
                        <select id="employeeHoursSort" onchange="renderEmployeeHoursDashboard()" 
                                style="width:150px; padding:8px; border:1px solid var(--border); border-radius:var(--radius-sm);">
                            <option value="difference">Nach Abweichung</option>
                            <option value="name">Nach Name</option>
                            <option value="percentage">Nach Auslastung</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-card); border-bottom:2px solid var(--border);">
                                <th style="padding:12px; text-align:left; font-weight:600;">Mitarbeiter</th>
                                <th style="padding:12px; text-align:right; font-weight:600;">Aktuell</th>
                                <th style="padding:12px; text-align:right; font-weight:600;">Soll</th>
                                <th style="padding:12px; text-align:right; font-weight:600;">Differenz</th>
                                <th style="padding:12px; text-align:right; font-weight:600;">Auslastung</th>
                                <th style="padding:12px; text-align:center; font-weight:600;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="employeeHoursTableBody">
            `;
            
            employeeStats.forEach(stat => {
                const statusColor = stat.percentage >= 80 && stat.percentage <= 100 ? 'var(--success)' :
                                   (stat.percentage >= 60 && stat.percentage < 80) || (stat.percentage > 100 && stat.percentage <= 120) ? 'var(--warning)' :
                                   'var(--danger)';
                
                const statusText = stat.percentage >= 80 && stat.percentage <= 100 ? '✓ Optimal' :
                                  stat.percentage < 60 ? '⚠ Zu wenig' :
                                  stat.percentage > 120 ? '⚠ Zu viel' :
                                  '⚠ Anpassung nötig';
                
                const diffColor = stat.difference === 0 ? 'var(--text-muted)' :
                                 stat.difference > 0 ? 'var(--danger)' : 'var(--warning)';
                
                html += `
                    <tr style="border-bottom:1px solid var(--border);" class="employee-hours-row" data-name="${stat.name.toLowerCase()}">
                        <td style="padding:12px; font-weight:500;">${stat.name}</td>
                        <td style="padding:12px; text-align:right;">${stat.currentHours.toFixed(1)}h</td>
                        <td style="padding:12px; text-align:right;">${stat.targetHours}h</td>
                        <td style="padding:12px; text-align:right; color:${diffColor}; font-weight:600;">
                            ${stat.difference > 0 ? '+' : ''}${stat.difference.toFixed(1)}h
                        </td>
                        <td style="padding:12px; text-align:right;">
                            <div style="display:inline-block; width:60px; height:8px; background:var(--border-light); border-radius:4px; position:relative;">
                                <div style="position:absolute; left:0; top:0; height:100%; width:${Math.min(stat.percentage, 150)}%; background:${statusColor}; border-radius:4px;"></div>
                            </div>
                            <span style="margin-left:8px; font-weight:600; color:${statusColor};">${stat.percentage.toFixed(0)}%</span>
                        </td>
                        <td style="padding:12px; text-align:center; color:${statusColor}; font-weight:600; font-size:0.85rem;">
                            ${statusText}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function filterEmployeeHours() {
            const searchTerm = document.getElementById('employeeHoursSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('.employee-hours-row');
            
            rows.forEach(row => {
                const name = row.dataset.name || '';
                if (name.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function renderProfitabilityDashboard() {
            const container = document.getElementById('profitabilityContent');
            if (!container) return;
            
            const ws = appData.wageSettings || DEFAULT_WAGE_SETTINGS;
            const events = filterRealEvents(appData.events || []);
            const travelEvents = (appData.events || []).filter(e => e && e.extendedProps?.isTravel);
            
            // Calculate totals
            let totalWorkHours = 0;
            let totalTravelHours = 0;
            let totalLohnkosten = 0;
            let totalAgKosten = 0;
            let totalRevenue = 0;
            let totalKm = 0;
            let totalVehicleCosts = 0;
            
            const tourStats = {};
            const empStats = {};
            const dayStats = [0, 0, 0, 0, 0, 0, 0]; // Mo-So
            
            // Calculate travel time per event
            const sortedByDay = {};
            events.forEach(evt => {
                const day = evt.dayIndex || 0;
                if (!sortedByDay[day]) sortedByDay[day] = [];
                sortedByDay[day].push(evt);
            });
            
            // Sort each day by start time and calculate gaps
            Object.keys(sortedByDay).forEach(day => {
                sortedByDay[day].sort((a, b) => parseTimeToMinutes(a.start) - parseTimeToMinutes(b.start));
            });
            
            events.forEach((evt, idx) => {
                // Find associated travel time
                let travelMin = 0;
                const day = evt.dayIndex || 0;
                const dayEvents = sortedByDay[day] || [];
                const evtIdx = dayEvents.findIndex(e => e.id === evt.id);
                
                if (evtIdx > 0) {
                    const prevEvt = dayEvents[evtIdx - 1];
                    const prevEnd = parseTimeToMinutes(prevEvt.end);
                    const thisStart = parseTimeToMinutes(evt.start);
                    const gap = thisStart - prevEnd;
                    if (gap > 0 && gap <= 120) {
                        travelMin = gap;
                    }
                }
                
                const costs = calculateEventCosts(evt, travelMin);
                if (!costs) return;
                
                totalWorkHours += costs.durationHours;
                totalTravelHours += costs.travelHours;
                totalLohnkosten += costs.totalLohnWork + costs.baseLohnTravel;
                totalAgKosten += costs.totalAgKosten;
                totalRevenue += costs.revenue;
                totalKm += costs.km;
                totalVehicleCosts += costs.vehicleCosts;
                dayStats[day] += costs.totalAgKosten;
                
                // Tour stats
                const tourId = evt.extendedProps?.tour || 'keine';
                if (!tourStats[tourId]) {
                    tourStats[tourId] = { workHours: 0, travelHours: 0, costs: 0, revenue: 0, km: 0, events: 0 };
                }
                tourStats[tourId].workHours += costs.durationHours;
                tourStats[tourId].travelHours += costs.travelHours;
                tourStats[tourId].costs += costs.totalAgKosten + costs.vehicleCosts;
                tourStats[tourId].revenue += costs.revenue;
                tourStats[tourId].km += costs.km;
                tourStats[tourId].events++;
            });
            
            // Add public transport monthly costs for employees using Öffis
            let publicTransportCosts = 0;
            const publicTransportUsers = (appData.employees || []).filter(e => e.transport === 'public');
            publicTransportCosts = publicTransportUsers.length * (ws.publicTransportMonthly || 30);
            
            const totalCosts = totalAgKosten + totalVehicleCosts + publicTransportCosts;
            const profit = totalRevenue - totalCosts;
            const margin = totalRevenue > 0 ? ((profit / totalRevenue) * 100) : 0;
            const targetMargin = ws.targetMargin || 50;
            const targetRevenue = totalCosts * (100 / (100 - targetMargin));
            const revenueGap = targetRevenue - totalRevenue;
            
            // Color based on margin
            let marginColor = '#ef4444'; // red
            if (margin >= targetMargin) marginColor = '#10b981'; // green
            else if (margin >= targetMargin * 0.7) marginColor = '#f59e0b'; // orange
            
            // Build HTML
            let html = `
                <!-- Overview Cards -->
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:24px;">
                    <div style="background:var(--border-light); padding:16px; border-radius:var(--radius-lg); text-align:center;">
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Arbeitszeit</div>
                        <div style="font-size:1.5rem; font-weight:700; color:var(--primary);">${totalWorkHours.toFixed(1)}h</div>
                    </div>
                    <div style="background:var(--border-light); padding:16px; border-radius:var(--radius-lg); text-align:center;">
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Fahrzeit</div>
                        <div style="font-size:1.5rem; font-weight:700; color:var(--c-social);">${totalTravelHours.toFixed(1)}h</div>
                        <div style="font-size:0.7rem; color:var(--text-light);">≈ ${totalKm.toFixed(0)} km</div>
                    </div>
                    <div style="background:var(--border-light); padding:16px; border-radius:var(--radius-lg); text-align:center;">
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Gesamtkosten</div>
                        <div style="font-size:1.5rem; font-weight:700; color:var(--danger);">${totalCosts.toFixed(2)}€</div>
                        <div style="font-size:0.7rem; color:var(--text-light);">inkl. ${(ws.employerFactor - 1) * 100}% AG-Anteil</div>
                    </div>
                    <div style="background:var(--border-light); padding:16px; border-radius:var(--radius-lg); text-align:center;">
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">Erlöse</div>
                        <div style="font-size:1.5rem; font-weight:700; color:var(--success);">${totalRevenue.toFixed(2)}€</div>
                    </div>
                </div>
                
                <!-- Profit & Margin -->
                <div style="background:linear-gradient(135deg, var(--bg-card) 0%, var(--border-light) 100%); padding:20px; border-radius:var(--radius-lg); margin-bottom:24px; border:2px solid ${marginColor};">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; text-align:center;">
                        <div>
                            <div style="font-size:0.85rem; color:var(--text-muted);">💵 Gewinn/Verlust</div>
                            <div style="font-size:2rem; font-weight:800; color:${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${profit >= 0 ? '+' : ''}${profit.toFixed(2)}€</div>
                        </div>
                        <div>
                            <div style="font-size:0.85rem; color:var(--text-muted);">📊 Aktuelle Marge</div>
                            <div style="font-size:2rem; font-weight:800; color:${marginColor};">${margin.toFixed(1)}%</div>
                            <div style="font-size:0.75rem; color:var(--text-light);">Ziel: ${targetMargin}%</div>
                        </div>
                        <div>
                            <div style="font-size:0.85rem; color:var(--text-muted);">🎯 Fehlender Umsatz</div>
                            <div style="font-size:2rem; font-weight:800; color:${revenueGap > 0 ? 'var(--warning)' : 'var(--success)'};">${revenueGap > 0 ? revenueGap.toFixed(2) + '€' : '✓'}</div>
                            <div style="font-size:0.75rem; color:var(--text-light);">für ${targetMargin}% Marge</div>
                        </div>
                    </div>
                    <div style="margin-top:16px;">
                        <div style="height:8px; background:var(--border); border-radius:4px; overflow:hidden;">
                            <div style="height:100%; width:${Math.min(margin / targetMargin * 100, 150)}%; background:${marginColor}; transition:width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Breakdown -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
                    <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 12px 0; font-size:0.95rem;">💰 Kostenaufschlüsselung</h4>
                        <table style="width:100%; font-size:0.85rem;">
                            <tr><td style="padding:4px 0; color:var(--text-muted);">Lohnkosten (netto)</td><td style="text-align:right; font-weight:600;">${totalLohnkosten.toFixed(2)}€</td></tr>
                            <tr><td style="padding:4px 0; color:var(--text-muted);">+ AG-Anteil (${((ws.employerFactor - 1) * 100).toFixed(0)}%)</td><td style="text-align:right; font-weight:600;">${(totalAgKosten - totalLohnkosten).toFixed(2)}€</td></tr>
                            <tr><td style="padding:4px 0; color:var(--text-muted);">= Personalkosten gesamt</td><td style="text-align:right; font-weight:700; color:var(--primary);">${totalAgKosten.toFixed(2)}€</td></tr>
                            <tr><td style="padding:4px 0; color:var(--text-muted);">+ PKW-Kosten (${totalKm.toFixed(0)} km × ${ws.kmRate.toFixed(2)}€)</td><td style="text-align:right; font-weight:600;">${totalVehicleCosts.toFixed(2)}€</td></tr>
                            <tr><td style="padding:4px 0; color:var(--text-muted);">+ Öffis-Pauschale (${publicTransportUsers.length} MA × ${ws.publicTransportMonthly.toFixed(0)}€)</td><td style="text-align:right; font-weight:600;">${publicTransportCosts.toFixed(2)}€</td></tr>
                            <tr style="border-top:2px solid var(--border);"><td style="padding:8px 0; font-weight:700;">Gesamtkosten</td><td style="text-align:right; font-weight:800; color:var(--danger);">${totalCosts.toFixed(2)}€</td></tr>
                        </table>
                    </div>
                    
                    <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                        <h4 style="margin:0 0 12px 0; font-size:0.95rem;">📈 Produktivität</h4>
                        <div style="margin-bottom:12px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px;">
                                <span>Arbeitszeit vs. Fahrzeit</span>
                                <span style="font-weight:600;">${((totalWorkHours / (totalWorkHours + totalTravelHours)) * 100).toFixed(1)}% produktiv</span>
                            </div>
                            <div style="height:12px; background:var(--border); border-radius:6px; overflow:hidden; display:flex;">
                                <div style="width:${(totalWorkHours / (totalWorkHours + totalTravelHours)) * 100}%; background:var(--success);"></div>
                                <div style="width:${(totalTravelHours / (totalWorkHours + totalTravelHours)) * 100}%; background:var(--warning);"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-light); margin-top:4px;">
                                <span>🟢 Arbeit: ${totalWorkHours.toFixed(1)}h</span>
                                <span>🟡 Fahrt: ${totalTravelHours.toFixed(1)}h</span>
                            </div>
                        </div>
                        <div style="padding-top:12px; border-top:1px solid var(--border);">
                            <div style="font-size:0.85rem; color:var(--text-muted);">Ø Kosten pro Arbeitsstunde</div>
                            <div style="font-size:1.2rem; font-weight:700; color:var(--primary);">${totalWorkHours > 0 ? (totalCosts / totalWorkHours).toFixed(2) : '0.00'}€/h</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tour Comparison -->
                <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius-lg); border:1px solid var(--border); margin-bottom:24px;">
                    <h4 style="margin:0 0 16px 0; font-size:0.95rem;">🚗 Vergleich nach Touren</h4>
                    <table style="width:100%; font-size:0.85rem; border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--border-light);">
                                <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Tour</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">Einsätze</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">Arbeit</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">Fahrt</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">km</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">Kosten</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">Erlöse</th>
                                <th style="padding:10px; text-align:right; border-bottom:2px solid var(--border);">Marge</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.keys(tourStats).forEach(tourId => {
                const tour = appData.tours?.find(t => t.id === tourId);
                const tourName = tour?.name || tourId;
                const ts = tourStats[tourId];
                const tourProfit = ts.revenue - ts.costs;
                const tourMargin = ts.revenue > 0 ? ((tourProfit / ts.revenue) * 100) : 0;
                const marginClr = tourMargin >= targetMargin ? 'var(--success)' : (tourMargin >= 0 ? 'var(--warning)' : 'var(--danger)');
                const productivity = ts.workHours / (ts.workHours + ts.travelHours) * 100;
                
                html += `
                    <tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:10px; font-weight:600;">${tourName}</td>
                        <td style="padding:10px; text-align:right;">${ts.events}</td>
                        <td style="padding:10px; text-align:right;">${ts.workHours.toFixed(1)}h</td>
                        <td style="padding:10px; text-align:right; color:var(--warning);">${ts.travelHours.toFixed(1)}h</td>
                        <td style="padding:10px; text-align:right;">${ts.km.toFixed(0)}</td>
                        <td style="padding:10px; text-align:right; color:var(--danger);">${ts.costs.toFixed(2)}€</td>
                        <td style="padding:10px; text-align:right; color:var(--success);">${ts.revenue.toFixed(2)}€</td>
                        <td style="padding:10px; text-align:right; font-weight:700; color:${marginClr};">${tourMargin.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <!-- Day Distribution -->
                <div style="background:var(--bg-card); padding:16px; border-radius:var(--radius-lg); border:1px solid var(--border);">
                    <h4 style="margin:0 0 16px 0; font-size:0.95rem;">📅 Kosten pro Wochentag</h4>
                    <div style="display:flex; gap:8px; height:140px; align-items:flex-end;">
            `;
            
            const maxDayCost = Math.max(...dayStats, 1);
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            // Calculate color based on relative cost (green=low, yellow=medium, red=high)
            const getCostColor = (cost, max) => {
                if (cost === 0) return '#94a3b8'; // gray for no costs
                const ratio = cost / max;
                if (ratio < 0.33) return '#10b981'; // green - low
                if (ratio < 0.66) return '#f59e0b'; // orange - medium
                return '#ef4444'; // red - high
            };
            
            dayStats.forEach((cost, idx) => {
                const height = cost > 0 ? Math.max((cost / maxDayCost) * 100, 8) : 8;
                const barColor = getCostColor(cost, maxDayCost);
                const isSunday = idx === 6;
                const textColor = cost === 0 ? 'var(--text-light)' : barColor;
                
                html += `
                    <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                        <div style="font-size:0.7rem; font-weight:700; color:${textColor}; margin-bottom:4px;">${cost.toFixed(0)}€</div>
                        <div style="width:100%; height:${height}%; background:linear-gradient(180deg, ${barColor} 0%, ${barColor}cc 100%); border-radius:6px 6px 0 0; min-height:8px; box-shadow:0 -2px 8px ${barColor}40; transition:all 0.3s;"></div>
                        <div style="font-size:0.75rem; font-weight:600; color:${isSunday ? 'var(--warning)' : 'var(--text-secondary)'}; margin-top:6px; padding:2px 6px; background:${isSunday ? 'rgba(245, 158, 11, 0.15)' : 'var(--border-light)'}; border-radius:4px;">${dayNames[idx]}</div>
                    </div>
                `;
            });
            
            // Add legend
            html += `
                    </div>
                    <div style="display:flex; justify-content:center; gap:16px; margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                        <div style="display:flex; align-items:center; gap:4px;">
                            <div style="width:12px; height:12px; border-radius:2px; background:#10b981;"></div>
                            <span style="font-size:0.7rem; color:var(--text-muted);">Niedrig</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:4px;">
                            <div style="width:12px; height:12px; border-radius:2px; background:#f59e0b;"></div>
                            <span style="font-size:0.7rem; color:var(--text-muted);">Mittel</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:4px;">
                            <div style="width:12px; height:12px; border-radius:2px; background:#ef4444;"></div>
                            <span style="font-size:0.7rem; color:var(--text-muted);">Hoch</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Speichere die Event-Listener für jedes Modal
        const modalHandlers = {};
        
        // Hilfsfunktion zum Öffnen des Optimierungs-Modals
        function updateOptimizeScope() {
            const scope = document.getElementById('optimizeScopeSelect').value;
            const dayContainer = document.getElementById('optimizeDayContainer');
            const tourContainer = document.getElementById('optimizeTourContainer');
            
            if (scope === 'tour') {
                dayContainer.style.display = 'none';
                tourContainer.style.display = 'block';
                // Fülle Tour-Auswahl
                const tourSelect = document.getElementById('optimizeTourSelect');
                tourSelect.innerHTML = '';
                if (appData.tours && appData.tours.length > 0) {
                    appData.tours.forEach(tour => {
                        const option = document.createElement('option');
                        option.value = tour.id;
                        option.textContent = tour.name;
                        tourSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Keine Touren verfügbar';
                    tourSelect.appendChild(option);
                }
            } else {
                dayContainer.style.display = 'block';
                tourContainer.style.display = 'none';
            }
        }
        
        let optimizationPotentialCheckInterval = null;
        
        async function checkOptimizationPotential() {
            if (!currentVariantId) return;
            
            try {
                const response = await apiCall(`/api/optimize/potential?variant_id=${currentVariantId}`);
                const result = await response.json();
                
                if (result.success && result.potential) {
                    const badge = document.getElementById('optimizationBadge');
                    if (badge) {
                        if (result.potential.hasPotential) {
                            badge.style.display = 'inline-block';
                            const issueCount = result.potential.issues.length;
                            badge.textContent = issueCount > 0 ? `${issueCount}` : '!';
                            badge.title = result.potential.summary;
                            
                            // Farbe basierend auf Anzahl der Issues
                            if (issueCount >= 5) {
                                badge.style.background = 'rgba(239, 68, 68, 0.3)'; // Rot
                            } else if (issueCount >= 3) {
                                badge.style.background = 'rgba(245, 158, 11, 0.3)'; // Orange
                            } else {
                                badge.style.background = 'rgba(34, 197, 94, 0.3)'; // Grün
                            }
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Fehler beim Prüfen des Optimierungspotentials:', error);
            }
        }
        
        function startOptimizationPotentialMonitoring() {
            // Prüfe sofort
            checkOptimizationPotential();
            
            // Prüfe alle 30 Sekunden
            if (optimizationPotentialCheckInterval) {
                clearInterval(optimizationPotentialCheckInterval);
            }
            optimizationPotentialCheckInterval = setInterval(checkOptimizationPotential, 30000);
        }
        
        function stopOptimizationPotentialMonitoring() {
            if (optimizationPotentialCheckInterval) {
                clearInterval(optimizationPotentialCheckInterval);
                optimizationPotentialCheckInterval = null;
            }
        }
        
        function openOptimizationModal() {
            openModal('optimizationModal');
            // Initialisiere Scope-Auswahl
            updateOptimizeScope();
            // Prüfe Potential erneut
            checkOptimizationPotential();
        }
        
        function openModal(id){
            const modal = document.getElementById(id);
            if(modal) {
                modal.style.display='flex';
                
                // Entferne alte Event-Listener, falls vorhanden
                if(modalHandlers[id]) {
                    document.removeEventListener('keydown', modalHandlers[id].escHandler);
                }
                
                // Event-Listener für ESC-Taste hinzufügen
                const escHandler = function(e) {
                    if(e.key === 'Escape') {
                        closeModal(id);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                // Speichere den Handler (kein clickHandler mehr - Modals schließen nur über ESC oder X)
                modalHandlers[id] = { escHandler };
            }
        }
        
        function closeModal(id){
            const modal = document.getElementById(id);
            if(modal) {
                modal.style.display='none';
                
                // Entferne die Event-Listener
                if(modalHandlers[id]) {
                    document.removeEventListener('keydown', modalHandlers[id].escHandler);
                    delete modalHandlers[id];
                }
            }
        }

        // ===== INPUT MODAL (Ersatz für prompt) =====
        let inputModalCallback = null;

        function showInputModal(title, message, defaultValue = '', callback) {
            document.getElementById('inputModalTitle').textContent = title;
            document.getElementById('inputModalMessage').textContent = message || '';
            const field = document.getElementById('inputModalField');
            field.value = defaultValue;
            inputModalCallback = callback;
            openModal('inputModal');
            setTimeout(() => field.focus(), 100);
            
            // Enter-Taste unterstützen
            field.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    confirmInputModal();
                } else if (e.key === 'Escape') {
                    closeInputModal();
                }
            };
        }

        function confirmInputModal() {
            const value = document.getElementById('inputModalField').value;
            if (inputModalCallback) {
                inputModalCallback(value);
            }
            closeInputModal();
        }

        function closeInputModal() {
            inputModalCallback = null;
            closeModal('inputModal');
        }

        // ===== CONFIRM INPUT MODAL (für Bestätigungen mit Text-Eingabe) =====
        let confirmInputModalCallback = null;
        let confirmInputModalExpectedText = '';

        function showConfirmInputModal(title, message, expectedText, inputLabel, callback) {
            document.getElementById('confirmInputModalTitle').textContent = title;
            document.getElementById('confirmInputModalMessage').textContent = message;
            document.getElementById('confirmInputModalLabel').textContent = inputLabel || 'Bestätigungstext eingeben:';
            const field = document.getElementById('confirmInputModalField');
            field.value = '';
            field.placeholder = expectedText || 'Text eingeben...';
            confirmInputModalExpectedText = expectedText || '';
            confirmInputModalCallback = callback;
            openModal('confirmInputModal');
            setTimeout(() => field.focus(), 100);
            
            // Enter-Taste unterstützen
            field.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    confirmConfirmInputModal();
                } else if (e.key === 'Escape') {
                    closeConfirmInputModal();
                }
            };
        }

        function confirmConfirmInputModal() {
            const value = document.getElementById('confirmInputModalField').value;
            const isValid = value === confirmInputModalExpectedText;
            if (confirmInputModalCallback) {
                confirmInputModalCallback(isValid, value);
            }
            closeConfirmInputModal();
        }

        function closeConfirmInputModal() {
            confirmInputModalCallback = null;
            confirmInputModalExpectedText = '';
            closeModal('confirmInputModal');
        }

        // ===== ALERT MODAL (Ersatz für alert) =====
        let alertModalAutoCloseTimer = null;

        function showAlertModal(title, message, type = 'info') {
            const iconMap = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            };
            
            const colorMap = {
                'info': 'var(--primary)',
                'success': 'var(--success)',
                'error': 'var(--danger)',
                'warning': 'var(--warning)'
            };
            
            document.getElementById('alertModalIcon').textContent = iconMap[type] || 'ℹ️';
            document.getElementById('alertModalIcon').style.color = colorMap[type] || 'var(--primary)';
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            
            openModal('alertModal');
            
            // Auto-close für success/info nach 3 Sekunden
            if (alertModalAutoCloseTimer) {
                clearTimeout(alertModalAutoCloseTimer);
            }
            if (type === 'success' || type === 'info') {
                alertModalAutoCloseTimer = setTimeout(() => {
                    closeAlertModal();
                }, 3000);
            }
        }

        function closeAlertModal() {
            if (alertModalAutoCloseTimer) {
                clearTimeout(alertModalAutoCloseTimer);
                alertModalAutoCloseTimer = null;
            }
            closeModal('alertModal');
        }

        // --- DRAG & DROP & CLICK HELPERS ---
        
        let draggedItem = null; // { type: 'pool'|'event', id: string }
        let dragTimeIndicator = null; // Element for showing time during drag

        function clearEventSelection() {
            selectedEvents.clear();
            document.querySelectorAll('.week-event-row.selected').forEach(el => {
                el.classList.remove('selected');
            });
        }

        function handleDragStart(e, type, id) {
            // Check if Shift key is held for copy mode
            const isCopyMode = e.shiftKey;
            
            // If dragging a selected event, include all selected events
            if(type === 'event' && selectedEvents.size > 0) {
                if(!selectedEvents.has(id)) {
                    // Clicking an unselected event while others are selected - add this one
                    selectedEvents.add(id);
                }
                draggedItem = { type, id, multiSelect: Array.from(selectedEvents), copy: isCopyMode };
            } else {
                draggedItem = { type, id, copy: isCopyMode };
            }
            
            e.dataTransfer.effectAllowed = isCopyMode ? 'copy' : 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({ type, id }));
            // Setze ein Flag, um Klicks beim Drag-Ende zu verhindern
            if(e.target) e.target.setAttribute('data-dragging', 'true');
            
            // Store the offset from the top of the dragged element to the mouse position
            const elemRect = e.target.getBoundingClientRect();
            draggedItem.offsetY = e.clientY - elemRect.top;
            
            // Visuelles Feedback
            setTimeout(() => e.target.style.opacity = isCopyMode ? '0.7' : '0.5', 0);
            
            // Create time indicator
            dragTimeIndicator = document.createElement('div');
            dragTimeIndicator.className = 'drag-time-indicator';
            dragTimeIndicator.textContent = draggedItem.multiSelect ? `${draggedItem.multiSelect.length} Einsätze` : '--:--';
            document.body.appendChild(dragTimeIndicator);
        }

        function allowDrop(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Highlight Target Day
            const card = e.target.closest('.week-day-card');
            if(card) {
                card.style.borderColor = 'var(--primary)';
                card.style.backgroundColor = 'rgba(99, 102, 241, 0.05)';
            }
            
            // Update time indicator position and value
            if(dragTimeIndicator) {
                const body = e.target.closest('.week-day-body');
                if(body) {
                    const pxPerMin = getPixelsPerMinute();
                    const snapMin = getSnapMinutes();
                    const rect = body.getBoundingClientRect();
                    // Subtract the offset to get the TOP of the card, not the mouse position
                    const dragOffset = draggedItem?.offsetY || 0;
                    const offsetY = e.clientY - rect.top - dragOffset;
                    // Convert pixels to minutes based on zoom level
                    const totalMin = Math.floor(offsetY / pxPerMin) + (TIMELINE_START_HOUR * 60);
                    const snappedMin = Math.floor(totalMin / snapMin) * snapMin;
                    const clampedMin = Math.max(TIMELINE_START_HOUR * 60, Math.min((TIMELINE_END_HOUR - 1) * 60 + 45, snappedMin));
                    
                    // Get duration from dragged event if available
                    let duration = DEFAULT_DURATION_MIN;
                    if(draggedItem?.type === 'event') {
                        const evt = appData.events.find(ev => ev.id === draggedItem.id);
                        if(evt) {
                            duration = parseTimeToMinutes(evt.end) - parseTimeToMinutes(evt.start);
                        }
                    }
                    
                    const endMin = Math.min(TIMELINE_END_HOUR * 60, clampedMin + duration);
                    dragTimeIndicator.textContent = `${minutesToTime(clampedMin)} - ${minutesToTime(endMin)}`;
                }
                
                // Position indicator above the card's top edge
                const dragOffset = draggedItem?.offsetY || 0;
                dragTimeIndicator.style.left = e.clientX + 'px';
                dragTimeIndicator.style.top = (e.clientY - dragOffset - 10) + 'px';
            }
        }
        
        function removeDropHighlight(e) {
             const card = e.target.closest('.week-day-card');
             if(card) {
                 card.style.borderColor = '';
                 card.style.backgroundColor = '';
             }
        }

        function removeDragTimeIndicator() {
            if(dragTimeIndicator) {
                dragTimeIndicator.remove();
                dragTimeIndicator = null;
            }
        }

        // Add global dragend listener to clean up indicator
        document.addEventListener('dragend', () => {
            removeDragTimeIndicator();
            const draggingEl = document.querySelector('[data-dragging="true"]');
            if(draggingEl) {
                draggingEl.style.opacity = '1';
                draggingEl.removeAttribute('data-dragging');
            }
        });

        function handleDrop(e, targetDayIndex, targetTourId = null) {
            e.preventDefault();
            removeDropHighlight(e);
            removeDragTimeIndicator();
            
            // Reset opacity
            const draggingEl = document.querySelector('[data-dragging="true"]');
            if(draggingEl) {
                draggingEl.style.opacity = '1';
                draggingEl.removeAttribute('data-dragging');
            }

            if(!draggedItem) return;

            // Calculate drop time based on Y position (offset by TIMELINE_START_HOUR)
            // Use the TOP of the card, not the mouse position
            const pxPerMin = getPixelsPerMinute();
            const snapMin = getSnapMinutes();
            const body = e.currentTarget.querySelector('.week-day-body');
            const listRect = body.getBoundingClientRect();
            const dragOffset = draggedItem?.offsetY || 0;
            const offsetY = e.clientY - listRect.top - dragOffset;
            // Convert pixels to minutes based on zoom level
            const totalMin = Math.floor(offsetY / pxPerMin) + (TIMELINE_START_HOUR * 60);
            const snappedMin = Math.floor(totalMin / snapMin) * snapMin;
            const clampedMin = Math.max(TIMELINE_START_HOUR * 60, Math.min((TIMELINE_END_HOUR - 1) * 60 + 45, snappedMin));
            const startTime = minutesToTime(clampedMin);
            
            if(draggedItem.type === 'pool') {
                const poolItem = appData.pool.find(p => p.id === draggedItem.id);
                if(poolItem) {
                     const endMin = Math.min(TIMELINE_END_HOUR * 60, clampedMin + DEFAULT_DURATION_MIN);
                     const opts = {
                        title: poolItem.title,
                        zone: poolItem.zone,
                        types: poolItem.types,
                        fromPoolId: poolItem.id,
                        start: startTime,
                        end: minutesToTime(endMin),
                        dayIndex: targetDayIndex
                    };
                    if(targetTourId) opts.tour = targetTourId;
                    openEventModal(null, opts);
                }
            } else if (draggedItem.type === 'event') {
                saveUndoState(); // Save state before moving/copying
                
                const isCopyMode = draggedItem.copy === true;
                
                // Get list of events to move/copy (either multi-select or single)
                const eventsToProcess = draggedItem.multiSelect 
                    ? draggedItem.multiSelect.map(id => appData.events.find(ev => ev.id === id)).filter(Boolean)
                    : [appData.events.find(ev => ev.id === draggedItem.id)].filter(Boolean);
                
                if(eventsToProcess.length > 0) {
                    // Calculate time offset based on the primary dragged event
                    const primaryEvt = appData.events.find(ev => ev.id === draggedItem.id);
                    const primaryOldStartMin = primaryEvt ? parseTimeToMinutes(primaryEvt.start) : clampedMin;
                    const primaryOldDayIndex = primaryEvt ? primaryEvt.dayIndex : targetDayIndex;
                    const timeOffset = clampedMin - primaryOldStartMin;
                    const dayOffset = targetDayIndex - primaryOldDayIndex;
                    
                    eventsToProcess.forEach(evt => {
                        if(!evt) return;
                        
                        const oldStartMin = parseTimeToMinutes(evt.start);
                        const oldEndMin = parseTimeToMinutes(evt.end);
                        const duration = oldEndMin - oldStartMin;
                        
                        // Apply same time offset to all events
                        const newStartMin = Math.max(TIMELINE_START_HOUR * 60, Math.min((TIMELINE_END_HOUR - 1) * 60, oldStartMin + timeOffset));
                        const newEndMin = Math.min(TIMELINE_END_HOUR * 60, newStartMin + duration);
                        
                        // Apply day offset - keep relative positions for multi-select
                        const newDayIndex = Math.max(0, Math.min(6, evt.dayIndex + dayOffset));
                        
                        if(isCopyMode) {
                            // Create a copy of the event
                            const newEvent = {
                                id: generateId(),
                                title: evt.title,
                                start: minutesToTime(newStartMin),
                                end: minutesToTime(newEndMin),
                                dayIndex: newDayIndex,
                                extendedProps: { ...evt.extendedProps }
                            };
                            if(targetTourId) {
                                newEvent.extendedProps.tour = targetTourId;
                            }
                            appData.events.push(newEvent);
                        } else {
                            // Move the existing event
                            evt.start = minutesToTime(newStartMin);
                            evt.end = minutesToTime(newEndMin);
                            evt.dayIndex = newDayIndex;
                            
                            if(targetTourId) {
                                if(!evt.extendedProps) evt.extendedProps = {};
                                evt.extendedProps.tour = targetTourId;
                            }
                        }
                    });
                    
                    // Clear selection after moving/copying
                    const processedCount = eventsToProcess.length;
                    clearEventSelection();
                    
                    queueSave();
                    refreshView();
                    
                    if(isCopyMode) {
                        showToast(processedCount > 1 ? `${processedCount} Einsätze kopiert` : 'Einsatz kopiert', 'success');
                    } else {
                        showToast(processedCount > 1 ? `${processedCount} Einsätze verschoben` : 'Einsatz verschoben', 'success');
                    }
                }
            }
            
            draggedItem = null;
        }

        function openNewEventForDay(dayIndex) {
            // dayIndex: 0=Montag, 1=Dienstag, ..., 6=Sonntag
            openEventModal(null, {
                start: '08:00',
                end: '09:00',
                dayIndex: dayIndex
            });
        }

        function openNewEventForTour(tourId) {
            openEventModal(null, {
                start: '08:00',
                end: '09:00',
                tour: tourId,
                dayIndex: 0 // Default Montag
            });
        }
        
        // Initialisiere View am Ende des Scripts (wenn DOM bereits geladen)
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(() => {
                if (typeof switchView === 'function' && typeof refreshView === 'function') {
        switchView(currentView || 'week');
                }
            }, 50);
        } else {
            // Falls DOM noch nicht geladen, warte darauf
            document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
                    if (typeof switchView === 'function' && typeof refreshView === 'function') {
                        switchView(currentView || 'week');
                    }
                }, 50);
            });
        }
    </script>
</body>
</html>